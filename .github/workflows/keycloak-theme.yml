# =============================================================================
# GitHub Actions: Keycloak Theme Build
# =============================================================================
# Build and push STOA-themed Keycloak image
# =============================================================================

name: Keycloak Theme Build

on:
  push:
    branches:
      - main
    paths:
      - 'keycloak/**'
      - '.github/workflows/keycloak-theme.yml'

  workflow_dispatch:

env:
  AWS_REGION: eu-west-1
  ECR_REGISTRY: 848853684735.dkr.ecr.eu-west-1.amazonaws.com
  ECR_REPOSITORY: apim/keycloak

jobs:
  build:
    name: Build Keycloak Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: keycloak
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:25.0-stoa
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          # Disable cache to ensure theme changes are always picked up
          no-cache: true

      - name: Check if EKS cluster exists
        id: cluster-check
        run: |
          if aws eks describe-cluster --name stoa-dev-cluster --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "CLUSTER_EXISTS=true" >> $GITHUB_OUTPUT
          else
            echo "CLUSTER_EXISTS=false" >> $GITHUB_OUTPUT
            echo "⚠️ EKS cluster 'stoa-dev-cluster' not found. Skipping deployment."
          fi

      - name: Update Keycloak deployment
        if: steps.cluster-check.outputs.CLUSTER_EXISTS == 'true'
        run: |
          aws eks update-kubeconfig --name stoa-dev-cluster --region ${{ env.AWS_REGION }}

          # Update image with SHA tag to force pull
          kubectl set image deployment/keycloak \
            keycloak=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }} \
            -n stoa-system

          # Force restart to pick up new image
          kubectl rollout restart deployment/keycloak -n stoa-system

          # Wait for rollout
          kubectl rollout status deployment/keycloak -n stoa-system --timeout=300s

      - name: Set STOA theme as default
        if: steps.cluster-check.outputs.CLUSTER_EXISTS == 'true'
        run: |
          # Get Keycloak admin password
          KC_PASSWORD=$(kubectl get secret keycloak-admin-secret -n stoa-system -o jsonpath='{.data.admin-password}' | base64 -d)

          echo "Waiting for Keycloak to be ready..."
          sleep 30

          # Get admin token
          TOKEN=$(curl -s -X POST "https://auth.gostoa.dev/realms/master/protocol/openid-connect/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "username=admin" \
            -d "password=${KC_PASSWORD}" \
            -d "grant_type=password" \
            -d "client_id=admin-cli" | jq -r '.access_token')

          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "Warning: Could not get admin token. Theme may need to be set manually."
            exit 0
          fi

          # Update realm to use STOA theme
          curl -s -X PUT "https://auth.gostoa.dev/admin/realms/stoa" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"loginTheme": "stoa"}' || echo "Warning: Could not update theme automatically"

          echo "Theme update attempted. Verify at https://auth.gostoa.dev"

      - name: Verify deployment
        if: steps.cluster-check.outputs.CLUSTER_EXISTS == 'true'
        run: |
          echo "=== Keycloak Deployment Status ==="
          kubectl get deployment keycloak -n stoa-system

          echo ""
          echo "=== Pods ==="
          kubectl get pods -n stoa-system -l app=keycloak
