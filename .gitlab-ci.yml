# stoa-gitops GitLab CI/CD Pipeline
#
# Triggers AWX reconciliation when webmethods/ configs change

stages:
  - validate
  - reconcile

variables:
  AWX_HOST: "https://awx.stoa.cab-i.com"
  AWX_JOB_TEMPLATE_ID: "42"  # TODO: Replace with actual ID

# Validate webMethods YAML files
validate-webmethods:
  stage: validate
  image: python:3.11-slim
  before_script:
    - pip install pyyaml jsonschema --quiet
  script:
    - |
      echo "Validating webMethods YAML files..."
      python -c "
      import yaml
      import sys
      from pathlib import Path

      errors = []
      for f in Path('webmethods').rglob('*.yaml'):
          try:
              with open(f) as fh:
                  yaml.safe_load(fh)
              print(f'  OK: {f}')
          except Exception as e:
              errors.append(f'{f}: {e}')
              print(f'  FAIL: {f}')

      if errors:
          print(f'\n{len(errors)} validation error(s)')
          sys.exit(1)
      print('\nAll files valid')
      "
  rules:
    - changes:
        - webmethods/**/*
      when: always
    - when: never
  tags:
    - docker

# Trigger AWX reconciliation - DEV
trigger-awx-dev:
  stage: reconcile
  image: curlimages/curl:8.5.0
  variables:
    STOA_ENV: "dev"
  script:
    - |
      echo "Triggering AWX Job Template for webMethods reconciliation..."
      echo "   Branch: ${CI_COMMIT_BRANCH}"
      echo "   Environment: ${STOA_ENV}"
      echo "   Commit: ${CI_COMMIT_SHORT_SHA}"

      RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
        "${AWX_HOST}/api/v2/job_templates/${AWX_JOB_TEMPLATE_ID}/launch/" \
        -H "Authorization: Bearer ${AWX_API_TOKEN}" \
        -H "Content-Type: application/json" \
        -d "{
          \"extra_vars\": {
            \"env\": \"${STOA_ENV}\",
            \"delete_orphans\": true,
            \"git_commit\": \"${CI_COMMIT_SHA}\",
            \"git_ref\": \"${CI_COMMIT_REF_NAME}\"
          }
        }")

      HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
      BODY=$(echo "$RESPONSE" | sed '$d')

      if [ "$HTTP_CODE" -eq 201 ]; then
        JOB_ID=$(echo "$BODY" | grep -o '"id":[0-9]*' | head -1 | cut -d: -f2)
        echo "AWX Job launched successfully!"
        echo "   Job ID: ${JOB_ID}"
        echo "   Monitor at: ${AWX_HOST}/#/jobs/playbook/${JOB_ID}"
      else
        echo "Failed to launch AWX Job"
        echo "   HTTP Code: ${HTTP_CODE}"
        echo "   Response: ${BODY}"
        exit 1
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      changes:
        - webmethods/**/*
      when: on_success
  needs:
    - validate-webmethods
  tags:
    - docker

# Trigger AWX reconciliation - STAGING
trigger-awx-staging:
  stage: reconcile
  image: curlimages/curl:8.5.0
  variables:
    STOA_ENV: "staging"
  script:
    - |
      echo "Triggering AWX Job Template for webMethods reconciliation..."
      echo "   Branch: ${CI_COMMIT_BRANCH}"
      echo "   Environment: ${STOA_ENV}"

      RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
        "${AWX_HOST}/api/v2/job_templates/${AWX_JOB_TEMPLATE_ID}/launch/" \
        -H "Authorization: Bearer ${AWX_API_TOKEN}" \
        -H "Content-Type: application/json" \
        -d "{\"extra_vars\": {\"env\": \"${STOA_ENV}\", \"delete_orphans\": true}}")

      HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
      BODY=$(echo "$RESPONSE" | sed '$d')

      if [ "$HTTP_CODE" -eq 201 ]; then
        JOB_ID=$(echo "$BODY" | grep -o '"id":[0-9]*' | head -1 | cut -d: -f2)
        echo "AWX Job launched: ${JOB_ID}"
      else
        echo "Failed: ${HTTP_CODE}"
        exit 1
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      changes:
        - webmethods/**/*
      when: on_success
  needs:
    - validate-webmethods
  tags:
    - docker

# Trigger AWX reconciliation - PROD
trigger-awx-prod:
  stage: reconcile
  image: curlimages/curl:8.5.0
  variables:
    STOA_ENV: "prod"
  script:
    - |
      echo "Triggering AWX Job Template for webMethods reconciliation..."
      echo "   Branch: ${CI_COMMIT_BRANCH}"
      echo "   Environment: ${STOA_ENV}"

      RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
        "${AWX_HOST}/api/v2/job_templates/${AWX_JOB_TEMPLATE_ID}/launch/" \
        -H "Authorization: Bearer ${AWX_API_TOKEN}" \
        -H "Content-Type: application/json" \
        -d "{\"extra_vars\": {\"env\": \"${STOA_ENV}\", \"delete_orphans\": true}}")

      HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
      BODY=$(echo "$RESPONSE" | sed '$d')

      if [ "$HTTP_CODE" -eq 201 ]; then
        JOB_ID=$(echo "$BODY" | grep -o '"id":[0-9]*' | head -1 | cut -d: -f2)
        echo "AWX Job launched: ${JOB_ID}"
      else
        echo "Failed: ${HTTP_CODE}"
        exit 1
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - webmethods/**/*
      when: on_success
  needs:
    - validate-webmethods
  tags:
    - docker
