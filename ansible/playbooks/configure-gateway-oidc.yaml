---
# Playbook: Configure OIDC Authentication in webMethods Gateway
# Configures External Authorization Server, Strategy, Application, and API association
#
# Required variables:
#   - keycloak_url: Keycloak base URL (e.g., https://auth.stoa.cab-i.com)
#   - keycloak_realm: Keycloak realm name (e.g., stoa)
#   - client_id: Keycloak client ID for the application
#   - audience: Expected audience in JWT tokens (default: account)
#   - app_name: Application name in Gateway
#   - api_id: API ID to associate with the application
#
# Optional variables:
#   - gateway_url: Gateway admin URL (default: http://apigateway.stoa-system.svc.cluster.local:5555)
#   - auth_server_name: Name for the auth server alias (default: KeycloakOIDC)
#
# Secrets loaded from ../vars/secrets.yaml (environment variables required):
#   - GATEWAY_ADMIN_USER: Gateway admin username
#   - GATEWAY_PASSWORD: Gateway admin password (mandatory)

- name: Configure OIDC Authentication in webMethods Gateway
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - ../vars/secrets.yaml

  vars:
    gateway_url: "http://apigateway.stoa-system.svc.cluster.local:5555"
    keycloak_url: "https://auth.stoa.cab-i.com"
    keycloak_realm: "stoa"
    client_id: "{{ client_id | default('control-plane-ui') }}"
    audience: "{{ audience | default('account') }}"
    app_name: "{{ app_name | default('control-plane-ui') }}"
    auth_server_name: "{{ auth_server_name | default('KeycloakOIDC') }}"
    api_id: "{{ api_id | default('') }}"

  tasks:
    - name: Display configuration info
      debug:
        msg: "Configuring OIDC for application '{{ app_name }}' with Keycloak {{ keycloak_url }}/realms/{{ keycloak_realm }}"

    # =========================================================================
    # STEP 1: Check if External Auth Server exists
    # =========================================================================
    - name: Check if External Auth Server exists
      uri:
        url: "{{ gateway_url }}/rest/apigateway/alias"
        method: GET
        user: "{{ gateway_user }}"
        password: "{{ gateway_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Accept: "application/json"
        status_code: [200]
      register: alias_list

    - name: Find existing auth server
      set_fact:
        existing_auth_server: "{{ alias_list.json.alias | selectattr('name', 'equalto', auth_server_name) | list | first | default(none) }}"
      when: alias_list.json.alias is defined

    - name: Set auth server ID if exists
      set_fact:
        auth_server_id: "{{ existing_auth_server.id }}"
      when: existing_auth_server is defined and existing_auth_server is not none

    # =========================================================================
    # STEP 2: Create External Authorization Server (Keycloak)
    # =========================================================================
    - name: Create External Authorization Server
      uri:
        url: "{{ gateway_url }}/rest/apigateway/alias"
        method: POST
        user: "{{ gateway_user }}"
        password: "{{ gateway_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Content-Type: "application/json"
          Accept: "application/json"
        body_format: json
        body:
          name: "{{ auth_server_name }}"
          description: "Keycloak OIDC Provider for STOA Platform"
          type: "authServerAlias"
          authServerType: "EXTERNAL"
          localIntrospectionConfig:
            issuer: "{{ keycloak_url }}/realms/{{ keycloak_realm }}"
            jwksuri: "{{ keycloak_url }}/realms/{{ keycloak_realm }}/protocol/openid-connect/certs"
          metadata:
            authorizeURL: "{{ keycloak_url }}/realms/{{ keycloak_realm }}/protocol/openid-connect/auth"
            accessTokenURL: "{{ keycloak_url }}/realms/{{ keycloak_realm }}/protocol/openid-connect/token"
            refreshTokenURL: "{{ keycloak_url }}/realms/{{ keycloak_realm }}/protocol/openid-connect/token"
          scopes:
            - name: "openid"
              description: "OpenID Connect scope"
            - name: "profile"
              description: "User profile information"
            - name: "email"
              description: "User email address"
            - name: "roles"
              description: "User roles"
            - name: "offline_access"
              description: "Offline access token"
          supportedGrantTypes:
            - "authorization_code"
            - "client_credentials"
            - "refresh_token"
          tokenGeneratorConfig:
            accessTokenExpInterval: 3600
            authCodeExpInterval: 600
        status_code: [200, 201]
      register: auth_server_result
      when: auth_server_id is not defined

    - name: Set auth server ID from creation
      set_fact:
        auth_server_id: "{{ auth_server_result.json.alias.id }}"
      when: auth_server_result is defined and auth_server_result.json is defined

    - name: Display auth server result
      debug:
        msg: "External Authorization Server '{{ auth_server_name }}' ID: {{ auth_server_id | default('existing') }}"

    # =========================================================================
    # STEP 3: Create OAuth2 Strategy
    # =========================================================================
    - name: Check existing strategies
      uri:
        url: "{{ gateway_url }}/rest/apigateway/strategies"
        method: GET
        user: "{{ gateway_user }}"
        password: "{{ gateway_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Accept: "application/json"
        status_code: [200]
      register: strategies_list

    - name: Find existing strategy for this app
      set_fact:
        existing_strategy: "{{ strategies_list.json.strategies | selectattr('name', 'equalto', 'OIDC-' + app_name) | list | first | default(none) }}"
      when: strategies_list.json.strategies is defined

    - name: Set strategy ID if exists
      set_fact:
        strategy_id: "{{ existing_strategy.id }}"
      when: existing_strategy is defined and existing_strategy is not none

    - name: Create OAuth2 Strategy
      uri:
        url: "{{ gateway_url }}/rest/apigateway/strategies"
        method: POST
        user: "{{ gateway_user }}"
        password: "{{ gateway_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Content-Type: "application/json"
          Accept: "application/json"
        body_format: json
        body:
          name: "OIDC-{{ app_name }}"
          description: "OpenID Connect authentication with Keycloak for {{ app_name }}"
          type: "OAUTH2"
          authServerAlias: "{{ auth_server_name }}"
          clientId: "{{ client_id }}"
          audience: "{{ audience }}"
        status_code: [200, 201]
      register: strategy_result
      when: strategy_id is not defined

    - name: Set strategy ID from creation
      set_fact:
        strategy_id: "{{ strategy_result.json.strategy.id }}"
      when: strategy_result is defined and strategy_result.json is defined

    - name: Display strategy result
      debug:
        msg: "OAuth2 Strategy 'OIDC-{{ app_name }}' ID: {{ strategy_id | default('existing') }}"

    # =========================================================================
    # STEP 4: Create Application
    # =========================================================================
    - name: Check existing applications
      uri:
        url: "{{ gateway_url }}/rest/apigateway/applications"
        method: GET
        user: "{{ gateway_user }}"
        password: "{{ gateway_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Accept: "application/json"
        status_code: [200]
      register: applications_list

    - name: Find existing application
      set_fact:
        existing_app: "{{ applications_list.json.applications | selectattr('name', 'equalto', app_name) | list | first | default(none) }}"
      when: applications_list.json.applications is defined

    - name: Set application ID if exists
      set_fact:
        app_id: "{{ existing_app.id }}"
      when: existing_app is defined and existing_app is not none

    - name: Create Application
      uri:
        url: "{{ gateway_url }}/rest/apigateway/applications"
        method: POST
        user: "{{ gateway_user }}"
        password: "{{ gateway_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Content-Type: "application/json"
          Accept: "application/json"
        body_format: json
        body:
          name: "{{ app_name }}"
          description: "Application {{ app_name }} for OIDC authentication"
          contactEmails:
            - "admin@cab-i.com"
        status_code: [200, 201]
      register: app_result
      when: app_id is not defined

    - name: Set application ID from creation
      set_fact:
        app_id: "{{ app_result.json.id }}"
      when: app_result is defined and app_result.json is defined

    - name: Display application result
      debug:
        msg: "Application '{{ app_name }}' ID: {{ app_id | default('existing') }}"

    # =========================================================================
    # STEP 5: Associate Strategy to Application
    # =========================================================================
    - name: Update Application with Strategy and Identifiers
      uri:
        url: "{{ gateway_url }}/rest/apigateway/applications/{{ app_id }}"
        method: PUT
        user: "{{ gateway_user }}"
        password: "{{ gateway_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Content-Type: "application/json"
          Accept: "application/json"
        body_format: json
        body:
          name: "{{ app_name }}"
          description: "Application {{ app_name }} for OIDC authentication"
          contactEmails:
            - "admin@cab-i.com"
          authStrategyIds:
            - "{{ strategy_id }}"
          identifiers:
            - key: "openIdClaims"
              name: "azp"
              value:
                - "{{ client_id }}"
        status_code: [200, 204]
      when: app_id is defined and strategy_id is defined

    - name: Display application update result
      debug:
        msg: "Application '{{ app_name }}' updated with strategy {{ strategy_id }}"

    # =========================================================================
    # STEP 6: Associate API to Application
    # =========================================================================
    - name: Associate API to Application
      uri:
        url: "{{ gateway_url }}/rest/apigateway/applications/{{ app_id }}/apis"
        method: PUT
        user: "{{ gateway_user }}"
        password: "{{ gateway_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Content-Type: "application/json"
          Accept: "application/json"
        body_format: json
        body:
          - "{{ api_id }}"
        status_code: [200, 204]
      when:
        - app_id is defined
        - api_id | length > 0
      register: api_association

    - name: Display API association result
      debug:
        msg: "API {{ api_id }} associated with application {{ app_name }}"
      when: api_id | length > 0

    # =========================================================================
    # STEP 7: Create Identify & Authorize Policy Action (if needed)
    # =========================================================================
    - name: Create Identify & Authorize Policy Action
      uri:
        url: "{{ gateway_url }}/rest/apigateway/policyActions"
        method: POST
        user: "{{ gateway_user }}"
        password: "{{ gateway_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Content-Type: "application/json"
          Accept: "application/json"
        body_format: json
        body:
          policyAction:
            names:
              - value: "Identify & Authorize OIDC - {{ app_name }}"
                locale: "en"
            templateKey: "evaluatePolicy"
            parameters:
              - templateKey: "logicalConnector"
                values:
                  - "OR"
              - templateKey: "allowAnonymous"
                values:
                  - "false"
              - templateKey: "IdentificationRule"
                parameters:
                  - templateKey: "applicationLookup"
                    values:
                      - "strict"
                  - templateKey: "identificationType"
                    values:
                      - "openIdClaims"
            active: true
        status_code: [200, 201]
      register: iam_policy_action
      when: api_id | length > 0

    - name: Display IAM Policy Action ID
      debug:
        msg: "IAM Policy Action created with ID: {{ iam_policy_action.json.policyAction.id }}"
      when: iam_policy_action is defined and iam_policy_action.json is defined

    # =========================================================================
    # SUMMARY
    # =========================================================================
    - name: Configuration summary
      debug:
        msg: |
          ========================================
          OIDC Configuration Complete
          ----------------------------------------
          Auth Server: {{ auth_server_name }} ({{ auth_server_id | default('new') }})
          Strategy: OIDC-{{ app_name }} ({{ strategy_id | default('new') }})
          Application: {{ app_name }} ({{ app_id | default('new') }})
          API Associated: {{ api_id | default('none') }}
          Keycloak: {{ keycloak_url }}/realms/{{ keycloak_realm }}
          Client ID: {{ client_id }}
          Audience: {{ audience }}
          ========================================

          IMPORTANT: Ensure Keycloak client '{{ client_id }}' has:
          - Direct Access Grants Enabled (for testing)
          - Valid Redirect URIs configured
          - Token audience matches '{{ audience }}'
