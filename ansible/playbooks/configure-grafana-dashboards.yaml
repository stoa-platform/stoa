---
# Playbook: Configure Grafana Dashboards for STOA Platform
# Provisions dashboards for STOA, webMethods API Gateway (SAG), and Redpanda
#
# Usage:
#   # Using kubectl (default, recommended):
#   ansible-playbook configure-grafana-dashboards.yaml
#
#   # Using kubernetes.core module (requires proper k8s auth):
#   ansible-playbook configure-grafana-dashboards.yaml -e use_k8s_module=true
#
# Prerequisites:
#   - kubectl configured with access to the cluster
#   - Grafana running in stoa-monitoring namespace
#   - Prometheus collecting metrics
#   - ServiceMonitors configured for each component

- name: Configure Grafana Dashboards
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    grafana_namespace: "stoa-monitoring"
    grafana_service: "kube-prometheus-stack-grafana"
    grafana_port: 80
    # Dashboard folder for STOA
    stoa_folder_name: "STOA Platform"
    stoa_folder_uid: "stoa-platform"
    # Use kubectl by default (more reliable auth)
    use_k8s_module: false
    # Dashboard definitions directory
    dashboard_temp_dir: "/tmp/grafana-dashboards"

  tasks:
    - name: Display configuration
      debug:
        msg: |
          ========================================
          Configuring Grafana Dashboards
          ========================================
          Namespace: {{ grafana_namespace }}
          Service: {{ grafana_service }}
          Folder: {{ stoa_folder_name }}
          Method: {{ 'kubernetes.core.k8s module' if use_k8s_module else 'kubectl (shell)' }}
          ========================================

    # =========================================================================
    # Verify kubectl access
    # =========================================================================
    - name: Verify kubectl cluster access
      ansible.builtin.shell: |
        kubectl cluster-info
      register: kubectl_check
      changed_when: false
      when: not use_k8s_module

    - name: Create temp directory for dashboard manifests
      ansible.builtin.file:
        path: "{{ dashboard_temp_dir }}"
        state: directory
        mode: '0755'
      when: not use_k8s_module

    # =========================================================================
    # KUBECTL METHOD - STOA SLO Dashboard
    # =========================================================================
    - name: Create STOA SLO Dashboard manifest
      ansible.builtin.copy:
        dest: "{{ dashboard_temp_dir }}/stoa-slo-configmap.yaml"
        content: |
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-dashboard-stoa-slo
            namespace: {{ grafana_namespace }}
            labels:
              grafana_dashboard: "1"
          data:
            stoa-slo.json: |
              {"annotations":{"list":[]},"editable":true,"fiscalYearStartMonth":0,"graphTooltip":0,"id":null,"links":[],"panels":[{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"red","value":null},{"color":"yellow","value":99},{"color":"green","value":99.9}]},"unit":"percent"}},"gridPos":{"h":4,"w":4,"x":0,"y":0},"id":1,"options":{"colorMode":"value","graphMode":"none","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"10.0.0","targets":[{"expr":"100 * (1 - (sum(rate(http_requests_total{service=\"control-plane-api\", status=~\"5..\"}[5m])) or vector(0)) / (sum(rate(http_requests_total{service=\"control-plane-api\"}[5m])) or vector(1)))","refId":"A"}],"title":"Availability","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":200},{"color":"red","value":500}]},"unit":"ms"}},"gridPos":{"h":4,"w":4,"x":4,"y":0},"id":2,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"10.0.0","targets":[{"expr":"histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service=\"control-plane-api\"}[5m])) by (le)) * 1000","refId":"A"}],"title":"Latency P95","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":1},{"color":"red","value":5}]},"unit":"percent"}},"gridPos":{"h":4,"w":4,"x":8,"y":0},"id":3,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"10.0.0","targets":[{"expr":"100 * (sum(rate(http_requests_total{service=\"control-plane-api\", status=~\"5..\"}[5m])) or vector(0)) / (sum(rate(http_requests_total{service=\"control-plane-api\"}[5m])) or vector(1))","refId":"A"}],"title":"Error Rate","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":10,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"reqps"}},"gridPos":{"h":8,"w":12,"x":0,"y":4},"id":4,"options":{"legend":{"calcs":["mean","max"],"displayMode":"table","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"none"}},"pluginVersion":"10.0.0","targets":[{"expr":"sum(rate(http_requests_total{service=\"control-plane-api\"}[1m])) by (method, path)","legendFormat":"{{ '{{method}} {{path}}' }}","refId":"A"}],"title":"Request Rate by Endpoint","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":10,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"ms"}},"gridPos":{"h":8,"w":12,"x":12,"y":4},"id":5,"options":{"legend":{"calcs":["mean","max"],"displayMode":"table","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"none"}},"pluginVersion":"10.0.0","targets":[{"expr":"histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{service=\"control-plane-api\"}[5m])) by (le)) * 1000","legendFormat":"P50","refId":"A"},{"expr":"histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service=\"control-plane-api\"}[5m])) by (le)) * 1000","legendFormat":"P95","refId":"B"},{"expr":"histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{service=\"control-plane-api\"}[5m])) by (le)) * 1000","legendFormat":"P99","refId":"C"}],"title":"Response Time Distribution","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":10,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"bytes"}},"gridPos":{"h":8,"w":12,"x":0,"y":12},"id":6,"options":{"legend":{"calcs":["mean","max"],"displayMode":"table","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"none"}},"pluginVersion":"10.0.0","targets":[{"expr":"process_resident_memory_bytes{service=\"control-plane-api\"}","legendFormat":"{{ '{{pod}}' }}","refId":"A"}],"title":"Memory Usage","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":10,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"percent"}},"gridPos":{"h":8,"w":12,"x":12,"y":12},"id":7,"options":{"legend":{"calcs":["mean","max"],"displayMode":"table","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"none"}},"pluginVersion":"10.0.0","targets":[{"expr":"rate(process_cpu_seconds_total{service=\"control-plane-api\"}[1m]) * 100","legendFormat":"{{ '{{pod}}' }}","refId":"A"}],"title":"CPU Usage","type":"timeseries"}],"refresh":"30s","schemaVersion":38,"tags":["stoa","slo","api"],"templating":{"list":[]},"time":{"from":"now-1h","to":"now"},"timepicker":{},"timezone":"browser","title":"STOA Platform - SLO Overview","uid":"stoa-slo-overview","version":1,"weekStart":""}
      when: not use_k8s_module

    - name: Apply STOA SLO Dashboard via kubectl
      ansible.builtin.shell: |
        kubectl apply -f {{ dashboard_temp_dir }}/stoa-slo-configmap.yaml
      register: stoa_dashboard_result
      changed_when: "'configured' in stoa_dashboard_result.stdout or 'created' in stoa_dashboard_result.stdout"
      when: not use_k8s_module

    # =========================================================================
    # KUBECTL METHOD - SAG Gateway Dashboard
    # =========================================================================
    - name: Create SAG Gateway Dashboard manifest
      ansible.builtin.copy:
        dest: "{{ dashboard_temp_dir }}/sag-gateway-configmap.yaml"
        content: |
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-dashboard-sag-gateway
            namespace: {{ grafana_namespace }}
            labels:
              grafana_dashboard: "1"
          data:
            sag-gateway.json: |
              {"annotations":{"list":[]},"editable":true,"fiscalYearStartMonth":0,"graphTooltip":0,"id":null,"links":[],"panels":[{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[{"options":{"1":{"color":"green","index":0,"text":"UP"}},"type":"value"},{"options":{"match":"null","result":{"color":"red","index":1,"text":"DOWN"}},"type":"special"}],"thresholds":{"mode":"absolute","steps":[{"color":"red","value":null},{"color":"green","value":1}]}}},"gridPos":{"h":4,"w":4,"x":0,"y":0},"id":1,"options":{"colorMode":"background","graphMode":"none","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"10.0.0","targets":[{"expr":"up{job=~\".*apigateway.*\"}","refId":"A"}],"title":"Gateway Status","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"short"}},"gridPos":{"h":4,"w":4,"x":4,"y":0},"id":2,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"10.0.0","targets":[{"expr":"sum(rate(sag_api_invocations_total[5m])) or vector(0)","refId":"A"}],"title":"API Invocations/sec","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":100},{"color":"red","value":500}]},"unit":"ms"}},"gridPos":{"h":4,"w":4,"x":8,"y":0},"id":3,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"10.0.0","targets":[{"expr":"avg(sag_api_response_time_ms) or 0","refId":"A"}],"title":"Avg Response Time","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":1},{"color":"red","value":5}]},"unit":"percent"}},"gridPos":{"h":4,"w":4,"x":12,"y":0},"id":4,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"10.0.0","targets":[{"expr":"100 * sum(rate(sag_api_errors_total[5m])) / (sum(rate(sag_api_invocations_total[5m])) or vector(1))","refId":"A"}],"title":"Error Rate %","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":10,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"reqps"}},"gridPos":{"h":8,"w":12,"x":0,"y":4},"id":5,"options":{"legend":{"calcs":["mean","max"],"displayMode":"table","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"none"}},"pluginVersion":"10.0.0","targets":[{"expr":"sum(rate(sag_api_invocations_total[1m])) by (api_name)","legendFormat":"{{ '{{api_name}}' }}","refId":"A"}],"title":"API Invocations by API","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":10,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"ms"}},"gridPos":{"h":8,"w":12,"x":12,"y":4},"id":6,"options":{"legend":{"calcs":["mean","max"],"displayMode":"table","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"none"}},"pluginVersion":"10.0.0","targets":[{"expr":"avg(sag_api_response_time_ms) by (api_name)","legendFormat":"{{ '{{api_name}}' }}","refId":"A"}],"title":"Response Time by API","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"bars","fillOpacity":100,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":false,"stacking":{"group":"A","mode":"normal"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"short"}},"gridPos":{"h":8,"w":24,"x":0,"y":12},"id":7,"options":{"legend":{"calcs":[],"displayMode":"table","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"none"}},"pluginVersion":"10.0.0","targets":[{"expr":"sum(increase(sag_api_invocations_total{status=\"success\"}[1h])) by (api_name)","legendFormat":"{{ '{{api_name}}' }} - Success","refId":"A"},{"expr":"sum(increase(sag_api_errors_total[1h])) by (api_name)","legendFormat":"{{ '{{api_name}}' }} - Errors","refId":"B"}],"title":"API Traffic (Success vs Errors)","type":"timeseries"}],"refresh":"30s","schemaVersion":38,"tags":["sag","apigateway","webmethods"],"templating":{"list":[]},"time":{"from":"now-1h","to":"now"},"timepicker":{},"timezone":"browser","title":"webMethods API Gateway","uid":"sag-gateway","version":1,"weekStart":""}
      when: not use_k8s_module

    - name: Apply SAG Gateway Dashboard via kubectl
      ansible.builtin.shell: |
        kubectl apply -f {{ dashboard_temp_dir }}/sag-gateway-configmap.yaml
      register: sag_dashboard_result
      changed_when: "'configured' in sag_dashboard_result.stdout or 'created' in sag_dashboard_result.stdout"
      when: not use_k8s_module

    # =========================================================================
    # KUBECTL METHOD - Redpanda Dashboard
    # =========================================================================
    - name: Create Redpanda Dashboard manifest
      ansible.builtin.copy:
        dest: "{{ dashboard_temp_dir }}/redpanda-configmap.yaml"
        content: |
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-dashboard-redpanda
            namespace: {{ grafana_namespace }}
            labels:
              grafana_dashboard: "1"
          data:
            redpanda.json: |
              {"annotations":{"list":[]},"editable":true,"fiscalYearStartMonth":0,"graphTooltip":0,"id":null,"links":[],"panels":[{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[{"options":{"1":{"color":"green","index":0,"text":"Healthy"}},"type":"value"},{"options":{"match":"null","result":{"color":"red","index":1,"text":"Down"}},"type":"special"}],"thresholds":{"mode":"absolute","steps":[{"color":"red","value":null},{"color":"green","value":1}]}}},"gridPos":{"h":4,"w":4,"x":0,"y":0},"id":1,"options":{"colorMode":"background","graphMode":"none","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"10.0.0","targets":[{"expr":"up{job=~\".*redpanda.*\"}","refId":"A"}],"title":"Cluster Status","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"short"}},"gridPos":{"h":4,"w":4,"x":4,"y":0},"id":2,"options":{"colorMode":"value","graphMode":"none","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"10.0.0","targets":[{"expr":"count(redpanda_cluster_brokers) or count(up{job=~\".*redpanda.*\"})","refId":"A"}],"title":"Brokers","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"short"}},"gridPos":{"h":4,"w":4,"x":8,"y":0},"id":3,"options":{"colorMode":"value","graphMode":"none","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"10.0.0","targets":[{"expr":"count(count by (redpanda_topic) (redpanda_kafka_partition_high_watermark))","refId":"A"}],"title":"Topics","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"short"}},"gridPos":{"h":4,"w":4,"x":12,"y":0},"id":4,"options":{"colorMode":"value","graphMode":"none","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"10.0.0","targets":[{"expr":"sum(redpanda_kafka_partition_high_watermark)","refId":"A"}],"title":"Total Messages","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":10,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"binBps"}},"gridPos":{"h":8,"w":12,"x":0,"y":4},"id":5,"options":{"legend":{"calcs":["mean","max"],"displayMode":"table","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"none"}},"pluginVersion":"10.0.0","targets":[{"expr":"sum(rate(redpanda_kafka_request_bytes_total{redpanda_request=\"produce\"}[1m]))","legendFormat":"Produce","refId":"A"},{"expr":"sum(rate(redpanda_kafka_request_bytes_total{redpanda_request=\"fetch\"}[1m]))","legendFormat":"Fetch","refId":"B"}],"title":"Throughput (Produce vs Fetch)","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":10,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"ms"}},"gridPos":{"h":8,"w":12,"x":12,"y":4},"id":6,"options":{"legend":{"calcs":["mean","max"],"displayMode":"table","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"none"}},"pluginVersion":"10.0.0","targets":[{"expr":"histogram_quantile(0.95, sum(rate(redpanda_kafka_request_latency_seconds_bucket{redpanda_request=\"produce\"}[5m])) by (le)) * 1000","legendFormat":"Produce P95","refId":"A"},{"expr":"histogram_quantile(0.95, sum(rate(redpanda_kafka_request_latency_seconds_bucket{redpanda_request=\"fetch\"}[5m])) by (le)) * 1000","legendFormat":"Fetch P95","refId":"B"}],"title":"Request Latency P95","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":10,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"short"}},"gridPos":{"h":8,"w":12,"x":0,"y":12},"id":7,"options":{"legend":{"calcs":["mean","max"],"displayMode":"table","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"none"}},"pluginVersion":"10.0.0","targets":[{"expr":"sum(redpanda_kafka_consumer_group_lag) by (redpanda_group, redpanda_topic)","legendFormat":"{{ '{{redpanda_group}} - {{redpanda_topic}}' }}","refId":"A"}],"title":"Consumer Lag by Group","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":10,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"bytes"}},"gridPos":{"h":8,"w":12,"x":12,"y":12},"id":8,"options":{"legend":{"calcs":["mean","max"],"displayMode":"table","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"none"}},"pluginVersion":"10.0.0","targets":[{"expr":"redpanda_storage_disk_total_bytes","legendFormat":"Total","refId":"A"},{"expr":"redpanda_storage_disk_total_bytes - redpanda_storage_disk_free_bytes","legendFormat":"Used","refId":"B"}],"title":"Storage Usage","type":"timeseries"}],"refresh":"30s","schemaVersion":38,"tags":["redpanda","kafka","streaming"],"templating":{"list":[]},"time":{"from":"now-1h","to":"now"},"timepicker":{},"timezone":"browser","title":"Redpanda Cluster","uid":"redpanda-cluster","version":1,"weekStart":""}
      when: not use_k8s_module

    - name: Apply Redpanda Dashboard via kubectl
      ansible.builtin.shell: |
        kubectl apply -f {{ dashboard_temp_dir }}/redpanda-configmap.yaml
      register: redpanda_dashboard_result
      changed_when: "'configured' in redpanda_dashboard_result.stdout or 'created' in redpanda_dashboard_result.stdout"
      when: not use_k8s_module

    # =========================================================================
    # KUBECTL METHOD - MCP Gateway Dashboard
    # =========================================================================
    - name: Create MCP Gateway Dashboard manifest
      ansible.builtin.copy:
        dest: "{{ dashboard_temp_dir }}/mcp-gateway-configmap.yaml"
        content: |
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-dashboard-mcp-gateway
            namespace: {{ grafana_namespace }}
            labels:
              grafana_dashboard: "1"
          data:
            mcp-gateway.json: |
              {"annotations":{"list":[]},"editable":true,"fiscalYearStartMonth":0,"graphTooltip":0,"id":null,"links":[],"panels":[{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"short"}},"gridPos":{"h":4,"w":6,"x":0,"y":0},"id":1,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"10.0.0","targets":[{"expr":"sum(rate(mcp_tool_invocations_total[5m]))","refId":"A"}],"title":"Tool Invocations/sec","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":100},{"color":"red","value":500}]},"unit":"ms"}},"gridPos":{"h":4,"w":6,"x":6,"y":0},"id":2,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"10.0.0","targets":[{"expr":"histogram_quantile(0.95, sum(rate(mcp_tool_duration_seconds_bucket[5m])) by (le)) * 1000","refId":"A"}],"title":"Tool Latency P95","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"short"}},"gridPos":{"h":4,"w":6,"x":12,"y":0},"id":3,"options":{"colorMode":"value","graphMode":"none","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"10.0.0","targets":[{"expr":"count(mcp_tools_registered)","refId":"A"}],"title":"Registered Tools","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":1},{"color":"red","value":5}]},"unit":"percent"}},"gridPos":{"h":4,"w":6,"x":18,"y":0},"id":4,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"10.0.0","targets":[{"expr":"100 * sum(rate(mcp_tool_invocations_total{status=\"error\"}[5m])) / (sum(rate(mcp_tool_invocations_total[5m])) or vector(1))","refId":"A"}],"title":"Error Rate","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":10,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"short"}},"gridPos":{"h":8,"w":12,"x":0,"y":4},"id":5,"options":{"legend":{"calcs":["mean","sum"],"displayMode":"table","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"none"}},"pluginVersion":"10.0.0","targets":[{"expr":"sum(rate(mcp_tool_invocations_total[1m])) by (tool)","legendFormat":"{{ '{{tool}}' }}","refId":"A"}],"title":"Invocations by Tool","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"drawStyle":"line","fillOpacity":10,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"never","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"short"}},"gridPos":{"h":8,"w":12,"x":12,"y":4},"id":6,"options":{"legend":{"calcs":["mean","sum"],"displayMode":"table","placement":"bottom","showLegend":true},"tooltip":{"mode":"multi","sort":"none"}},"pluginVersion":"10.0.0","targets":[{"expr":"sum(rate(mcp_tool_invocations_total[1m])) by (category)","legendFormat":"{{ '{{category}}' }}","refId":"A"}],"title":"Invocations by Category","type":"timeseries"}],"refresh":"30s","schemaVersion":38,"tags":["mcp","tools","ai"],"templating":{"list":[]},"time":{"from":"now-1h","to":"now"},"timepicker":{},"timezone":"browser","title":"MCP Gateway","uid":"mcp-gateway","version":1,"weekStart":""}
      when: not use_k8s_module

    - name: Apply MCP Gateway Dashboard via kubectl
      ansible.builtin.shell: |
        kubectl apply -f {{ dashboard_temp_dir }}/mcp-gateway-configmap.yaml
      register: mcp_dashboard_result
      changed_when: "'configured' in mcp_dashboard_result.stdout or 'created' in mcp_dashboard_result.stdout"
      when: not use_k8s_module

    # =========================================================================
    # K8S MODULE METHOD - Create STOA Dashboard Folder (alternative)
    # =========================================================================
    - name: Create STOA folder in Grafana (k8s module)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-dashboard-folder-stoa
            namespace: "{{ grafana_namespace }}"
            labels:
              grafana_dashboard_folder: "1"
          data:
            stoa-folder.json: |
              {
                "uid": "{{ stoa_folder_uid }}",
                "title": "{{ stoa_folder_name }}"
              }
      when: use_k8s_module

    # =========================================================================
    # STOA Platform SLO Dashboard
    # =========================================================================
    - name: Create STOA SLO Dashboard ConfigMap
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-dashboard-stoa-slo
            namespace: "{{ grafana_namespace }}"
            labels:
              grafana_dashboard: "1"
          data:
            stoa-slo.json: |
              {
                "annotations": {
                  "list": []
                },
                "editable": true,
                "fiscalYearStartMonth": 0,
                "graphTooltip": 0,
                "id": null,
                "links": [],
                "panels": [
                  {
                    "datasource": {
                      "type": "prometheus",
                      "uid": "prometheus"
                    },
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [],
                        "thresholds": {
                          "mode": "absolute",
                          "steps": [
                            {"color": "red", "value": null},
                            {"color": "yellow", "value": 99},
                            {"color": "green", "value": 99.9}
                          ]
                        },
                        "unit": "percent"
                      }
                    },
                    "gridPos": {"h": 4, "w": 4, "x": 0, "y": 0},
                    "id": 1,
                    "options": {
                      "colorMode": "value",
                      "graphMode": "none",
                      "justifyMode": "auto",
                      "orientation": "auto",
                      "reduceOptions": {
                        "calcs": ["lastNotNull"],
                        "fields": "",
                        "values": false
                      },
                      "textMode": "auto"
                    },
                    "pluginVersion": "10.0.0",
                    "targets": [
                      {
                        "expr": "100 * (1 - (sum(rate(http_requests_total{service=\"control-plane-api\", status=~\"5..\"}[5m])) or vector(0)) / (sum(rate(http_requests_total{service=\"control-plane-api\"}[5m])) or vector(1)))",
                        "refId": "A"
                      }
                    ],
                    "title": "Availability",
                    "type": "stat"
                  },
                  {
                    "datasource": {
                      "type": "prometheus",
                      "uid": "prometheus"
                    },
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [],
                        "thresholds": {
                          "mode": "absolute",
                          "steps": [
                            {"color": "green", "value": null},
                            {"color": "yellow", "value": 200},
                            {"color": "red", "value": 500}
                          ]
                        },
                        "unit": "ms"
                      }
                    },
                    "gridPos": {"h": 4, "w": 4, "x": 4, "y": 0},
                    "id": 2,
                    "options": {
                      "colorMode": "value",
                      "graphMode": "area",
                      "justifyMode": "auto",
                      "orientation": "auto",
                      "reduceOptions": {
                        "calcs": ["lastNotNull"],
                        "fields": "",
                        "values": false
                      },
                      "textMode": "auto"
                    },
                    "pluginVersion": "10.0.0",
                    "targets": [
                      {
                        "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service=\"control-plane-api\"}[5m])) by (le)) * 1000",
                        "refId": "A"
                      }
                    ],
                    "title": "Latency P95",
                    "type": "stat"
                  },
                  {
                    "datasource": {
                      "type": "prometheus",
                      "uid": "prometheus"
                    },
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [],
                        "thresholds": {
                          "mode": "absolute",
                          "steps": [
                            {"color": "green", "value": null},
                            {"color": "yellow", "value": 1},
                            {"color": "red", "value": 5}
                          ]
                        },
                        "unit": "percent"
                      }
                    },
                    "gridPos": {"h": 4, "w": 4, "x": 8, "y": 0},
                    "id": 3,
                    "options": {
                      "colorMode": "value",
                      "graphMode": "area",
                      "justifyMode": "auto",
                      "orientation": "auto",
                      "reduceOptions": {
                        "calcs": ["lastNotNull"],
                        "fields": "",
                        "values": false
                      },
                      "textMode": "auto"
                    },
                    "pluginVersion": "10.0.0",
                    "targets": [
                      {
                        "expr": "100 * (sum(rate(http_requests_total{service=\"control-plane-api\", status=~\"5..\"}[5m])) or vector(0)) / (sum(rate(http_requests_total{service=\"control-plane-api\"}[5m])) or vector(1))",
                        "refId": "A"
                      }
                    ],
                    "title": "Error Rate",
                    "type": "stat"
                  },
                  {
                    "datasource": {
                      "type": "prometheus",
                      "uid": "prometheus"
                    },
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {
                          "axisCenteredZero": false,
                          "axisColorMode": "text",
                          "axisLabel": "",
                          "axisPlacement": "auto",
                          "barAlignment": 0,
                          "drawStyle": "line",
                          "fillOpacity": 10,
                          "gradientMode": "none",
                          "hideFrom": {"legend": false, "tooltip": false, "viz": false},
                          "lineInterpolation": "linear",
                          "lineWidth": 1,
                          "pointSize": 5,
                          "scaleDistribution": {"type": "linear"},
                          "showPoints": "never",
                          "spanNulls": false,
                          "stacking": {"group": "A", "mode": "none"},
                          "thresholdsStyle": {"mode": "off"}
                        },
                        "mappings": [],
                        "thresholds": {
                          "mode": "absolute",
                          "steps": [{"color": "green", "value": null}]
                        },
                        "unit": "reqps"
                      }
                    },
                    "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
                    "id": 4,
                    "options": {
                      "legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true},
                      "tooltip": {"mode": "multi", "sort": "none"}
                    },
                    "pluginVersion": "10.0.0",
                    "targets": [
                      {
                        "expr": "sum(rate(http_requests_total{service=\"control-plane-api\"}[1m])) by (method, path)",
                        "legendFormat": "{{method}} {{path}}",
                        "refId": "A"
                      }
                    ],
                    "title": "Request Rate by Endpoint",
                    "type": "timeseries"
                  },
                  {
                    "datasource": {
                      "type": "prometheus",
                      "uid": "prometheus"
                    },
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {
                          "axisCenteredZero": false,
                          "axisColorMode": "text",
                          "axisLabel": "",
                          "axisPlacement": "auto",
                          "barAlignment": 0,
                          "drawStyle": "line",
                          "fillOpacity": 10,
                          "gradientMode": "none",
                          "hideFrom": {"legend": false, "tooltip": false, "viz": false},
                          "lineInterpolation": "linear",
                          "lineWidth": 1,
                          "pointSize": 5,
                          "scaleDistribution": {"type": "linear"},
                          "showPoints": "never",
                          "spanNulls": false,
                          "stacking": {"group": "A", "mode": "none"},
                          "thresholdsStyle": {"mode": "off"}
                        },
                        "mappings": [],
                        "thresholds": {
                          "mode": "absolute",
                          "steps": [{"color": "green", "value": null}]
                        },
                        "unit": "ms"
                      }
                    },
                    "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
                    "id": 5,
                    "options": {
                      "legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true},
                      "tooltip": {"mode": "multi", "sort": "none"}
                    },
                    "pluginVersion": "10.0.0",
                    "targets": [
                      {
                        "expr": "histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{service=\"control-plane-api\"}[5m])) by (le)) * 1000",
                        "legendFormat": "P50",
                        "refId": "A"
                      },
                      {
                        "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service=\"control-plane-api\"}[5m])) by (le)) * 1000",
                        "legendFormat": "P95",
                        "refId": "B"
                      },
                      {
                        "expr": "histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{service=\"control-plane-api\"}[5m])) by (le)) * 1000",
                        "legendFormat": "P99",
                        "refId": "C"
                      }
                    ],
                    "title": "Response Time Distribution",
                    "type": "timeseries"
                  },
                  {
                    "datasource": {
                      "type": "prometheus",
                      "uid": "prometheus"
                    },
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {
                          "axisCenteredZero": false,
                          "axisColorMode": "text",
                          "axisLabel": "",
                          "axisPlacement": "auto",
                          "barAlignment": 0,
                          "drawStyle": "line",
                          "fillOpacity": 10,
                          "gradientMode": "none",
                          "hideFrom": {"legend": false, "tooltip": false, "viz": false},
                          "lineInterpolation": "linear",
                          "lineWidth": 1,
                          "pointSize": 5,
                          "scaleDistribution": {"type": "linear"},
                          "showPoints": "never",
                          "spanNulls": false,
                          "stacking": {"group": "A", "mode": "none"},
                          "thresholdsStyle": {"mode": "off"}
                        },
                        "mappings": [],
                        "thresholds": {
                          "mode": "absolute",
                          "steps": [{"color": "green", "value": null}]
                        },
                        "unit": "bytes"
                      }
                    },
                    "gridPos": {"h": 8, "w": 12, "x": 0, "y": 12},
                    "id": 6,
                    "options": {
                      "legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true},
                      "tooltip": {"mode": "multi", "sort": "none"}
                    },
                    "pluginVersion": "10.0.0",
                    "targets": [
                      {
                        "expr": "process_resident_memory_bytes{service=\"control-plane-api\"}",
                        "legendFormat": "{{pod}}",
                        "refId": "A"
                      }
                    ],
                    "title": "Memory Usage",
                    "type": "timeseries"
                  },
                  {
                    "datasource": {
                      "type": "prometheus",
                      "uid": "prometheus"
                    },
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {
                          "axisCenteredZero": false,
                          "axisColorMode": "text",
                          "axisLabel": "",
                          "axisPlacement": "auto",
                          "barAlignment": 0,
                          "drawStyle": "line",
                          "fillOpacity": 10,
                          "gradientMode": "none",
                          "hideFrom": {"legend": false, "tooltip": false, "viz": false},
                          "lineInterpolation": "linear",
                          "lineWidth": 1,
                          "pointSize": 5,
                          "scaleDistribution": {"type": "linear"},
                          "showPoints": "never",
                          "spanNulls": false,
                          "stacking": {"group": "A", "mode": "none"},
                          "thresholdsStyle": {"mode": "off"}
                        },
                        "mappings": [],
                        "thresholds": {
                          "mode": "absolute",
                          "steps": [{"color": "green", "value": null}]
                        },
                        "unit": "percent"
                      }
                    },
                    "gridPos": {"h": 8, "w": 12, "x": 12, "y": 12},
                    "id": 7,
                    "options": {
                      "legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true},
                      "tooltip": {"mode": "multi", "sort": "none"}
                    },
                    "pluginVersion": "10.0.0",
                    "targets": [
                      {
                        "expr": "rate(process_cpu_seconds_total{service=\"control-plane-api\"}[1m]) * 100",
                        "legendFormat": "{{pod}}",
                        "refId": "A"
                      }
                    ],
                    "title": "CPU Usage",
                    "type": "timeseries"
                  }
                ],
                "refresh": "30s",
                "schemaVersion": 38,
                "tags": ["stoa", "slo", "api"],
                "templating": {"list": []},
                "time": {"from": "now-1h", "to": "now"},
                "timepicker": {},
                "timezone": "browser",
                "title": "STOA Platform - SLO Overview",
                "uid": "stoa-slo-overview",
                "version": 1,
                "weekStart": ""
              }
      when: use_k8s_module

    # =========================================================================
    # webMethods API Gateway Dashboard
    # =========================================================================
    - name: Create SAG API Gateway Dashboard ConfigMap
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-dashboard-sag-gateway
            namespace: "{{ grafana_namespace }}"
            labels:
              grafana_dashboard: "1"
          data:
            sag-gateway.json: |
              {
                "annotations": {"list": []},
                "editable": true,
                "fiscalYearStartMonth": 0,
                "graphTooltip": 0,
                "id": null,
                "links": [],
                "panels": [
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [
                          {"options": {"1": {"color": "green", "index": 0, "text": "UP"}}, "type": "value"},
                          {"options": {"match": "null", "result": {"color": "red", "index": 1, "text": "DOWN"}},"type": "special"}
                        ],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "red", "value": null}, {"color": "green", "value": 1}]}
                      }
                    },
                    "gridPos": {"h": 4, "w": 4, "x": 0, "y": 0},
                    "id": 1,
                    "options": {"colorMode": "background", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "up{job=~\".*apigateway.*\"}", "refId": "A"}],
                    "title": "Gateway Status",
                    "type": "stat"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                        "unit": "short"
                      }
                    },
                    "gridPos": {"h": 4, "w": 4, "x": 4, "y": 0},
                    "id": 2,
                    "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "sum(rate(sag_api_invocations_total[5m])) or vector(0)", "refId": "A"}],
                    "title": "API Invocations/sec",
                    "type": "stat"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 100}, {"color": "red", "value": 500}]},
                        "unit": "ms"
                      }
                    },
                    "gridPos": {"h": 4, "w": 4, "x": 8, "y": 0},
                    "id": 3,
                    "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "avg(sag_api_response_time_ms) or 0", "refId": "A"}],
                    "title": "Avg Response Time",
                    "type": "stat"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 1}, {"color": "red", "value": 5}]},
                        "unit": "percent"
                      }
                    },
                    "gridPos": {"h": 4, "w": 4, "x": 12, "y": 0},
                    "id": 4,
                    "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "100 * sum(rate(sag_api_errors_total[5m])) / (sum(rate(sag_api_invocations_total[5m])) or vector(1))", "refId": "A"}],
                    "title": "Error Rate %",
                    "type": "stat"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {"axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                        "unit": "reqps"
                      }
                    },
                    "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
                    "id": 5,
                    "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "none"}},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "sum(rate(sag_api_invocations_total[1m])) by (api_name)", "legendFormat": "{{api_name}}", "refId": "A"}],
                    "title": "API Invocations by API",
                    "type": "timeseries"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {"axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                        "unit": "ms"
                      }
                    },
                    "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
                    "id": 6,
                    "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "none"}},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "avg(sag_api_response_time_ms) by (api_name)", "legendFormat": "{{api_name}}", "refId": "A"}],
                    "title": "Response Time by API",
                    "type": "timeseries"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {"axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "bars", "fillOpacity": 100, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "normal"}, "thresholdsStyle": {"mode": "off"}},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                        "unit": "short"
                      }
                    },
                    "gridPos": {"h": 8, "w": 24, "x": 0, "y": 12},
                    "id": 7,
                    "options": {"legend": {"calcs": [], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "none"}},
                    "pluginVersion": "10.0.0",
                    "targets": [
                      {"expr": "sum(increase(sag_api_invocations_total{status=\"success\"}[1h])) by (api_name)", "legendFormat": "{{api_name}} - Success", "refId": "A"},
                      {"expr": "sum(increase(sag_api_errors_total[1h])) by (api_name)", "legendFormat": "{{api_name}} - Errors", "refId": "B"}
                    ],
                    "title": "API Traffic (Success vs Errors)",
                    "type": "timeseries"
                  }
                ],
                "refresh": "30s",
                "schemaVersion": 38,
                "tags": ["sag", "apigateway", "webmethods"],
                "templating": {"list": []},
                "time": {"from": "now-1h", "to": "now"},
                "timepicker": {},
                "timezone": "browser",
                "title": "webMethods API Gateway",
                "uid": "sag-gateway",
                "version": 1,
                "weekStart": ""
              }
      when: use_k8s_module

    # =========================================================================
    # Redpanda Dashboard
    # =========================================================================
    - name: Create Redpanda Dashboard ConfigMap
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-dashboard-redpanda
            namespace: "{{ grafana_namespace }}"
            labels:
              grafana_dashboard: "1"
          data:
            redpanda.json: |
              {
                "annotations": {"list": []},
                "editable": true,
                "fiscalYearStartMonth": 0,
                "graphTooltip": 0,
                "id": null,
                "links": [],
                "panels": [
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [{"options": {"1": {"color": "green", "index": 0, "text": "Healthy"}}, "type": "value"}, {"options": {"match": "null", "result": {"color": "red", "index": 1, "text": "Down"}}, "type": "special"}],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "red", "value": null}, {"color": "green", "value": 1}]}
                      }
                    },
                    "gridPos": {"h": 4, "w": 4, "x": 0, "y": 0},
                    "id": 1,
                    "options": {"colorMode": "background", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "up{job=~\".*redpanda.*\"}", "refId": "A"}],
                    "title": "Cluster Status",
                    "type": "stat"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                        "unit": "short"
                      }
                    },
                    "gridPos": {"h": 4, "w": 4, "x": 4, "y": 0},
                    "id": 2,
                    "options": {"colorMode": "value", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "count(redpanda_cluster_brokers) or count(up{job=~\".*redpanda.*\"})", "refId": "A"}],
                    "title": "Brokers",
                    "type": "stat"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                        "unit": "short"
                      }
                    },
                    "gridPos": {"h": 4, "w": 4, "x": 8, "y": 0},
                    "id": 3,
                    "options": {"colorMode": "value", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "count(count by (redpanda_topic) (redpanda_kafka_partition_high_watermark))", "refId": "A"}],
                    "title": "Topics",
                    "type": "stat"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                        "unit": "short"
                      }
                    },
                    "gridPos": {"h": 4, "w": 4, "x": 12, "y": 0},
                    "id": 4,
                    "options": {"colorMode": "value", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "sum(redpanda_kafka_partition_high_watermark)", "refId": "A"}],
                    "title": "Total Messages",
                    "type": "stat"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {"axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                        "unit": "binBps"
                      }
                    },
                    "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
                    "id": 5,
                    "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "none"}},
                    "pluginVersion": "10.0.0",
                    "targets": [
                      {"expr": "sum(rate(redpanda_kafka_request_bytes_total{redpanda_request=\"produce\"}[1m]))", "legendFormat": "Produce", "refId": "A"},
                      {"expr": "sum(rate(redpanda_kafka_request_bytes_total{redpanda_request=\"fetch\"}[1m]))", "legendFormat": "Fetch", "refId": "B"}
                    ],
                    "title": "Throughput (Produce vs Fetch)",
                    "type": "timeseries"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {"axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                        "unit": "ms"
                      }
                    },
                    "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
                    "id": 6,
                    "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "none"}},
                    "pluginVersion": "10.0.0",
                    "targets": [
                      {"expr": "histogram_quantile(0.95, sum(rate(redpanda_kafka_request_latency_seconds_bucket{redpanda_request=\"produce\"}[5m])) by (le)) * 1000", "legendFormat": "Produce P95", "refId": "A"},
                      {"expr": "histogram_quantile(0.95, sum(rate(redpanda_kafka_request_latency_seconds_bucket{redpanda_request=\"fetch\"}[5m])) by (le)) * 1000", "legendFormat": "Fetch P95", "refId": "B"}
                    ],
                    "title": "Request Latency P95",
                    "type": "timeseries"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {"axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                        "unit": "short"
                      }
                    },
                    "gridPos": {"h": 8, "w": 12, "x": 0, "y": 12},
                    "id": 7,
                    "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "none"}},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "sum(redpanda_kafka_consumer_group_lag) by (redpanda_group, redpanda_topic)", "legendFormat": "{{redpanda_group}} - {{redpanda_topic}}", "refId": "A"}],
                    "title": "Consumer Lag by Group",
                    "type": "timeseries"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {"axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                        "unit": "bytes"
                      }
                    },
                    "gridPos": {"h": 8, "w": 12, "x": 12, "y": 12},
                    "id": 8,
                    "options": {"legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "none"}},
                    "pluginVersion": "10.0.0",
                    "targets": [
                      {"expr": "redpanda_storage_disk_total_bytes", "legendFormat": "Total", "refId": "A"},
                      {"expr": "redpanda_storage_disk_total_bytes - redpanda_storage_disk_free_bytes", "legendFormat": "Used", "refId": "B"}
                    ],
                    "title": "Storage Usage",
                    "type": "timeseries"
                  }
                ],
                "refresh": "30s",
                "schemaVersion": 38,
                "tags": ["redpanda", "kafka", "streaming"],
                "templating": {"list": []},
                "time": {"from": "now-1h", "to": "now"},
                "timepicker": {},
                "timezone": "browser",
                "title": "Redpanda Cluster",
                "uid": "redpanda-cluster",
                "version": 1,
                "weekStart": ""
              }
      when: use_k8s_module

    # =========================================================================
    # MCP Gateway Dashboard
    # =========================================================================
    - name: Create MCP Gateway Dashboard ConfigMap
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-dashboard-mcp-gateway
            namespace: "{{ grafana_namespace }}"
            labels:
              grafana_dashboard: "1"
          data:
            mcp-gateway.json: |
              {
                "annotations": {"list": []},
                "editable": true,
                "fiscalYearStartMonth": 0,
                "graphTooltip": 0,
                "id": null,
                "links": [],
                "panels": [
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                        "unit": "short"
                      }
                    },
                    "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
                    "id": 1,
                    "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "sum(rate(mcp_tool_invocations_total[5m]))", "refId": "A"}],
                    "title": "Tool Invocations/sec",
                    "type": "stat"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 100}, {"color": "red", "value": 500}]},
                        "unit": "ms"
                      }
                    },
                    "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
                    "id": 2,
                    "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "histogram_quantile(0.95, sum(rate(mcp_tool_duration_seconds_bucket[5m])) by (le)) * 1000", "refId": "A"}],
                    "title": "Tool Latency P95",
                    "type": "stat"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                        "unit": "short"
                      }
                    },
                    "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
                    "id": 3,
                    "options": {"colorMode": "value", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "count(mcp_tools_registered)", "refId": "A"}],
                    "title": "Registered Tools",
                    "type": "stat"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 1}, {"color": "red", "value": 5}]},
                        "unit": "percent"
                      }
                    },
                    "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0},
                    "id": 4,
                    "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "100 * sum(rate(mcp_tool_invocations_total{status=\"error\"}[5m])) / (sum(rate(mcp_tool_invocations_total[5m])) or vector(1))", "refId": "A"}],
                    "title": "Error Rate",
                    "type": "stat"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {"axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                        "unit": "short"
                      }
                    },
                    "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
                    "id": 5,
                    "options": {"legend": {"calcs": ["mean", "sum"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "none"}},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "sum(rate(mcp_tool_invocations_total[1m])) by (tool)", "legendFormat": "{{tool}}", "refId": "A"}],
                    "title": "Invocations by Tool",
                    "type": "timeseries"
                  },
                  {
                    "datasource": {"type": "prometheus", "uid": "prometheus"},
                    "fieldConfig": {
                      "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {"axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
                        "mappings": [],
                        "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
                        "unit": "short"
                      }
                    },
                    "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
                    "id": 6,
                    "options": {"legend": {"calcs": ["mean", "sum"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "none"}},
                    "pluginVersion": "10.0.0",
                    "targets": [{"expr": "sum(rate(mcp_tool_invocations_total[1m])) by (category)", "legendFormat": "{{category}}", "refId": "A"}],
                    "title": "Invocations by Category",
                    "type": "timeseries"
                  }
                ],
                "refresh": "30s",
                "schemaVersion": 38,
                "tags": ["mcp", "tools", "ai"],
                "templating": {"list": []},
                "time": {"from": "now-1h", "to": "now"},
                "timepicker": {},
                "timezone": "browser",
                "title": "MCP Gateway",
                "uid": "mcp-gateway",
                "version": 1,
                "weekStart": ""
              }
      when: use_k8s_module

    # =========================================================================
    # Cleanup temp directory
    # =========================================================================
    - name: Cleanup temp directory
      ansible.builtin.file:
        path: "{{ dashboard_temp_dir }}"
        state: absent
      when: not use_k8s_module

    # =========================================================================
    # Restart Grafana to pick up new dashboards (optional)
    # =========================================================================
    - name: Restart Grafana to load new dashboards
      kubernetes.core.k8s:
        state: present
        api_version: v1
        kind: Pod
        namespace: "{{ grafana_namespace }}"
        name: "{{ item }}"
        delete_options:
          gracePeriodSeconds: 30
      loop: "{{ grafana_pods.resources | map(attribute='metadata.name') | list }}"
      vars:
        grafana_pods:
          resources: []
      when: false  # Skip restart - dashboards load via sidecar

    - name: Summary
      debug:
        msg: |
          ========================================
          Grafana Dashboards Configured
          ========================================

          Created dashboards:
          - STOA Platform - SLO Overview
          - webMethods API Gateway
          - Redpanda Cluster
          - MCP Gateway

          The dashboards will be automatically loaded
          by the Grafana sidecar within 1-2 minutes.

          Access Grafana at:
          https://grafana.stoa.cab-i.com
          ========================================
