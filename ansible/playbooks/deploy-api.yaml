---
# Playbook: Deploy API to webMethods Gateway
# Triggered by Kafka event from Control-Plane API
#
# Authentication modes:
#   1. OIDC (recommended): Uses Gateway-Admin-API proxy with Keycloak JWT
#   2. Basic Auth (fallback): Direct Gateway access with admin credentials
#
# Required extra_vars:
#   - api_name: Name of the API
#   - openapi_spec: URL to OpenAPI specification
#
# Optional extra_vars:
#   - api_version: API version (default: 1.0)
#   - tenant_id: Tenant identifier (default: default)
#   - use_oidc: Use OIDC authentication (default: true)
#   - keycloak_url: Keycloak URL for token (default: internal K8s service)
#   - client_id: Keycloak client ID (default: awx-automation)
#   - client_secret: Keycloak client secret (required for OIDC)
#   - gateway_proxy_url: Gateway Admin API proxy URL (default: internal K8s service)
#   - gateway_url: Direct Gateway URL for Basic Auth fallback
#   - gateway_user: Gateway admin username for Basic Auth
#   - gateway_password: Gateway admin password for Basic Auth

- name: Deploy API to Gateway
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Authentication mode
    _use_oidc: true
    use_oidc_mode: "{{ use_oidc | default(_use_oidc) | bool }}"

    # OIDC configuration defaults (use external HTTPS URLs for proper SSL)
    _keycloak_url: "https://auth.apim.cab-i.com"
    _client_id: "awx-automation"
    _client_secret: ""
    _gateway_proxy_url: "https://api.apim.cab-i.com/v1/gateway"

    # Basic Auth fallback defaults
    _gateway_url: "http://apigateway.apim-system.svc.cluster.local:5555"
    _gateway_user: "Administrator"
    _gateway_password: "manage"

    # API configuration defaults
    _api_name: "test-api"
    _api_version: "1.0"
    _tenant_id: "default"
    _openapi_spec: ""

    # Final values (use extra_vars or defaults)
    kc_url: "{{ keycloak_url | default(_keycloak_url) }}"
    kc_client_id: "{{ client_id | default(_client_id) }}"
    kc_client_secret: "{{ client_secret | default(_client_secret) }}"
    gw_proxy_url: "{{ gateway_proxy_url | default(_gateway_proxy_url) }}"
    gw_url: "{{ gateway_url | default(_gateway_url) }}"
    gw_user: "{{ gateway_user | default(_gateway_user) }}"
    gw_password: "{{ gateway_password | default(_gateway_password) }}"
    api: "{{ api_name | default(_api_name) }}"
    version: "{{ api_version | default(_api_version) }}"
    tenant: "{{ tenant_id | default(_tenant_id) }}"
    spec_url: "{{ openapi_spec | default(_openapi_spec) }}"

  tasks:
    - name: Display deployment info
      debug:
        msg: |
          Deploying API '{{ api }}' v{{ version }} for tenant '{{ tenant }}'
          Authentication mode: {{ 'OIDC (proxy)' if use_oidc_mode else 'Basic Auth (direct)' }}

    # ========================================
    # OIDC Authentication Mode
    # ========================================
    - name: Get OIDC access token from Keycloak
      uri:
        url: "{{ kc_url }}/realms/apim/protocol/openid-connect/token"
        method: POST
        body_format: form-urlencoded
        body:
          grant_type: client_credentials
          client_id: "{{ kc_client_id }}"
          client_secret: "{{ kc_client_secret }}"
        status_code: [200]
        validate_certs: false
      register: token_response
      when:
        - use_oidc_mode
        - kc_client_secret | length > 0

    - name: Set access token
      set_fact:
        access_token: "{{ token_response.json.access_token }}"
      when:
        - use_oidc_mode
        - token_response is defined
        - token_response.json is defined

    - name: Check Gateway health via OIDC proxy
      uri:
        url: "{{ gw_proxy_url }}/health"
        method: GET
        headers:
          Authorization: "Bearer {{ access_token }}"
        validate_certs: false
        status_code: [200]
      register: health_check_oidc
      ignore_errors: true
      when:
        - use_oidc_mode
        - access_token is defined

    # Fetch OpenAPI spec first (Gateway URL import often fails due to network restrictions)
    - name: Fetch OpenAPI specification
      uri:
        url: "{{ spec_url }}"
        method: GET
        return_content: yes
        validate_certs: false
        status_code: [200]
      register: openapi_spec_content
      when:
        - use_oidc_mode
        - access_token is defined
        - spec_url | length > 0

    # Convert OpenAPI 3.1.x to 3.0.0 (Gateway may not support 3.1.0)
    - name: Detect OpenAPI version and type
      set_fact:
        openapi_version: "{{ openapi_spec_content.json.openapi | default(openapi_spec_content.json.swagger | default('2.0')) }}"
        api_spec_type: "{{ 'swagger' if openapi_spec_content.json.swagger is defined else 'openapi' }}"
      when:
        - openapi_spec_content is defined
        - openapi_spec_content.json is defined

    - name: Convert OpenAPI 3.1.x to 3.0.0 if needed
      set_fact:
        converted_spec: "{{ openapi_spec_content.json | combine({'openapi': '3.0.0'}) }}"
      when:
        - openapi_version is defined
        - openapi_version is version('3.1.0', '>=')

    - name: Use original spec if no conversion needed
      set_fact:
        converted_spec: "{{ openapi_spec_content.json }}"
      when:
        - openapi_spec_content is defined
        - openapi_spec_content.json is defined
        - converted_spec is not defined

    - name: Import API via OIDC proxy (with inline spec)
      uri:
        url: "{{ gw_proxy_url }}/apis"
        method: POST
        headers:
          Authorization: "Bearer {{ access_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          apiName: "{{ api }}"
          apiVersion: "{{ version }}"
          type: "{{ api_spec_type | default('openapi') }}"
          apiDefinition: "{{ converted_spec }}"
        status_code: [200, 201, 400]
        validate_certs: false
      register: api_import_oidc
      when:
        - use_oidc_mode
        - access_token is defined
        - converted_spec is defined

    # Extract API ID from response (proxy returns api_id, direct Gateway returns apiResponse.api.id)
    - name: Extract API ID from OIDC import response
      set_fact:
        imported_api_id: "{{ api_import_oidc.json.api_id | default(api_import_oidc.json.apiResponse.api.id | default('')) }}"
      when:
        - use_oidc_mode
        - api_import_oidc is defined
        - api_import_oidc.json is defined

    - name: Activate API via OIDC proxy
      uri:
        url: "{{ gw_proxy_url }}/apis/{{ imported_api_id }}/activate"
        method: PUT
        headers:
          Authorization: "Bearer {{ access_token }}"
        status_code: [200, 204]
        validate_certs: false
      when:
        - use_oidc_mode
        - access_token is defined
        - imported_api_id is defined
        - imported_api_id | length > 0
      register: api_activate_oidc

    # ========================================
    # Basic Auth Fallback Mode
    # ========================================
    - name: Check Gateway health via Basic Auth
      uri:
        url: "{{ gw_url }}/rest/apigateway/health"
        method: GET
        user: "{{ gw_user }}"
        password: "{{ gw_password }}"
        force_basic_auth: true
        validate_certs: false
        status_code: [200, 401]
      register: health_check_basic
      ignore_errors: true
      when: not use_oidc_mode or (access_token is not defined)

    - name: Fail if Gateway unreachable
      fail:
        msg: "Gateway is not reachable"
      when:
        - not use_oidc_mode or (access_token is not defined)
        - health_check_basic.failed | default(false)

    # Fetch OpenAPI spec first for Basic Auth mode
    - name: Fetch OpenAPI specification (Basic Auth mode)
      uri:
        url: "{{ spec_url }}"
        method: GET
        return_content: yes
        validate_certs: false
        status_code: [200]
      register: openapi_spec_content_basic
      when:
        - not use_oidc_mode or (access_token is not defined)
        - spec_url | length > 0

    - name: Import API via Basic Auth (with inline spec)
      uri:
        url: "{{ gw_url }}/rest/apigateway/apis"
        method: POST
        user: "{{ gw_user }}"
        password: "{{ gw_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          apiName: "{{ api }}"
          apiVersion: "{{ version }}"
          type: "openapi"
          apiDefinition: "{{ openapi_spec_content_basic.json }}"
        status_code: [200, 201, 400]
      register: api_import_basic
      when:
        - not use_oidc_mode or (access_token is not defined)
        - openapi_spec_content_basic is defined
        - openapi_spec_content_basic.json is defined

    - name: Activate API via Basic Auth
      uri:
        url: "{{ gw_url }}/rest/apigateway/apis/{{ api_import_basic.json.apiResponse.api.id }}/activate"
        method: PUT
        user: "{{ gw_user }}"
        password: "{{ gw_password }}"
        force_basic_auth: true
        validate_certs: false
        status_code: [200, 204]
      when:
        - not use_oidc_mode or (access_token is not defined)
        - api_import_basic is defined
        - api_import_basic.json.apiResponse.api.id is defined
      register: api_activate_basic

    # ========================================
    # Common tasks
    # ========================================
    - name: Set API import result
      set_fact:
        api_import: "{{ api_import_oidc if (api_import_oidc is defined and api_import_oidc.json is defined) else api_import_basic }}"

    # Extract final API ID (handles both proxy and direct responses)
    - name: Set final API ID
      set_fact:
        final_api_id: "{{ imported_api_id | default(api_import.json.api_id | default(api_import.json.apiResponse.api.id | default(''))) }}"
      when: api_import is defined

    - name: Display API import result
      debug:
        msg: |
          Import Result:
          - API ID: {{ final_api_id | default('N/A') }}
          - Response: {{ api_import.json | default({}) }}
      when: api_import is defined

    - name: Send success notification to Control-Plane API
      uri:
        url: "http://control-plane-api.apim-system.svc.cluster.local:8000/v1/events/deployment-result"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          api_name: "{{ api }}"
          api_version: "{{ version }}"
          api_id: "{{ final_api_id | default('') }}"
          tenant_id: "{{ tenant }}"
          status: "success"
          action: "deploy"
          message: "API deployed successfully via {{ 'OIDC proxy' if (use_oidc_mode and access_token is defined) else 'Basic Auth' }}"
        status_code: [200, 201, 202]
        validate_certs: false
      ignore_errors: true

    - name: Deployment summary
      debug:
        msg: |
          ========================================
          API Deployment Complete
          ----------------------------------------
          API: {{ api }} v{{ version }}
          Tenant: {{ tenant }}
          API ID: {{ final_api_id | default('N/A') }}
          Auth Mode: {{ 'OIDC (proxy)' if (use_oidc_mode and access_token is defined) else 'Basic Auth (direct)' }}
          Status: SUCCESS
          ========================================
