---
# Ansible Playbook: Deploy Subscriptions Database (CAB-247)
# Deploys PostgreSQL database and runs Alembic migrations for the subscriptions system
#
# Usage:
#   ansible-playbook -i inventory/hosts deploy-subscriptions-db.yaml
#   ansible-playbook -i inventory/hosts deploy-subscriptions-db.yaml --tags "database"
#   ansible-playbook -i inventory/hosts deploy-subscriptions-db.yaml --tags "migrations"
#
# Variables:
#   - k8s_namespace: Target namespace (default: stoa-system)
#   - db_password: PostgreSQL password (should be from vault)
#   - run_migrations: Whether to run Alembic migrations (default: true)
#   - wait_timeout: Timeout for waiting on resources (default: 300)

- name: Deploy Subscriptions Database
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    k8s_namespace: "{{ lookup('env', 'K8S_NAMESPACE') | default('stoa-system', true) }}"
    db_user: "{{ lookup('env', 'DB_USER') | default('stoa', true) }}"
    db_password: "{{ lookup('env', 'DB_PASSWORD') | default('stoa-db-password-2026', true) }}"
    db_name: "{{ lookup('env', 'DB_NAME') | default('stoa', true) }}"
    db_storage_size: "{{ lookup('env', 'DB_STORAGE_SIZE') | default('10Gi', true) }}"
    db_storage_class: "{{ lookup('env', 'DB_STORAGE_CLASS') | default('gp2', true) }}"
    run_migrations: "{{ lookup('env', 'RUN_MIGRATIONS') | default('true', true) | bool }}"
    wait_timeout: "{{ lookup('env', 'WAIT_TIMEOUT') | default(300, true) | int }}"
    deploy_dir: "{{ playbook_dir }}/../../deploy/database"

  tasks:
    # =========================================================================
    # Pre-flight Checks
    # =========================================================================
    - name: Verify kubectl is available
      command: kubectl version --client
      register: kubectl_version
      changed_when: false
      tags: [always]

    - name: Check if namespace exists
      command: kubectl get namespace {{ k8s_namespace }}
      register: ns_check
      changed_when: false
      failed_when: false
      tags: [always]

    - name: Create namespace if it doesn't exist
      command: kubectl create namespace {{ k8s_namespace }}
      when: ns_check.rc != 0
      tags: [always]

    # =========================================================================
    # Database Secret
    # =========================================================================
    - name: Check if database secret exists
      command: kubectl get secret control-plane-db-secret -n {{ k8s_namespace }}
      register: secret_check
      changed_when: false
      failed_when: false
      tags: [database, secret]

    - name: Create database secret
      shell: |
        kubectl create secret generic control-plane-db-secret \
          --from-literal=POSTGRES_USER={{ db_user }} \
          --from-literal=POSTGRES_PASSWORD={{ db_password }} \
          --from-literal=POSTGRES_DB={{ db_name }} \
          -n {{ k8s_namespace }} \
          --dry-run=client -o yaml | kubectl apply -f -
      when: secret_check.rc != 0 or update_secret | default(false) | bool
      tags: [database, secret]

    # =========================================================================
    # Database ConfigMap (Init Scripts)
    # =========================================================================
    - name: Apply database init ConfigMap
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: control-plane-db-init
          namespace: {{ k8s_namespace }}
          labels:
            app: control-plane-db
        data:
          init.sql: |
            -- Create extensions
            CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
            -- Grant permissions
            GRANT ALL PRIVILEGES ON DATABASE {{ db_name }} TO {{ db_user }};
        EOF
      tags: [database, configmap]

    # =========================================================================
    # Database Service
    # =========================================================================
    - name: Apply database Service
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: Service
        metadata:
          name: control-plane-db
          namespace: {{ k8s_namespace }}
          labels:
            app: control-plane-db
        spec:
          type: ClusterIP
          ports:
            - port: 5432
              targetPort: 5432
              name: postgres
          selector:
            app: control-plane-db
        EOF
      tags: [database, service]

    # =========================================================================
    # Database StatefulSet
    # =========================================================================
    - name: Apply database StatefulSet
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: apps/v1
        kind: StatefulSet
        metadata:
          name: control-plane-db
          namespace: {{ k8s_namespace }}
          labels:
            app: control-plane-db
        spec:
          serviceName: control-plane-db
          replicas: 1
          selector:
            matchLabels:
              app: control-plane-db
          template:
            metadata:
              labels:
                app: control-plane-db
            spec:
              containers:
                - name: postgres
                  image: postgres:15-alpine
                  ports:
                    - containerPort: 5432
                      name: postgres
                  envFrom:
                    - secretRef:
                        name: control-plane-db-secret
                  env:
                    - name: PGDATA
                      value: /var/lib/postgresql/data/pgdata
                  volumeMounts:
                    - name: data
                      mountPath: /var/lib/postgresql/data
                    - name: init-scripts
                      mountPath: /docker-entrypoint-initdb.d
                  resources:
                    requests:
                      cpu: 100m
                      memory: 256Mi
                    limits:
                      cpu: 500m
                      memory: 512Mi
                  livenessProbe:
                    exec:
                      command:
                        - pg_isready
                        - -U
                        - {{ db_user }}
                    initialDelaySeconds: 30
                    periodSeconds: 10
                  readinessProbe:
                    exec:
                      command:
                        - pg_isready
                        - -U
                        - {{ db_user }}
                    initialDelaySeconds: 5
                    periodSeconds: 5
              volumes:
                - name: init-scripts
                  configMap:
                    name: control-plane-db-init
          volumeClaimTemplates:
            - metadata:
                name: data
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: {{ db_storage_size }}
                storageClassName: {{ db_storage_class }}
        EOF
      tags: [database, statefulset]

    # =========================================================================
    # Wait for Database
    # =========================================================================
    - name: Wait for database pod to be ready
      command: >
        kubectl wait --for=condition=ready pod/control-plane-db-0
        -n {{ k8s_namespace }}
        --timeout={{ wait_timeout }}s
      register: db_wait
      retries: 3
      delay: 10
      until: db_wait.rc == 0
      tags: [database, wait]

    - name: Verify database connectivity
      shell: |
        kubectl exec control-plane-db-0 -n {{ k8s_namespace }} -- \
          pg_isready -U {{ db_user }} -d {{ db_name }}
      register: db_ready
      retries: 5
      delay: 5
      until: db_ready.rc == 0
      tags: [database, verify]

    # =========================================================================
    # Alembic Migrations
    # =========================================================================
    - name: Delete previous migration job if exists
      command: kubectl delete job alembic-migration -n {{ k8s_namespace }} --ignore-not-found
      when: run_migrations
      tags: [migrations]

    - name: Run Alembic migrations
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: alembic-migration
          namespace: {{ k8s_namespace }}
          labels:
            app: alembic-migration
        spec:
          ttlSecondsAfterFinished: 300
          template:
            spec:
              restartPolicy: Never
              containers:
                - name: migration
                  image: python:3.11-slim
                  command:
                    - /bin/bash
                    - -c
                    - |
                      set -e
                      echo "Installing dependencies..."
                      pip install --quiet sqlalchemy psycopg2-binary alembic

                      echo "Creating migration files..."
                      mkdir -p /app/alembic/versions
                      cd /app

                      # Create alembic.ini
                      cat > alembic.ini <<'ALEMBIC_INI'
                      [alembic]
                      script_location = alembic
                      prepend_sys_path = .
                      sqlalchemy.url = %(DATABASE_URL)s

                      [loggers]
                      keys = root,sqlalchemy,alembic

                      [handlers]
                      keys = console

                      [formatters]
                      keys = generic

                      [logger_root]
                      level = WARN
                      handlers = console

                      [logger_sqlalchemy]
                      level = WARN
                      handlers =
                      qualname = sqlalchemy.engine

                      [logger_alembic]
                      level = INFO
                      handlers =
                      qualname = alembic

                      [handler_console]
                      class = StreamHandler
                      args = (sys.stderr,)
                      level = NOTSET
                      formatter = generic

                      [formatter_generic]
                      format = %(levelname)-5.5s [%(name)s] %(message)s
                      ALEMBIC_INI

                      # Create env.py
                      cat > alembic/env.py <<'ENVPY'
                      from logging.config import fileConfig
                      from sqlalchemy import engine_from_config, pool
                      from alembic import context
                      import os

                      config = context.config
                      config.set_main_option("sqlalchemy.url", os.environ.get("DATABASE_URL", "").replace("+asyncpg", ""))

                      if config.config_file_name is not None:
                          fileConfig(config.config_file_name)

                      target_metadata = None

                      def run_migrations_online():
                          connectable = engine_from_config(
                              config.get_section(config.config_ini_section, {}),
                              prefix="sqlalchemy.",
                              poolclass=pool.NullPool,
                          )
                          with connectable.connect() as connection:
                              context.configure(connection=connection, target_metadata=target_metadata)
                              with context.begin_transaction():
                                  context.run_migrations()

                      run_migrations_online()
                      ENVPY

                      # Create migration script
                      cat > alembic/versions/001_create_subscriptions_table.py <<'MIGRATION'
                      """create subscriptions table

                      Revision ID: 001
                      Revises:
                      Create Date: 2026-01-07
                      """
                      from alembic import op
                      import sqlalchemy as sa
                      from sqlalchemy.dialects import postgresql

                      revision = '001'
                      down_revision = None
                      branch_labels = None
                      depends_on = None

                      def upgrade():
                          op.create_table(
                              'subscriptions',
                              sa.Column('id', postgresql.UUID(as_uuid=True), nullable=False),
                              sa.Column('application_id', sa.String(255), nullable=False),
                              sa.Column('application_name', sa.String(255), nullable=False),
                              sa.Column('subscriber_id', sa.String(255), nullable=False),
                              sa.Column('subscriber_email', sa.String(255), nullable=False),
                              sa.Column('api_id', sa.String(255), nullable=False),
                              sa.Column('api_name', sa.String(255), nullable=False),
                              sa.Column('api_version', sa.String(50), nullable=False),
                              sa.Column('tenant_id', sa.String(255), nullable=False),
                              sa.Column('plan_id', sa.String(255), nullable=True),
                              sa.Column('plan_name', sa.String(255), nullable=True),
                              sa.Column('api_key_hash', sa.String(512), nullable=False),
                              sa.Column('api_key_prefix', sa.String(10), nullable=False),
                              sa.Column('status', sa.Enum('pending', 'active', 'suspended', 'revoked', 'expired', name='subscriptionstatus'), nullable=False),
                              sa.Column('status_reason', sa.Text(), nullable=True),
                              sa.Column('created_at', sa.DateTime(), nullable=False),
                              sa.Column('updated_at', sa.DateTime(), nullable=False),
                              sa.Column('approved_at', sa.DateTime(), nullable=True),
                              sa.Column('expires_at', sa.DateTime(), nullable=True),
                              sa.Column('revoked_at', sa.DateTime(), nullable=True),
                              sa.Column('approved_by', sa.String(255), nullable=True),
                              sa.Column('revoked_by', sa.String(255), nullable=True),
                              sa.PrimaryKeyConstraint('id'),
                              sa.UniqueConstraint('api_key_hash')
                          )
                          op.create_index('ix_subscriptions_application_id', 'subscriptions', ['application_id'])
                          op.create_index('ix_subscriptions_subscriber_id', 'subscriptions', ['subscriber_id'])
                          op.create_index('ix_subscriptions_api_id', 'subscriptions', ['api_id'])
                          op.create_index('ix_subscriptions_tenant_id', 'subscriptions', ['tenant_id'])
                          op.create_index('ix_subscriptions_tenant_api', 'subscriptions', ['tenant_id', 'api_id'])
                          op.create_index('ix_subscriptions_subscriber_status', 'subscriptions', ['subscriber_id', 'status'])
                          op.create_index('ix_subscriptions_application_api', 'subscriptions', ['application_id', 'api_id'])

                      def downgrade():
                          op.drop_index('ix_subscriptions_application_api', 'subscriptions')
                          op.drop_index('ix_subscriptions_subscriber_status', 'subscriptions')
                          op.drop_index('ix_subscriptions_tenant_api', 'subscriptions')
                          op.drop_index('ix_subscriptions_tenant_id', 'subscriptions')
                          op.drop_index('ix_subscriptions_api_id', 'subscriptions')
                          op.drop_index('ix_subscriptions_subscriber_id', 'subscriptions')
                          op.drop_index('ix_subscriptions_application_id', 'subscriptions')
                          op.drop_table('subscriptions')
                          op.execute('DROP TYPE IF EXISTS subscriptionstatus')
                      MIGRATION

                      # Create script.py.mako
                      cat > alembic/script.py.mako <<'MAKO'
                      """empty message

                      Revision ID: ${up_revision}
                      Revises: ${down_revision | comma,n}
                      Create Date: ${create_date}
                      """
                      from alembic import op
                      import sqlalchemy as sa
                      ${imports if imports else ""}

                      revision = ${repr(up_revision)}
                      down_revision = ${repr(down_revision)}
                      branch_labels = ${repr(branch_labels)}
                      depends_on = ${repr(depends_on)}

                      def upgrade():
                          ${upgrades if upgrades else "pass"}

                      def downgrade():
                          ${downgrades if downgrades else "pass"}
                      MAKO

                      echo "Running migration..."
                      alembic upgrade head

                      echo "Migration completed!"
                      alembic current
                  env:
                    - name: DATABASE_URL
                      value: "postgresql://{{ db_user }}:{{ db_password }}@control-plane-db.{{ k8s_namespace }}.svc.cluster.local:5432/{{ db_name }}"
        EOF
      when: run_migrations
      tags: [migrations]

    - name: Wait for migration job to complete
      command: >
        kubectl wait --for=condition=complete job/alembic-migration
        -n {{ k8s_namespace }}
        --timeout={{ wait_timeout }}s
      register: migration_wait
      when: run_migrations
      tags: [migrations, wait]

    - name: Get migration logs
      command: kubectl logs job/alembic-migration -n {{ k8s_namespace }}
      register: migration_logs
      when: run_migrations
      tags: [migrations]

    - name: Display migration results
      debug:
        msg: "{{ migration_logs.stdout_lines }}"
      when: run_migrations
      tags: [migrations]

    # =========================================================================
    # Update Control-Plane-API
    # =========================================================================
    - name: Check if control-plane-api deployment exists
      command: kubectl get deployment control-plane-api -n {{ k8s_namespace }}
      register: api_deployment_check
      changed_when: false
      failed_when: false
      tags: [api, update]

    - name: Set DATABASE_URL on control-plane-api
      command: >
        kubectl set env deployment/control-plane-api
        -n {{ k8s_namespace }}
        DATABASE_URL=postgresql+asyncpg://{{ db_user }}:{{ db_password }}@control-plane-db.{{ k8s_namespace }}.svc.cluster.local:5432/{{ db_name }}
      when: api_deployment_check.rc == 0
      tags: [api, update]

    - name: Restart control-plane-api deployment
      command: kubectl rollout restart deployment/control-plane-api -n {{ k8s_namespace }}
      when: api_deployment_check.rc == 0
      tags: [api, update]

    - name: Wait for control-plane-api rollout
      command: >
        kubectl rollout status deployment/control-plane-api
        -n {{ k8s_namespace }}
        --timeout={{ wait_timeout }}s
      when: api_deployment_check.rc == 0
      tags: [api, update, wait]

    # =========================================================================
    # Summary
    # =========================================================================
    - name: Get database status
      command: kubectl get statefulset control-plane-db -n {{ k8s_namespace }} -o wide
      register: db_status
      changed_when: false
      tags: [always]

    - name: Display deployment summary
      debug:
        msg:
          - "=========================================="
          - "Subscriptions Database Deployment Complete"
          - "=========================================="
          - "Namespace: {{ k8s_namespace }}"
          - "Database: control-plane-db"
          - "Service: control-plane-db.{{ k8s_namespace }}.svc.cluster.local:5432"
          - "User: {{ db_user }}"
          - "Database Name: {{ db_name }}"
          - "Migrations: {{ 'Completed' if run_migrations else 'Skipped' }}"
          - ""
          - "Database Status:"
          - "{{ db_status.stdout }}"
      tags: [always]
