---
# Playbook: Rotate Credentials in Vault and Gateway
# Generates new credentials and updates both Vault and Gateway aliases
#
# Authentication:
#   - Vault: Kubernetes auth (service account) or AppRole
#   - Gateway: OIDC proxy (recommended) or Basic Auth
#   - Keycloak: Admin API for OAuth client rotation
#
# Required extra_vars:
#   - secret_path: Vault secret path to rotate (e.g., stoa/dev/aliases/backend-api)
#   - rotation_type: Type of rotation (password, api_key, oauth_client)
#
# Optional extra_vars:
#   - password_length: Length for generated passwords (default: 32)
#   - api_key_length: Length for generated API keys (default: 64)
#   - update_gateway: Also update Gateway alias (default: true)
#   - notify_callback: URL to notify after rotation
#   - dry_run: Preview changes without applying (default: false)

- name: Rotate Credentials
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Vault configuration
    _vault_addr: "http://vault.vault.svc.cluster.local:8200"
    _vault_role: "awx-admin"

    # Gateway configuration
    _gateway_proxy_url: "https://api.stoa.cab-i.com/v1/gateway"
    _keycloak_url: "https://auth.stoa.cab-i.com"
    _keycloak_realm: "stoa"
    _client_id: "awx-automation"
    _client_secret: ""

    # Rotation configuration
    _secret_path: ""
    _rotation_type: "password"
    _password_length: 32
    _api_key_length: 64
    _update_gateway: true
    _dry_run: false

    # Final values
    vault_url: "{{ vault_addr | default(_vault_addr) }}"
    vault_k8s_role: "{{ vault_role | default(_vault_role) }}"
    gw_proxy_url: "{{ gateway_proxy_url | default(_gateway_proxy_url) }}"
    kc_url: "{{ keycloak_url | default(_keycloak_url) }}"
    kc_realm: "{{ keycloak_realm | default(_keycloak_realm) }}"
    kc_client_id: "{{ client_id | default(_client_id) }}"
    kc_client_secret: "{{ client_secret | default(_client_secret) }}"
    secret: "{{ secret_path | default(_secret_path) }}"
    rot_type: "{{ rotation_type | default(_rotation_type) }}"
    pwd_length: "{{ password_length | default(_password_length) | int }}"
    key_length: "{{ api_key_length | default(_api_key_length) | int }}"
    update_gw: "{{ update_gateway | default(_update_gateway) | bool }}"
    dry_run_mode: "{{ dry_run | default(_dry_run) | bool }}"

  tasks:
    - name: Validate required parameters
      fail:
        msg: "secret_path is required"
      when: secret | length == 0

    - name: Display rotation info
      debug:
        msg: |
          Credential Rotation
          ====================
          Secret Path: {{ secret }}
          Rotation Type: {{ rot_type }}
          Update Gateway: {{ update_gw }}
          Dry Run: {{ dry_run_mode }}

    # ========================================
    # Vault Authentication
    # ========================================
    - name: Get Kubernetes service account token
      slurp:
        src: /var/run/secrets/kubernetes.io/serviceaccount/token
      register: k8s_token
      ignore_errors: true

    - name: Authenticate to Vault with Kubernetes
      uri:
        url: "{{ vault_url }}/v1/auth/kubernetes/login"
        method: POST
        body_format: json
        body:
          role: "{{ vault_k8s_role }}"
          jwt: "{{ k8s_token.content | b64decode }}"
        status_code: [200]
        validate_certs: false
      register: vault_auth
      when: k8s_token is defined and k8s_token.content is defined

    - name: Set Vault token
      set_fact:
        vault_token: "{{ vault_auth.json.auth.client_token }}"
      when: vault_auth is defined and vault_auth.json is defined

    # ========================================
    # Read Current Secret
    # ========================================
    - name: Read current secret from Vault
      uri:
        url: "{{ vault_url }}/v1/secret/data/{{ secret }}"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: [200]
        validate_certs: false
      register: current_secret
      when: vault_token is defined

    - name: Store current secret data
      set_fact:
        secret_data: "{{ current_secret.json.data.data }}"
        secret_version: "{{ current_secret.json.data.metadata.version }}"
      when: current_secret is defined and current_secret.json is defined

    # ========================================
    # Generate New Credentials
    # ========================================
    - name: Generate new password
      set_fact:
        new_password: "{{ lookup('password', '/dev/null length=' + pwd_length | string + ' chars=ascii_letters,digits,punctuation') }}"
      when: rot_type == 'password'

    - name: Generate new API key
      set_fact:
        new_api_key: "{{ lookup('password', '/dev/null length=' + key_length | string + ' chars=ascii_letters,digits') }}"
      when: rot_type == 'api_key'

    # ========================================
    # Password Rotation
    # ========================================
    - name: Prepare updated secret (password)
      set_fact:
        updated_secret: "{{ secret_data | combine({'password': new_password, 'rotated_at': ansible_date_time.iso8601 | default(lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ'))}) }}"
      when: rot_type == 'password' and not dry_run_mode

    # ========================================
    # API Key Rotation
    # ========================================
    - name: Prepare updated secret (api_key)
      set_fact:
        updated_secret: "{{ secret_data | combine({'api_key': new_api_key, 'rotated_at': ansible_date_time.iso8601 | default(lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ'))}) }}"
      when: rot_type == 'api_key' and not dry_run_mode

    # ========================================
    # OAuth Client Secret Rotation (Keycloak)
    # ========================================
    - name: Get Keycloak admin token
      uri:
        url: "{{ kc_url }}/realms/master/protocol/openid-connect/token"
        method: POST
        body_format: form-urlencoded
        body:
          grant_type: client_credentials
          client_id: admin-cli
          client_secret: "{{ keycloak_admin_secret | default('') }}"
        status_code: [200]
        validate_certs: false
      register: kc_admin_token
      when:
        - rot_type == 'oauth_client'
        - keycloak_admin_secret is defined

    - name: Get Keycloak client by client_id
      uri:
        url: "{{ kc_url }}/admin/realms/{{ kc_realm }}/clients?clientId={{ secret_data.client_id }}"
        method: GET
        headers:
          Authorization: "Bearer {{ kc_admin_token.json.access_token }}"
        status_code: [200]
        validate_certs: false
      register: kc_client
      when:
        - rot_type == 'oauth_client'
        - kc_admin_token is defined
        - secret_data.client_id is defined

    - name: Regenerate client secret in Keycloak
      uri:
        url: "{{ kc_url }}/admin/realms/{{ kc_realm }}/clients/{{ kc_client.json[0].id }}/client-secret"
        method: POST
        headers:
          Authorization: "Bearer {{ kc_admin_token.json.access_token }}"
        status_code: [200]
        validate_certs: false
      register: new_client_secret
      when:
        - rot_type == 'oauth_client'
        - kc_client is defined
        - kc_client.json | length > 0
        - not dry_run_mode

    - name: Prepare updated secret (oauth_client)
      set_fact:
        updated_secret: "{{ secret_data | combine({'client_secret': new_client_secret.json.value, 'rotated_at': ansible_date_time.iso8601 | default(lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ'))}) }}"
      when:
        - rot_type == 'oauth_client'
        - new_client_secret is defined
        - not dry_run_mode

    # ========================================
    # Update Vault
    # ========================================
    - name: Write updated secret to Vault
      uri:
        url: "{{ vault_url }}/v1/secret/data/{{ secret }}"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          data: "{{ updated_secret }}"
        status_code: [200]
        validate_certs: false
      register: vault_update
      when:
        - vault_token is defined
        - updated_secret is defined
        - not dry_run_mode

    # ========================================
    # Update Gateway Alias
    # ========================================
    - name: Get OIDC access token for Gateway
      uri:
        url: "{{ kc_url }}/realms/stoa/protocol/openid-connect/token"
        method: POST
        body_format: form-urlencoded
        body:
          grant_type: client_credentials
          client_id: "{{ kc_client_id }}"
          client_secret: "{{ kc_client_secret }}"
        status_code: [200]
        validate_certs: false
      register: gw_token_response
      when:
        - update_gw
        - kc_client_secret | length > 0
        - not dry_run_mode

    - name: Update Gateway alias with new credentials
      uri:
        url: "{{ gw_proxy_url }}/alias/{{ secret_data.alias_id }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ gw_token_response.json.access_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          id: "{{ secret_data.alias_id }}"
          name: "{{ secret_data.name }}"
          type: "endpoint"
          endPointURI: "{{ secret_data.endpoint_uri }}"
          httpAuthCredentials:
            authType: "{{ 'HTTP_BASIC' if rot_type == 'password' else ('API_KEY' if rot_type == 'api_key' else 'OAUTH2') }}"
            httpAuthCredentialsBasic: "{{ {'userName': secret_data.username, 'password': updated_secret.password} if rot_type == 'password' else omit }}"
            httpAuthCredentialsApiKey: "{{ {'apiKey': updated_secret.api_key} if rot_type == 'api_key' else omit }}"
            oauth2Credentials: "{{ {'clientId': secret_data.client_id, 'clientSecret': updated_secret.client_secret} if rot_type == 'oauth_client' else omit }}"
        status_code: [200, 204]
        validate_certs: false
      when:
        - update_gw
        - gw_token_response is defined
        - secret_data.alias_id is defined
        - not dry_run_mode

    # ========================================
    # Notification Callback
    # ========================================
    - name: Send rotation notification
      uri:
        url: "{{ notify_callback }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          event: "credential-rotated"
          secret_path: "{{ secret }}"
          rotation_type: "{{ rot_type }}"
          new_version: "{{ vault_update.json.data.version | default('') }}"
          timestamp: "{{ ansible_date_time.iso8601 | default(lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ')) }}"
        status_code: [200, 201, 202]
        validate_certs: false
      ignore_errors: true
      when:
        - notify_callback is defined
        - not dry_run_mode

    # ========================================
    # Dry Run Report
    # ========================================
    - name: Dry run - Show planned rotation
      debug:
        msg: |
          [DRY RUN] Would rotate credentials:
          Secret Path: {{ secret }}
          Rotation Type: {{ rot_type }}
          Current Version: {{ secret_version | default('N/A') }}
          {% if rot_type == 'password' %}
          New Password: {{ new_password[:4] }}****{{ new_password[-4:] }}
          {% elif rot_type == 'api_key' %}
          New API Key: {{ new_api_key[:8] }}****{{ new_api_key[-8:] }}
          {% elif rot_type == 'oauth_client' %}
          Client ID: {{ secret_data.client_id | default('N/A') }}
          Would regenerate client secret in Keycloak
          {% endif %}
          Update Gateway: {{ update_gw }}
      when: dry_run_mode

    # ========================================
    # Summary
    # ========================================
    - name: Rotation summary
      debug:
        msg: |
          ========================================
          Credential Rotation Complete
          ----------------------------------------
          Secret Path: {{ secret }}
          Rotation Type: {{ rot_type }}
          Previous Version: {{ secret_version | default('N/A') }}
          New Version: {{ vault_update.json.data.version | default('N/A') }}
          Gateway Updated: {{ update_gw and gw_token_response is defined }}
          Dry Run: {{ dry_run_mode }}
          ========================================
      when: not dry_run_mode
