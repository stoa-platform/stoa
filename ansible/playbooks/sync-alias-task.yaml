---
# Task file: Sync single alias to Gateway
# Called by sync-alias.yaml for each alias
#
# Variables from parent:
#   - alias_item: Vault alias data
#   - current_aliases: Map of alias name -> id
#   - gw_proxy_url: Gateway proxy URL
#   - access_token: OIDC token

- name: Extract alias data
  set_fact:
    alias_name: "{{ alias_item.json.data.data.name }}"
    alias_data: "{{ alias_item.json.data.data }}"

- name: Check if alias exists in Gateway
  set_fact:
    alias_exists: "{{ alias_name in current_aliases }}"
    existing_alias_id: "{{ current_aliases[alias_name] | default('') }}"

- name: Prepare alias payload
  set_fact:
    alias_payload:
      name: "{{ alias_data.name }}"
      description: "{{ alias_data.description | default('Synced from Vault') }}"
      type: "{{ alias_data.type | default('endpoint') }}"
      endPointURI: "{{ alias_data.endpoint_uri }}"
      connectionTimeout: "{{ alias_data.connection_timeout | default(30) }}"
      readTimeout: "{{ alias_data.read_timeout | default(60) }}"
      suspendDurationOnFailure: 0
      optimizationTechnique: "None"
      passSecurityHeaders: "{{ alias_data.pass_security_headers | default(true) }}"

- name: Add HTTP Basic Auth credentials if configured
  set_fact:
    alias_payload: "{{ alias_payload | combine({
      'httpAuthCredentials': {
        'authType': 'HTTP_BASIC',
        'httpAuthCredentialsBasic': {
          'userName': alias_data.username,
          'password': alias_data.password
        }
      }
    }) }}"
  when:
    - alias_data.auth_type is defined
    - alias_data.auth_type == 'basic'
    - alias_data.username is defined
    - alias_data.password is defined

- name: Add API Key auth if configured
  set_fact:
    alias_payload: "{{ alias_payload | combine({
      'httpAuthCredentials': {
        'authType': 'API_KEY',
        'httpAuthCredentialsApiKey': {
          'apiKey': alias_data.api_key,
          'httpHeaderOrQueryParam': alias_data.api_key_location | default('header'),
          'apiKeyName': alias_data.api_key_name | default('X-API-Key')
        }
      }
    }) }}"
  when:
    - alias_data.auth_type is defined
    - alias_data.auth_type == 'api_key'
    - alias_data.api_key is defined

- name: Add OAuth2 client credentials if configured
  set_fact:
    alias_payload: "{{ alias_payload | combine({
      'httpAuthCredentials': {
        'authType': 'OAUTH2',
        'oauth2Credentials': {
          'clientId': alias_data.client_id,
          'clientSecret': alias_data.client_secret,
          'tokenEndpoint': alias_data.token_endpoint,
          'grantType': 'client_credentials',
          'scopes': alias_data.scopes | default([])
        }
      }
    }) }}"
  when:
    - alias_data.auth_type is defined
    - alias_data.auth_type == 'oauth2'
    - alias_data.client_id is defined
    - alias_data.client_secret is defined

- name: Create new alias in Gateway
  uri:
    url: "{{ gw_proxy_url }}/alias"
    method: POST
    headers:
      Authorization: "Bearer {{ access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      alias: "{{ alias_payload }}"
    status_code: [200, 201]
    validate_certs: false
  register: create_result
  when: not alias_exists

- name: Update existing alias in Gateway
  uri:
    url: "{{ gw_proxy_url }}/alias/{{ existing_alias_id }}"
    method: PUT
    headers:
      Authorization: "Bearer {{ access_token }}"
      Content-Type: "application/json"
    body_format: json
    body: "{{ alias_payload | combine({'id': existing_alias_id}) }}"
    status_code: [200, 204]
    validate_certs: false
  register: update_result
  when: alias_exists

- name: Report alias sync status
  debug:
    msg: |
      Alias: {{ alias_name }}
      Action: {{ 'Updated' if alias_exists else 'Created' }}
      Endpoint: {{ alias_data.endpoint_uri }}
      Auth Type: {{ alias_data.auth_type | default('none') }}
