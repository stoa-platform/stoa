---
# Playbook: Sync Gateway Aliases with Vault Secrets
# Synchronizes backend endpoints and credentials from Vault to webMethods Gateway
#
# Authentication:
#   - Vault: Kubernetes auth (service account) or AppRole
#   - Gateway: OIDC proxy (recommended) or Basic Auth
#
# Required extra_vars:
#   - tenant_id: Tenant identifier
#   - environment: Environment (dev, staging, prod)
#
# Optional extra_vars:
#   - vault_addr: Vault address (default: internal K8s service)
#   - vault_role: Vault Kubernetes role (default: awx-admin)
#   - gateway_proxy_url: Gateway Admin API proxy URL
#   - dry_run: Preview changes without applying (default: false)

- name: Sync Gateway Aliases from Vault
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Vault configuration
    _vault_addr: "http://vault.vault.svc.cluster.local:8200"
    _vault_role: "awx-admin"
    _vault_auth_path: "kubernetes"

    # Gateway configuration
    _gateway_proxy_url: "https://api.apim.cab-i.com/v1/gateway"
    _keycloak_url: "https://auth.apim.cab-i.com"
    _client_id: "awx-automation"
    _client_secret: ""

    # Sync configuration
    _tenant_id: "default"
    _environment: "dev"
    _dry_run: false

    # Final values
    vault_url: "{{ vault_addr | default(_vault_addr) }}"
    vault_k8s_role: "{{ vault_role | default(_vault_role) }}"
    gw_proxy_url: "{{ gateway_proxy_url | default(_gateway_proxy_url) }}"
    kc_url: "{{ keycloak_url | default(_keycloak_url) }}"
    kc_client_id: "{{ client_id | default(_client_id) }}"
    kc_client_secret: "{{ client_secret | default(_client_secret) }}"
    tenant: "{{ tenant_id | default(_tenant_id) }}"
    env: "{{ environment | default(_environment) }}"
    dry_run_mode: "{{ dry_run | default(_dry_run) | bool }}"

  tasks:
    - name: Display sync info
      debug:
        msg: |
          Syncing Gateway Aliases
          ========================
          Tenant: {{ tenant }}
          Environment: {{ env }}
          Vault: {{ vault_url }}
          Gateway Proxy: {{ gw_proxy_url }}
          Dry Run: {{ dry_run_mode }}

    # ========================================
    # Vault Authentication
    # ========================================
    - name: Get Kubernetes service account token
      slurp:
        src: /var/run/secrets/kubernetes.io/serviceaccount/token
      register: k8s_token
      ignore_errors: true

    - name: Authenticate to Vault with Kubernetes
      uri:
        url: "{{ vault_url }}/v1/auth/{{ _vault_auth_path }}/login"
        method: POST
        body_format: json
        body:
          role: "{{ vault_k8s_role }}"
          jwt: "{{ k8s_token.content | b64decode }}"
        status_code: [200]
        validate_certs: false
      register: vault_auth
      when: k8s_token is defined and k8s_token.content is defined

    - name: Set Vault token
      set_fact:
        vault_token: "{{ vault_auth.json.auth.client_token }}"
      when: vault_auth is defined and vault_auth.json is defined

    # ========================================
    # Gateway OIDC Authentication
    # ========================================
    - name: Get OIDC access token from Keycloak
      uri:
        url: "{{ kc_url }}/realms/apim/protocol/openid-connect/token"
        method: POST
        body_format: form-urlencoded
        body:
          grant_type: client_credentials
          client_id: "{{ kc_client_id }}"
          client_secret: "{{ kc_client_secret }}"
        status_code: [200]
        validate_certs: false
      register: token_response
      when: kc_client_secret | length > 0

    - name: Set access token
      set_fact:
        access_token: "{{ token_response.json.access_token }}"
      when: token_response is defined and token_response.json is defined

    # ========================================
    # Read Aliases from Vault
    # ========================================
    - name: List aliases in Vault for environment
      uri:
        url: "{{ vault_url }}/v1/secret/metadata/apim/{{ env }}/aliases"
        method: LIST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: [200, 404]
        validate_certs: false
      register: vault_aliases_list
      when: vault_token is defined

    - name: Get alias details from Vault
      uri:
        url: "{{ vault_url }}/v1/secret/data/apim/{{ env }}/aliases/{{ item }}"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        status_code: [200]
        validate_certs: false
      register: vault_alias_details
      loop: "{{ vault_aliases_list.json.data.keys | default([]) }}"
      when:
        - vault_token is defined
        - vault_aliases_list.status == 200

    # ========================================
    # Get Current Gateway Aliases
    # ========================================
    - name: Get current aliases from Gateway
      uri:
        url: "{{ gw_proxy_url }}/alias"
        method: GET
        headers:
          Authorization: "Bearer {{ access_token }}"
        status_code: [200]
        validate_certs: false
      register: gateway_aliases
      when: access_token is defined

    - name: Build current alias map
      set_fact:
        current_aliases: "{{ gateway_aliases.json.alias | default([]) | items2dict(key_name='name', value_name='id') }}"
      when: gateway_aliases is defined

    # ========================================
    # Sync Aliases to Gateway
    # ========================================
    - name: Process each Vault alias
      include_tasks: sync-alias-task.yaml
      loop: "{{ vault_alias_details.results | default([]) }}"
      loop_control:
        loop_var: alias_item
      when:
        - vault_alias_details is defined
        - alias_item.json is defined
        - not dry_run_mode

    # ========================================
    # Dry Run Report
    # ========================================
    - name: Dry run - Show planned changes
      debug:
        msg: |
          [DRY RUN] Would sync the following aliases:
          {% for result in vault_alias_details.results | default([]) %}
          {% if result.json is defined %}
          - {{ result.json.data.data.name | default(result.item) }}
            Endpoint: {{ result.json.data.data.endpoint_uri | default('N/A') }}
            Auth Type: {{ result.json.data.data.auth_type | default('none') }}
          {% endif %}
          {% endfor %}
      when: dry_run_mode

    # ========================================
    # Summary
    # ========================================
    - name: Sync summary
      debug:
        msg: |
          ========================================
          Gateway Alias Sync Complete
          ----------------------------------------
          Tenant: {{ tenant }}
          Environment: {{ env }}
          Aliases in Vault: {{ vault_aliases_list.json.data.keys | default([]) | length }}
          Current Gateway Aliases: {{ current_aliases | default({}) | length }}
          Dry Run: {{ dry_run_mode }}
          ========================================
