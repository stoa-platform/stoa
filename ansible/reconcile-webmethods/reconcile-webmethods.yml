---
# reconcile-webmethods.yml
# GitOps Reconciliation Playbook for webMethods Gateway
#
# Usage:
#   ansible-playbook reconcile-webmethods.yml -e "env=dev"
#   ansible-playbook reconcile-webmethods.yml -e "env=prod" --check  # Dry-run
#
# Triggered by:
#   - ArgoCD PostSync hook
#   - AWX Job Template
#   - GitLab CI webhook

- name: "ðŸ”„ Reconcile webMethods Gateway from Git"
  hosts: localhost
  gather_facts: false
  
  vars:
    # GitOps source directory (cloned by AWX/CI)
    # AWX sets playbook_dir to the playbook location, dirname goes up to project root
    gitops_dir: "{{ lookup('env', 'GITOPS_DIR') | default(playbook_dir | dirname | dirname, true) }}"

    # APIs can be in webmethods/ (legacy) or tenants/ (new structure)
    webmethods_dir: "{{ gitops_dir }}/webmethods"
    tenants_dir: "{{ gitops_dir }}/tenants"

    # Base domain for URL substitution
    base_domain: "{{ lookup('env', 'BASE_DOMAIN') | default('stoa.cab-i.com', true) }}"
    
    # Target environment
    env: "{{ lookup('env', 'STOA_ENV') | default('dev', true) }}"
    
    # webMethods Gateway API
    wm_gateway_url: "{{ lookup('env', 'WM_GATEWAY_URL') | default('http://apim-gateway:9072', true) }}"
    wm_admin_user: "{{ lookup('env', 'WM_ADMIN_USER') | default('Administrator', true) }}"
    wm_admin_password: "{{ lookup('env', 'WM_ADMIN_PASSWORD') }}"
    
    # Options
    dry_run: "{{ ansible_check_mode | default(false) }}"
    delete_orphans: "{{ lookup('env', 'DELETE_ORPHANS') | default('true', true) | bool }}"
    
  pre_tasks:
    - name: "ðŸ“‹ Display parameters"
      ansible.builtin.debug:
        msg: |
          === webMethods Reconciliation ===
          Environment: {{ env }}
          GitOps Dir: {{ gitops_dir }}
          Gateway URL: {{ wm_gateway_url }}
          Dry Run: {{ dry_run }}
          Delete Orphans: {{ delete_orphans }}
          
    - name: "âœ… Verify GitOps directory exists (webmethods or tenants)"
      ansible.builtin.stat:
        path: "{{ item }}"
      register: gitops_check
      loop:
        - "{{ webmethods_dir }}"
        - "{{ tenants_dir }}"

    - name: "âœ… Ensure at least one API directory exists"
      ansible.builtin.fail:
        msg: "Neither {{ webmethods_dir }} nor {{ tenants_dir }} exists"
      when: not (gitops_check.results | selectattr('stat.exists', 'true') | list | length > 0)
      
    - name: "âœ… Verify Gateway connectivity"
      ansible.builtin.uri:
        url: "{{ wm_gateway_url }}/rest/apigateway/health"
        method: GET
        user: "{{ wm_admin_user }}"
        password: "{{ wm_admin_password }}"
        force_basic_auth: true
        status_code: [200]
        timeout: 10
      register: health_check
      
  tasks:
    - name: "ðŸ“ Load APIs from Git"
      ansible.builtin.include_tasks: tasks/load-git-apis.yml
      
    - name: "ðŸ“¡ Fetch current APIs from Gateway"
      ansible.builtin.include_tasks: tasks/fetch-gateway-apis.yml
      
    - name: "ðŸ” Compute diff (Git vs Gateway)"
      ansible.builtin.include_tasks: tasks/compute-diff.yml
      
    - name: "âž• Create new APIs"
      ansible.builtin.include_tasks: tasks/create-apis.yml
      when: apis_to_create | length > 0
      
    - name: "ðŸ”„ Update modified APIs"
      ansible.builtin.include_tasks: tasks/update-apis.yml
      when: apis_to_update | length > 0
      
    - name: "âž– Delete orphaned APIs"
      ansible.builtin.include_tasks: tasks/delete-apis.yml
      when: 
        - delete_orphans
        - apis_to_delete | length > 0
        
    - name: "ðŸ”’ Apply policies"
      ansible.builtin.include_tasks: tasks/apply-policies.yml
      
    - name: "ðŸ”— Configure aliases"
      ansible.builtin.include_tasks: tasks/configure-aliases.yml

    - name: "ðŸ“± Sync applications"
      ansible.builtin.include_tasks: tasks/sync-applications.yml
      when: sync_applications | default(true)
      tags:
        - applications
        - sync

  post_tasks:
    - name: "ðŸ“Š Reconciliation summary"
      ansible.builtin.debug:
        msg: |
          === Summary ===
          âœ… APIs created: {{ apis_created | default([]) | length }}
          ðŸ”„ APIs updated: {{ apis_updated | default([]) | length }}
          âž– APIs deleted: {{ apis_deleted | default([]) | length }}
          ðŸ”’ Policies applied: {{ policies_applied | default([]) | length }}
          ðŸ”— Aliases configured: {{ aliases_configured | default([]) | length }}
          ðŸ“± Applications synced: {{ applications_synced | default(0) }}
          
          {% if dry_run %}
          âš ï¸  DRY-RUN mode - No changes applied
          {% endif %}
          
    - name: "ðŸ“¤ Send notification (if configured)"
      ansible.builtin.include_tasks: tasks/notify.yml
      when: lookup('env', 'NOTIFY_WEBHOOK_URL') | length > 0
