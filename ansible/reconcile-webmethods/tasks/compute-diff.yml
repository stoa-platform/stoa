---
# tasks/compute-diff.yml
# Compare Git state vs Gateway and determine actions to perform

# Build Git API keys in same format as Gateway lookup: name:version
- name: "Build Git API keys (name:version format)"
  ansible.builtin.set_fact:
    git_api_keys: "{{ git_apis | map(attribute='metadata') | map('json_query', 'join(`:`, [name, version || `1.0.0`])') | list }}"

# Also keep simple names for lookups
- name: "Extract Git API names"
  ansible.builtin.set_fact:
    git_api_names: "{{ git_apis | map(attribute='metadata.name') | list }}"

- name: "Extract Gateway API keys"
  ansible.builtin.set_fact:
    gateway_api_keys: "{{ gateway_api_lookup.keys() | list }}"

# Extract just the names from Gateway for backwards compatibility
- name: "Extract Gateway API names only"
  ansible.builtin.set_fact:
    gateway_api_names: "{{ gateway_api_lookup.values() | map(attribute='apiName') | list }}"

- name: "Calculate APIs to create (in Git, not on Gateway)"
  ansible.builtin.set_fact:
    apis_to_create: "{{ git_api_names | difference(gateway_api_names) }}"

- name: "Calculate APIs to delete (on Gateway, not in Git) - use names only"
  ansible.builtin.set_fact:
    apis_to_delete: "{{ gateway_api_names | difference(git_api_names) }}"

- name: "Calculate common APIs (potentially need update)"
  ansible.builtin.set_fact:
    apis_common: "{{ git_api_names | intersect(gateway_api_names) }}"

- name: "Initialize APIs to update list"
  ansible.builtin.set_fact:
    apis_to_update: []

- name: "Compare each common API"
  ansible.builtin.include_tasks: compare-api.yml
  loop: "{{ apis_common }}"
  loop_control:
    loop_var: api_name

- name: "ðŸ“Š Display diff result"
  ansible.builtin.debug:
    msg: |
      === Git vs Gateway Diff ===
      
      âž• APIs to CREATE ({{ apis_to_create | length }}):
      {{ apis_to_create | to_nice_yaml if apis_to_create | length > 0 else '   (none)' }}
      
      ðŸ”„ APIs to UPDATE ({{ apis_to_update | length }}):
      {{ apis_to_update | to_nice_yaml if apis_to_update | length > 0 else '   (none)' }}
      
      âž– APIs to DELETE ({{ apis_to_delete | length }}):
      {{ apis_to_delete | to_nice_yaml if apis_to_delete | length > 0 else '   (none)' }}
      
      âœ… APIs in sync: {{ apis_common | length - apis_to_update | length }}
