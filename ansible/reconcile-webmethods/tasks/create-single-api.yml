---
# tasks/create-single-api.yml
# Create a single API on webMethods Gateway

- name: "Get Git definition for {{ api_name_to_create }}"
  ansible.builtin.set_fact:
    api_def: "{{ git_apis | selectattr('metadata.name', 'equalto', api_name_to_create) | first }}"

- name: "Resolve backend alias"
  ansible.builtin.set_fact:
    backend_url: "{{ git_aliases.aliases[api_def.spec.backend.alias].url }}"
  when: 
    - git_aliases is defined
    - api_def.spec.backend.alias is defined
    - api_def.spec.backend.alias in git_aliases.aliases

- name: "Set default backend URL if alias not found"
  ansible.builtin.set_fact:
    backend_url: "http://localhost:8080"
  when: backend_url is not defined

- name: "Build Swagger spec for {{ api_name_to_create }}"
  ansible.builtin.set_fact:
    swagger_spec:
      swagger: "2.0"
      info:
        title: "{{ api_def.metadata.name }}"
        version: "{{ api_def.metadata.version | default('1.0.0') }}"
        description: "{{ api_def.metadata.description | default('') }}"
      host: "{{ backend_url | regex_replace('^https?://', '') | regex_replace('/.*$', '') }}"
      basePath: "{{ api_def.spec.basePath | default('/') }}"
      schemes:
        - https
      paths: {}

- name: "Write Swagger spec to temp file"
  ansible.builtin.copy:
    content: "{{ swagger_spec | to_json }}"
    dest: "/tmp/api-{{ api_name_to_create }}.json"
    mode: '0644'
  when: not dry_run

- name: "➕ Create API {{ api_name_to_create }} on Gateway (file upload)"
  ansible.builtin.shell: |
    curl -s -X POST "{{ wm_gateway_url }}/rest/apigateway/apis" \
      -u "{{ wm_admin_user }}:{{ wm_admin_password }}" \
      -H "Accept: application/json" \
      -F "file=@/tmp/api-{{ api_name_to_create }}.json;type=application/json"
  register: create_result_raw
  when: not dry_run

- name: "Parse create result"
  ansible.builtin.set_fact:
    create_result:
      json: "{{ create_result_raw.stdout | from_json }}"
  when:
    - not dry_run
    - create_result_raw is succeeded

- name: "Clean up temp file"
  ansible.builtin.file:
    path: "/tmp/api-{{ api_name_to_create }}.json"
    state: absent
  when: not dry_run

- name: "Store created API ID"
  ansible.builtin.set_fact:
    created_api_id: "{{ create_result.json.apiResponse.api.id }}"
  when:
    - not dry_run
    - create_result is defined
    - create_result.json is defined
    - create_result.json.apiResponse is defined

- name: "Record created API"
  ansible.builtin.set_fact:
    apis_created: "{{ apis_created + [api_name_to_create] }}"

- name: "Log creation {{ api_name_to_create }}"
  ansible.builtin.debug:
    msg: "✅ API {{ api_name_to_create }} created{{ ' (dry-run)' if dry_run else '' }}"
