---
# tasks/load-git-apis.yml
# Load and parse all API YAML files from Git
# Supports both legacy (webmethods/apis/) and new (tenants/{tenant}/apis/) structures

- name: "Initialize git_apis list"
  ansible.builtin.set_fact:
    git_apis: []

# ============ LEGACY STRUCTURE (webmethods/apis/) ============
- name: "Check if legacy webmethods/apis directory exists"
  ansible.builtin.stat:
    path: "{{ webmethods_dir }}/apis"
  register: legacy_apis_dir

- name: "Load APIs from legacy webmethods/apis directory"
  when: legacy_apis_dir.stat.exists | default(false)
  block:
    - name: "Find all API YAML files in webmethods/apis"
      ansible.builtin.find:
        paths: "{{ webmethods_dir }}/apis"
        patterns: "*.yaml,*.yml"
        excludes: "_*"  # Ignore template files prefixed with _
      register: legacy_api_files

    - name: "Load legacy API file contents"
      ansible.builtin.slurp:
        src: "{{ item.path }}"
      loop: "{{ legacy_api_files.files }}"
      register: legacy_api_contents

    - name: "Parse legacy API YAML files"
      ansible.builtin.set_fact:
        git_apis: "{{ git_apis + [item.content | b64decode | from_yaml | combine({'_source': 'webmethods', '_tenant': 'default'})] }}"
      loop: "{{ legacy_api_contents.results }}"
      when: item.content is defined

# ============ NEW STRUCTURE (tenants/{tenant}/apis/) ============
- name: "Check if tenants directory exists"
  ansible.builtin.stat:
    path: "{{ tenants_dir }}"
  register: tenants_dir_check

- name: "Load APIs from tenant directories"
  when: tenants_dir_check.stat.exists | default(false)
  block:
    - name: "Find all tenant directories"
      ansible.builtin.find:
        paths: "{{ tenants_dir }}"
        file_type: directory
        recurse: false
      register: tenant_dirs

    - name: "Load APIs for each tenant"
      ansible.builtin.include_tasks: load-tenant-apis.yml
      loop: "{{ tenant_dirs.files }}"
      loop_control:
        loop_var: tenant_dir
        label: "{{ tenant_dir.path | basename }}"

- name: "Load aliases for environment {{ env }}"
  ansible.builtin.slurp:
    src: "{{ webmethods_dir }}/aliases/{{ env }}.yaml"
  register: aliases_content
  ignore_errors: true

- name: "Parse aliases"
  ansible.builtin.set_fact:
    git_aliases: "{{ aliases_content.content | b64decode | from_yaml }}"
  when: aliases_content is succeeded

- name: "Find policy files"
  ansible.builtin.find:
    paths: "{{ webmethods_dir }}/policies"
    patterns: "*.yaml,*.yml"
  register: policy_files
  ignore_errors: true

- name: "Load policy file contents"
  ansible.builtin.slurp:
    src: "{{ item.path }}"
  loop: "{{ policy_files.files }}"
  register: policy_contents

- name: "Parse policy YAML files"
  ansible.builtin.set_fact:
    git_policies: "{{ git_policies | default({}) | combine({(item.content | b64decode | from_yaml).metadata.name: (item.content | b64decode | from_yaml)}) }}"
  loop: "{{ policy_contents.results }}"
  when: item.content is defined

- name: "Display APIs loaded from Git"
  ansible.builtin.debug:
    msg: |
      ğŸ“ Total APIs found in Git: {{ git_apis | length }}
      ğŸ“ APIs from webmethods/: {{ git_apis | selectattr('_source', 'equalto', 'webmethods') | list | length }}
      ğŸ“ APIs from tenants/: {{ git_apis | selectattr('_source', 'equalto', 'tenants') | list | length }}
      ğŸ“ APIs by tenant: {{ git_apis | groupby('_tenant') | map('first') | list }}
      ğŸ“ API names: {{ git_apis | map(attribute='metadata.name') | list }}
      ğŸ”’ Policies: {{ git_policies.keys() | default([]) | list }}
      ğŸ”— Aliases ({{ env }}): {{ git_aliases.aliases.keys() | list if git_aliases is defined else 'Not found' }}
