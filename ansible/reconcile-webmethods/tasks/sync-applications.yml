---
# sync-applications.yml
# Reconcile Gateway Applications from GitOps definitions
#
# This task file syncs applications defined in Git to webMethods Gateway.
# Applications use 'azp' (authorized party) claim to identify OAuth2 clients.
#
# Expected variables:
#   - webmethods_dir: Path to GitOps webmethods directory
#   - wm_gateway_url: Gateway REST API URL
#   - wm_admin_user: Gateway admin username
#   - wm_admin_password: Gateway admin password

- name: "ğŸ“± Check if applications directory exists"
  ansible.builtin.stat:
    path: "{{ webmethods_dir }}/applications"
  register: apps_dir_check

- name: "ğŸ“± Skip application sync if no definitions"
  ansible.builtin.debug:
    msg: "No applications directory found - skipping application sync"
  when: not apps_dir_check.stat.exists

- name: "ğŸ“± Sync applications from Git"
  when: apps_dir_check.stat.exists
  block:
    - name: "ğŸ“ Find application definition files"
      ansible.builtin.find:
        paths: "{{ webmethods_dir }}/applications"
        patterns: "*.yaml,*.yml"
      register: app_files

    - name: "ğŸ“– Load application definitions"
      ansible.builtin.include_vars:
        file: "{{ item.path }}"
        name: "app_def_{{ item.path | basename | splitext | first | regex_replace('-', '_') }}"
      loop: "{{ app_files.files }}"
      loop_control:
        label: "{{ item.path | basename }}"

    - name: "ğŸ“¡ Fetch existing applications from Gateway"
      ansible.builtin.uri:
        url: "{{ wm_gateway_url }}/rest/apigateway/applications"
        method: GET
        user: "{{ wm_admin_user }}"
        password: "{{ wm_admin_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Accept: "application/json"
        status_code: [200]
      register: existing_apps_response

    - name: "ğŸ” Parse existing applications"
      ansible.builtin.set_fact:
        existing_apps: "{{ existing_apps_response.json.applications | default([]) }}"
        existing_app_names: "{{ existing_apps_response.json.applications | default([]) | map(attribute='name') | list }}"

    - name: "ğŸ“¡ Fetch existing strategies from Gateway"
      ansible.builtin.uri:
        url: "{{ wm_gateway_url }}/rest/apigateway/strategies"
        method: GET
        user: "{{ wm_admin_user }}"
        password: "{{ wm_admin_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Accept: "application/json"
        status_code: [200]
      register: existing_strategies_response

    - name: "ğŸ” Build strategy name to ID map"
      ansible.builtin.set_fact:
        strategy_map: "{{ existing_strategies_response.json.strategies | default([]) | items2dict(key_name='name', value_name='id') }}"

    - name: "ğŸ“¡ Fetch existing APIs from Gateway"
      ansible.builtin.uri:
        url: "{{ wm_gateway_url }}/rest/apigateway/apis"
        method: GET
        user: "{{ wm_admin_user }}"
        password: "{{ wm_admin_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Accept: "application/json"
        status_code: [200]
      register: existing_apis_response

    - name: "ğŸ” Build API name to ID map"
      ansible.builtin.set_fact:
        api_map: "{{ existing_apis_response.json.apis | default([]) | items2dict(key_name='apiName', value_name='id') }}"

    - name: "ğŸ“‹ Display loaded definitions"
      ansible.builtin.debug:
        msg: |
          Found {{ app_files.files | length }} application definitions
          Existing apps in Gateway: {{ existing_app_names }}
          Strategy map: {{ strategy_map.keys() | list }}
          API map: {{ api_map.keys() | list }}

    - name: "ğŸ”„ Process each application definition"
      ansible.builtin.include_tasks: upsert-application.yml
      loop: "{{ app_files.files }}"
      loop_control:
        loop_var: app_file
        label: "{{ app_file.path | basename }}"
      vars:
        app_def_name: "app_def_{{ app_file.path | basename | splitext | first | regex_replace('-', '_') }}"

- name: "ğŸ“Š Set applications synced count"
  ansible.builtin.set_fact:
    applications_synced: "{{ app_files.files | default([]) | length }}"
