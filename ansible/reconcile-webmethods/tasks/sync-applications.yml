---
# sync-applications.yml
# Reconcile Gateway Applications from GitOps definitions
#
# This task file syncs applications defined in Git to webMethods Gateway.
# Applications use 'azp' (authorized party) claim to identify OAuth2 clients.
# Supports both legacy (webmethods/applications/) and new (tenants/{tenant}/applications/) structures.
#
# Expected variables:
#   - webmethods_dir: Path to GitOps webmethods directory
#   - tenants_dir: Path to GitOps tenants directory
#   - wm_gateway_url: Gateway REST API URL
#   - wm_admin_user: Gateway admin username
#   - wm_admin_password: Gateway admin password

- name: "ğŸ“± Initialize application files list"
  ansible.builtin.set_fact:
    all_app_files: []

# ============ LEGACY STRUCTURE (webmethods/applications/) ============
- name: "ğŸ“± Check if legacy applications directory exists"
  ansible.builtin.stat:
    path: "{{ webmethods_dir }}/applications"
  register: legacy_apps_dir_check

- name: "ğŸ“± Load applications from legacy directory"
  when: legacy_apps_dir_check.stat.exists | default(false)
  block:
    - name: "ğŸ“ Find application files in webmethods/applications"
      ansible.builtin.find:
        paths: "{{ webmethods_dir }}/applications"
        patterns: "*.yaml,*.yml"
      register: legacy_app_files

    - name: "ğŸ“‹ Add legacy app files to list"
      ansible.builtin.set_fact:
        all_app_files: "{{ all_app_files + legacy_app_files.files }}"

# ============ NEW STRUCTURE (tenants/{tenant}/applications/) ============
- name: "ğŸ“± Check if tenants directory exists"
  ansible.builtin.stat:
    path: "{{ tenants_dir }}"
  register: tenants_dir_apps_check

- name: "ğŸ“± Load applications from tenant directories"
  when: tenants_dir_apps_check.stat.exists | default(false)
  block:
    - name: "ğŸ“ Find all tenant directories"
      ansible.builtin.find:
        paths: "{{ tenants_dir }}"
        file_type: directory
        recurse: false
      register: tenant_dirs_for_apps

    - name: "ğŸ“ Find application files in each tenant"
      ansible.builtin.find:
        paths: "{{ item.path }}/applications"
        patterns: "*.yaml,*.yml"
      loop: "{{ tenant_dirs_for_apps.files }}"
      register: tenant_app_files_nested
      ignore_errors: true

    - name: "ğŸ“‹ Add tenant app files to list"
      ansible.builtin.set_fact:
        all_app_files: "{{ all_app_files + (item.files | default([])) }}"
      loop: "{{ tenant_app_files_nested.results }}"
      when: item.files is defined

- name: "ğŸ“± Skip application sync if no definitions"
  ansible.builtin.debug:
    msg: "No applications found in webmethods/applications/ or tenants/*/applications/ - skipping application sync"
  when: all_app_files | length == 0

- name: "ğŸ“± Sync applications from Git"
  when: all_app_files | length > 0
  block:
    - name: "ğŸ“‹ Set app_files for compatibility"
      ansible.builtin.set_fact:
        app_files:
          files: "{{ all_app_files }}"

    - name: "ğŸ“– Load application definitions"
      ansible.builtin.include_vars:
        file: "{{ item.path }}"
        name: "app_def_{{ item.path | basename | splitext | first | regex_replace('-', '_') }}"
      loop: "{{ app_files.files }}"
      loop_control:
        label: "{{ item.path | basename }}"

    - name: "ğŸ“¡ Fetch existing applications from Gateway"
      ansible.builtin.uri:
        url: "{{ wm_gateway_url }}/rest/apigateway/applications"
        method: GET
        user: "{{ wm_admin_user }}"
        password: "{{ wm_admin_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Accept: "application/json"
        status_code: [200]
      register: existing_apps_response

    - name: "ğŸ” Parse existing applications"
      ansible.builtin.set_fact:
        existing_apps: "{{ existing_apps_response.json.applications | default([]) }}"
        existing_app_names: "{{ existing_apps_response.json.applications | default([]) | map(attribute='name') | list }}"

    - name: "ğŸ“¡ Fetch existing strategies from Gateway"
      ansible.builtin.uri:
        url: "{{ wm_gateway_url }}/rest/apigateway/strategies"
        method: GET
        user: "{{ wm_admin_user }}"
        password: "{{ wm_admin_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Accept: "application/json"
        status_code: [200]
      register: existing_strategies_response

    - name: "ğŸ” Build strategy name to ID map"
      ansible.builtin.set_fact:
        strategy_map: "{{ existing_strategies_response.json.strategies | default([]) | items2dict(key_name='name', value_name='id') }}"

    - name: "ğŸ“¡ Fetch existing APIs from Gateway"
      ansible.builtin.uri:
        url: "{{ wm_gateway_url }}/rest/apigateway/apis"
        method: GET
        user: "{{ wm_admin_user }}"
        password: "{{ wm_admin_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Accept: "application/json"
        status_code: [200]
      register: existing_apis_response

    - name: "ğŸ” Build API name to ID map"
      ansible.builtin.set_fact:
        api_map: "{{ existing_apis_response.json.apis | default([]) | items2dict(key_name='apiName', value_name='id') }}"

    - name: "ğŸ“‹ Display loaded definitions"
      ansible.builtin.debug:
        msg: |
          Found {{ app_files.files | length }} application definitions
          Existing apps in Gateway: {{ existing_app_names }}
          Strategy map: {{ strategy_map.keys() | list }}
          API map: {{ api_map.keys() | list }}

    - name: "ğŸ”„ Process each application definition"
      ansible.builtin.include_tasks: upsert-application.yml
      loop: "{{ app_files.files }}"
      loop_control:
        loop_var: app_file
        label: "{{ app_file.path | basename }}"
      vars:
        app_def_name: "app_def_{{ app_file.path | basename | splitext | first | regex_replace('-', '_') }}"

- name: "ğŸ“Š Set applications synced count"
  ansible.builtin.set_fact:
    applications_synced: "{{ all_app_files | default([]) | length }}"
