---
# tasks/unpublish-from-portal.yml
# Unpublish an API from the Developer Portal (for internal/hidden APIs)
#
# Expected variables:
#   - api_def: API definition with metadata
#   - wm_gateway_url: Gateway URL
#   - wm_admin_user: Gateway admin username
#   - wm_admin_password: Gateway admin password
#   - portal_gateway_id: Portal Gateway ID (default: 'default')
#   - dry_run: Whether to simulate only
#   - sync_results: Results tracking dict

- name: "Extract API details"
  ansible.builtin.set_fact:
    unpublish_api_name: "{{ api_def.metadata.name }}"
    unpublish_api_tenant: "{{ api_def._tenant }}"
    unpublish_api_visibility: "{{ api_def._portal_visibility }}"

- name: "Find API ID by name"
  ansible.builtin.uri:
    url: "{{ wm_gateway_url }}/rest/apigateway/apis?apiName={{ unpublish_api_name | urlencode }}"
    method: GET
    user: "{{ wm_admin_user }}"
    password: "{{ wm_admin_password }}"
    force_basic_auth: true
    validate_certs: false
    headers:
      Accept: "application/json"
    status_code: [200]
  register: find_result

- name: "Extract API ID"
  ansible.builtin.set_fact:
    unpublish_api_id: "{{ find_result.json.apiResponse[0].api.id }}"
  when: find_result.json.apiResponse | length > 0

- name: "Unpublish API from portal"
  when:
    - unpublish_api_id is defined
    - not dry_run
  block:
    - name: "PUT unpublish API"
      ansible.builtin.uri:
        url: "{{ wm_gateway_url }}/rest/apigateway/apis/{{ unpublish_api_id }}/unpublish"
        method: PUT
        user: "{{ wm_admin_user }}"
        password: "{{ wm_admin_password }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Content-Type: "application/json"
          Accept: "application/json"
        body_format: json
        body:
          portalGatewayId: "{{ portal_gateway_id | default('default') }}"
        status_code: [200, 400, 404]  # 400/404 if not published
      register: unpublish_result

    - name: "Add to sync_results.unpublished"
      ansible.builtin.set_fact:
        sync_results: "{{ sync_results | combine({'unpublished': sync_results.unpublished + [unpublish_api_name]}) }}"
      when: unpublish_result.status == 200

    - name: "Log unpublication"
      ansible.builtin.debug:
        msg: "Unpublished API {{ unpublish_api_name }} from portal (visibility: {{ unpublish_api_visibility }})"
        verbosity: 1

- name: "Dry-run: Would unpublish API"
  when: dry_run
  ansible.builtin.debug:
    msg: |
      DRY-RUN: Would unpublish API from portal:
        Name: {{ unpublish_api_name }}
        Tenant: {{ unpublish_api_tenant }}
        Visibility: {{ unpublish_api_visibility }}
