---
# Common configuration for all EC2 instances

- name: Update all packages
  yum:
    name: '*'
    state: latest
  when: ansible_os_family == "RedHat"

- name: Install base packages
  yum:
    name:
      - vim
      - wget
      - curl
      - git
      - jq
      - unzip
      - htop
      - nc
    state: present
  when: ansible_os_family == "RedHat"

- name: Set timezone to Europe/Paris
  timezone:
    name: Europe/Paris

- name: Install CloudWatch Agent
  shell: |
    wget https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm
    rpm -U ./amazon-cloudwatch-agent.rpm
  args:
    creates: /opt/aws/amazon-cloudwatch-agent

- name: Configure CloudWatch Agent
  template:
    src: cloudwatch-config.json.j2
    dest: /opt/aws/amazon-cloudwatch-agent/etc/config.json
  notify: restart cloudwatch-agent

- name: Start and enable CloudWatch Agent
  systemd:
    name: amazon-cloudwatch-agent
    state: started
    enabled: yes

- name: Configure SSH hardening
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^PermitRootLogin', line: 'PermitRootLogin no' }
    - { regexp: '^PasswordAuthentication', line: 'PasswordAuthentication no' }
  notify: restart sshd
