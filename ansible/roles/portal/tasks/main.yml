---
# Install and configure webMethods Developer Portal

- name: Create portal installation directory
  file:
    path: /opt/softwareag/portal
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Check if Developer Portal is already installed
  stat:
    path: /opt/softwareag/portal/bin/startup.sh
  register: portal_installed

- name: Download Developer Portal installer from S3
  aws_s3:
    bucket: "{{ artifacts_bucket }}"
    object: "installers/portal/{{ portal_installer }}"
    dest: "/tmp/{{ portal_installer }}"
    mode: get
  when: not portal_installed.stat.exists

- name: Extract Developer Portal
  unarchive:
    src: "/tmp/{{ portal_installer }}"
    dest: /opt/softwareag/portal
    remote_src: yes
  when: not portal_installed.stat.exists

- name: Configure Developer Portal port
  lineinfile:
    path: /opt/softwareag/portal/config/portal.properties
    regexp: '^portal.port='
    line: 'portal.port=18101'
  notify: restart portal

- name: Configure connection to API Gateway
  lineinfile:
    path: /opt/softwareag/portal/config/portal.properties
    regexp: '^apigateway.url='
    line: 'apigateway.url={{ api_gateway_url }}'
  notify: restart portal

- name: Create systemd service for Developer Portal
  template:
    src: portal.service.j2
    dest: /etc/systemd/system/portal.service
    mode: '0644'
  notify:
    - reload systemd
    - restart portal

- name: Enable and start Developer Portal
  systemd:
    name: portal
    enabled: yes
    state: started
    daemon_reload: yes

- name: Wait for portal to be ready
  uri:
    url: "http://localhost:18101/portal"
    method: GET
    status_code: 200
  retries: 30
  delay: 10
  register: result
  until: result.status == 200

- name: Display portal info
  debug:
    msg: |
      Developer Portal installation completed!
      - URL: http://{{ ansible_default_ipv4.address }}:18101/portal
      - Connected to API Gateway: {{ api_gateway_url }}
