---
# Install and configure webMethods API Gateway using Docker

- name: Ensure Docker is installed
  yum:
    name: docker
    state: present
  when: ansible_os_family == "RedHat"

- name: Start and enable Docker service
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Create webMethods data directories
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /opt/webmethods/data
    - /opt/webmethods/config
    - /opt/webmethods/logs

- name: Pull webMethods API Gateway Docker image
  docker_image:
    name: "{{ webmethods_docker_image }}"
    source: pull
    force_source: yes
  register: docker_pull

- name: Create docker-compose file for webMethods
  template:
    src: docker-compose.yml.j2
    dest: /opt/webmethods/docker-compose.yml
    mode: '0644'

- name: Create environment file for webMethods
  template:
    src: webmethods.env.j2
    dest: /opt/webmethods/.env
    mode: '0600'

- name: Install docker-compose
  get_url:
    url: "https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-linux-x86_64"
    dest: /usr/local/bin/docker-compose
    mode: '0755'

- name: Start webMethods container with docker-compose
  shell: |
    cd /opt/webmethods
    docker-compose up -d
  args:
    chdir: /opt/webmethods

- name: Wait for API Gateway to be ready
  uri:
    url: "http://localhost:9072/rest/apigateway/health"
    method: GET
    status_code: 200
    timeout: 300
  retries: 30
  delay: 10
  register: result
  until: result.status == 200

- name: Configure API Gateway administrator password
  uri:
    url: "http://localhost:9072/rest/apigateway/configurations/password"
    method: PUT
    user: Administrator
    password: "manage"
    force_basic_auth: yes
    body_format: json
    body:
      newPassword: "{{ webmethods_admin_password }}"
    status_code: 200
  when: webmethods_admin_password is defined

- name: Create API Gateway Teams for multi-tenancy
  uri:
    url: "http://localhost:9072/rest/apigateway/teams"
    method: POST
    user: Administrator
    password: "{{ webmethods_admin_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      name: "{{ item.name }}"
      description: "{{ item.description }}"
    status_code: 201
  loop: "{{ api_gateway_teams | default([]) }}"
  when: webmethods_admin_password is defined
  ignore_errors: yes

- name: Configure CloudWatch logs for API Gateway
  template:
    src: cloudwatch-config.json.j2
    dest: /opt/aws/amazon-cloudwatch-agent/etc/apim-gateway-config.json
  notify: restart cloudwatch-agent

- name: Create backup script for Docker volumes
  template:
    src: backup-docker.sh.j2
    dest: /opt/webmethods/backup.sh
    mode: '0755'

- name: Schedule daily backups
  cron:
    name: "webMethods API Gateway backup"
    minute: "0"
    hour: "2"
    job: "/opt/webmethods/backup.sh"
    user: root

- name: Display API Gateway info
  debug:
    msg: |
      webMethods API Gateway (Docker) installation completed!
      - Container: {{ webmethods_docker_image }}
      - Admin UI: http://{{ ansible_default_ipv4.address }}:9072
      - Runtime Port: 5555
      - Default User: Administrator
      - Check: docker ps
      - Logs: docker logs webmethods-gateway
