#!/bin/bash
# Backup script for webMethods API Gateway

set -e

BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/tmp/webmethods-backup-${BACKUP_DATE}"
S3_BUCKET="{{ backup_bucket | default('apim-backups-dev') }}"

echo "Starting webMethods backup at $(date)"

# Create backup directory
mkdir -p ${BACKUP_DIR}

# Backup configuration
echo "Backing up configuration..."
tar czf ${BACKUP_DIR}/config.tar.gz \
  /opt/softwareag/IntegrationServer/instances/default/config/ \
  /opt/softwareag/profiles/IS_default/configuration/

# Backup packages
echo "Backing up packages..."
tar czf ${BACKUP_DIR}/packages.tar.gz \
  /opt/softwareag/IntegrationServer/instances/default/packages/

# Upload to S3
echo "Uploading to S3..."
aws s3 sync ${BACKUP_DIR}/ s3://${S3_BUCKET}/webmethods/${BACKUP_DATE}/ \
  --region {{ aws_region | default('eu-west-1') }}

# Cleanup local backup
rm -rf ${BACKUP_DIR}

echo "Backup completed successfully at $(date)"
