version: '3.8'

services:
  webmethods-gateway:
    image: {{ webmethods_docker_image }}
    container_name: webmethods-gateway
    hostname: webmethods-gateway
    restart: unless-stopped

    ports:
      - "9072:9072"  # Admin UI
      - "5555:5555"  # Runtime port
      - "9999:9999"  # Diagnostic port

    environment:
      # License
      - ACCEPT_LICENSE=true

      # Admin credentials
      - ADMIN_PASSWORD={{ webmethods_admin_password | default('manage') }}

      # Memory settings
      - JAVA_MIN_MEM={{ webmethods_java_min_mem | default('512m') }}
      - JAVA_MAX_MEM={{ webmethods_java_max_mem | default('2048m') }}

      # OpenSearch connection (if external)
{% if opensearch_endpoint is defined %}
      - ELASTICSEARCH_HOSTS={{ opensearch_endpoint }}
{% endif %}

      # AWS region
      - AWS_REGION={{ aws_region | default('eu-west-1') }}
      - AWS_DEFAULT_REGION={{ aws_region | default('eu-west-1') }}

    volumes:
      - /opt/webmethods/data:/opt/softwareag/IntegrationServer/instances/default/data
      - /opt/webmethods/config:/opt/softwareag/IntegrationServer/instances/default/config
      - /opt/webmethods/logs:/opt/softwareag/IntegrationServer/instances/default/logs
      - /opt/webmethods/packages:/opt/softwareag/IntegrationServer/instances/default/packages

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9072/rest/apigateway/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    labels:
      - "com.softwareag.service=api-gateway"
      - "com.softwareag.environment={{ environment }}"
      - "com.softwareag.project=apim"

{% if use_external_opensearch | default(false) %}
# OpenSearch is external, not running in Docker
{% else %}
  # Internal OpenSearch (if not using external)
  opensearch:
    image: opensearchproject/opensearch:2.11.0
    container_name: opensearch
    environment:
      - discovery.type=single-node
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - "DISABLE_SECURITY_PLUGIN=true"
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    ports:
      - "9200:9200"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200/_cluster/health"]
      interval: 30s
      timeout: 10s
      retries: 5
{% endif %}

volumes:
{% if not (use_external_opensearch | default(false)) %}
  opensearch-data:
    driver: local
{% endif %}
  webmethods-data:
    driver: local
