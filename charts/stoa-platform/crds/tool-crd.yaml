# STOA Platform - Tool Custom Resource Definition
# Defines MCP tools that can be dynamically registered in the MCP Gateway
#
# Example usage:
#   apiVersion: stoa.cab-i.com/v1alpha1
#   kind: Tool
#   metadata:
#     name: payment-api-search
#     namespace: tenant-acme
#   spec:
#     displayName: Search Payments
#     description: Search payment records by various criteria
#     endpoint: https://api.acme.com/v1/payments/search
#     method: GET
#     tags: [payments, search]

apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: tools.stoa.cab-i.com
  labels:
    app.kubernetes.io/name: stoa-platform
    app.kubernetes.io/component: mcp-gateway
  annotations:
    controller-gen.kubebuilder.io/version: v0.14.0
spec:
  group: stoa.cab-i.com
  names:
    kind: Tool
    listKind: ToolList
    plural: tools
    singular: tool
    shortNames:
      - tl
    categories:
      - stoa
      - mcp
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Display Name
          type: string
          jsonPath: .spec.displayName
        - name: Method
          type: string
          jsonPath: .spec.method
        - name: Status
          type: string
          jsonPath: .status.phase
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - displayName
                - description
              properties:
                displayName:
                  type: string
                  description: Human-readable name for the tool
                  minLength: 1
                  maxLength: 64
                description:
                  type: string
                  description: Detailed description of what the tool does
                  minLength: 1
                  maxLength: 1024
                endpoint:
                  type: string
                  description: HTTP endpoint URL for API-backed tools
                  format: uri
                  pattern: "^https?://"
                method:
                  type: string
                  description: HTTP method for the endpoint
                  enum:
                    - GET
                    - POST
                    - PUT
                    - PATCH
                    - DELETE
                  default: POST
                inputSchema:
                  type: object
                  description: JSON Schema for tool input parameters
                  x-kubernetes-preserve-unknown-fields: true
                  properties:
                    type:
                      type: string
                      default: object
                    properties:
                      type: object
                      x-kubernetes-preserve-unknown-fields: true
                    required:
                      type: array
                      items:
                        type: string
                tags:
                  type: array
                  description: Tags for categorization and filtering
                  items:
                    type: string
                    minLength: 1
                    maxLength: 32
                  maxItems: 10
                version:
                  type: string
                  description: Tool version (semver)
                  default: "1.0.0"
                  pattern: "^\\d+\\.\\d+\\.\\d+(-[a-zA-Z0-9]+)?$"
                apiRef:
                  type: object
                  description: Reference to the source API
                  properties:
                    name:
                      type: string
                      description: API name or identifier
                    version:
                      type: string
                      description: API version
                    operationId:
                      type: string
                      description: OpenAPI operationId
                authentication:
                  type: object
                  description: Authentication configuration for the endpoint
                  properties:
                    type:
                      type: string
                      description: Authentication type
                      enum:
                        - none
                        - bearer
                        - basic
                        - apiKey
                        - oauth2
                      default: bearer
                    secretRef:
                      type: object
                      description: Reference to a Secret containing credentials
                      properties:
                        name:
                          type: string
                          description: Secret name
                        key:
                          type: string
                          description: Key within the secret
                          default: token
                    headerName:
                      type: string
                      description: Header name for API key authentication
                      default: Authorization
                timeout:
                  type: string
                  description: Request timeout duration
                  default: "30s"
                  pattern: "^\\d+(s|m)$"
                rateLimit:
                  type: object
                  description: Rate limiting configuration
                  properties:
                    requestsPerMinute:
                      type: integer
                      minimum: 1
                      maximum: 10000
                      default: 60
                    burst:
                      type: integer
                      minimum: 1
                      maximum: 1000
                      default: 10
                enabled:
                  type: boolean
                  description: Whether the tool is enabled
                  default: true
            status:
              type: object
              properties:
                phase:
                  type: string
                  description: Current phase of the tool
                  enum:
                    - Pending
                    - Registered
                    - Error
                    - Disabled
                registeredAt:
                  type: string
                  format: date-time
                  description: When the tool was registered
                lastSyncedAt:
                  type: string
                  format: date-time
                  description: Last successful sync time
                invocationCount:
                  type: integer
                  description: Number of invocations
                  default: 0
                errorCount:
                  type: integer
                  description: Number of errors
                  default: 0
                lastError:
                  type: string
                  description: Last error message
                conditions:
                  type: array
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                        description: Condition type
                      status:
                        type: string
                        enum:
                          - "True"
                          - "False"
                          - Unknown
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
