{{- if and .Values.monitoring.enabled .Values.monitoring.alerting.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "stoa-platform.fullname" . }}-alertmanager-config
  namespace: {{ .Values.monitoring.namespace | default "monitoring" }}
  labels:
    {{- include "stoa-platform.labels" . | nindent 4 }}
type: Opaque
stringData:
  alertmanager.yml: |
    global:
      # Slack webhook URL (from secret)
      slack_api_url: {{ .Values.monitoring.alerting.slack.webhookUrl | default "${SLACK_WEBHOOK_URL}" | quote }}

      # Default resolve timeout
      resolve_timeout: 5m

    # Route tree
    route:
      # Default receiver
      receiver: slack-ops

      # Group alerts by these labels
      group_by: ['alertname', 'severity', 'slo']

      # Wait before sending first notification
      group_wait: 30s

      # Wait before sending notification about new alerts in group
      group_interval: 5m

      # Repeat interval for same alert
      repeat_interval: 4h

      # Child routes for specific severities
      routes:
        # Critical alerts - immediate notification
        - match:
            severity: critical
          receiver: slack-ops
          group_wait: 10s
          group_interval: 1m
          repeat_interval: 1h

        # Warning alerts - standard timing
        - match:
            severity: warning
          receiver: slack-ops
          group_wait: 1m
          group_interval: 5m
          repeat_interval: 4h

        # Info alerts - less urgent
        - match:
            severity: info
          receiver: slack-platform
          group_wait: 5m
          group_interval: 15m
          repeat_interval: 24h

    # Receivers
    receivers:
      # Primary ops channel
      - name: slack-ops
        slack_configs:
          - channel: {{ .Values.monitoring.alerting.slack.channel | default "#ops-alerts" | quote }}
            send_resolved: true
            username: 'STOA AlertManager'
            icon_emoji: ':rotating_light:'
            title: '{{ "{{" }} .Status | toUpper {{ "}}" }}{{ "{{" }} if eq .Status "firing" {{ "}}" }} :fire:{{ "{{" }} else {{ "}}" }} :white_check_mark:{{ "{{" }} end {{ "}}" }} {{ "{{" }} .CommonLabels.alertname {{ "}}" }}'
            text: |
              *Summary:* {{ "{{" }} .CommonAnnotations.summary {{ "}}" }}
              *Description:* {{ "{{" }} .CommonAnnotations.description {{ "}}" }}
              {{ "{{" }} if .CommonLabels.slo {{ "}}" }}*SLO:* {{ "{{" }} .CommonLabels.slo {{ "}}" }}{{ "{{" }} end {{ "}}" }}
              *Severity:* {{ "{{" }} .CommonLabels.severity {{ "}}" }}
              *Environment:* {{ "{{" }} .CommonLabels.environment | default "unknown" {{ "}}" }}
              {{ "{{" }} if .CommonAnnotations.runbook_url {{ "}}" }}*Runbook:* <{{ "{{" }} .CommonAnnotations.runbook_url {{ "}}" }}|View Runbook>{{ "{{" }} end {{ "}}" }}
            color: '{{ "{{" }} if eq .Status "firing" {{ "}}" }}{{ "{{" }} if eq .CommonLabels.severity "critical" {{ "}}" }}#FF0000{{ "{{" }} else if eq .CommonLabels.severity "warning" {{ "}}" }}#FFA500{{ "{{" }} else {{ "}}" }}#0000FF{{ "{{" }} end {{ "}}" }}{{ "{{" }} else {{ "}}" }}#00FF00{{ "{{" }} end {{ "}}" }}'
            actions:
              - type: button
                text: 'View in Grafana'
                url: '{{ .Values.monitoring.grafanaUrl | default "https://grafana.stoa.cab-i.com" }}/d/slo-dashboard'
              - type: button
                text: 'Silence Alert'
                url: '{{ .Values.monitoring.alertmanagerUrl | default "https://alertmanager.stoa.cab-i.com" }}/#/silences/new'

      # Platform team channel (less urgent)
      - name: slack-platform
        slack_configs:
          - channel: '#platform-team'
            send_resolved: true
            username: 'STOA AlertManager'
            icon_emoji: ':information_source:'
            title: '{{ "{{" }} .Status | toUpper {{ "}}" }}: {{ "{{" }} .CommonLabels.alertname {{ "}}" }}'
            text: |
              {{ "{{" }} .CommonAnnotations.summary {{ "}}" }}

      # Null receiver (for silencing)
      - name: 'null'

    # Inhibition rules
    inhibit_rules:
      # Don't send warnings if there's a critical for same alertname
      - source_match:
          severity: critical
        target_match:
          severity: warning
        equal: ['alertname']

      # Don't send SLO warnings if service is down
      - source_match:
          alertname: ControlPlaneAPIDown
        target_match:
          component: control-plane-api
        equal: ['component']

      - source_match:
          alertname: MCPGatewayDown
        target_match:
          component: mcp-gateway
        equal: ['component']
{{- end }}
