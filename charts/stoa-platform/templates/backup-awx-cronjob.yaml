{{- if and .Values.backup.enabled .Values.backup.awx.enabled }}
# =============================================================================
# AWX Database Backup CronJob
# =============================================================================
# STOA Platform - Phase 9.5 Production Readiness
# Daily backup of AWX PostgreSQL database to S3
# =============================================================================

apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-awx
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: backup-awx
    app.kubernetes.io/component: backup
    app.kubernetes.io/part-of: stoa-platform
    backup-type: database
  annotations:
    description: "Daily AWX PostgreSQL backup to S3"
spec:
  schedule: "{{ .Values.backup.awx.schedule | default "0 2 * * *" }}"
  timeZone: "{{ .Values.backup.timezone | default "Europe/Paris" }}"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: {{ .Values.backup.successfulJobsHistoryLimit | default 3 }}
  failedJobsHistoryLimit: {{ .Values.backup.failedJobsHistoryLimit | default 3 }}
  startingDeadlineSeconds: 600
  jobTemplate:
    spec:
      backoffLimit: {{ .Values.backup.awx.backoffLimit | default 2 }}
      ttlSecondsAfterFinished: {{ .Values.backup.ttlSecondsAfterFinished | default 86400 }}
      activeDeadlineSeconds: {{ .Values.backup.awx.activeDeadlineSeconds | default 3600 }}
      template:
        metadata:
          labels:
            app.kubernetes.io/name: backup-awx
            app.kubernetes.io/component: backup
          annotations:
            prometheus.io/scrape: "false"
        spec:
          serviceAccountName: {{ .Values.backup.serviceAccountName | default "stoa-backup" }}
          restartPolicy: Never
          {{- with .Values.backup.nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.backup.tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000
          containers:
            - name: backup
              image: "{{ .Values.backup.awx.image.repository | default "bitnami/postgresql" }}:{{ .Values.backup.awx.image.tag | default "15" }}"
              imagePullPolicy: {{ .Values.backup.awx.image.pullPolicy | default "IfNotPresent" }}
              command:
                - /bin/bash
                - -c
                - |
                  set -euo pipefail

                  echo "=========================================="
                  echo "AWX Database Backup"
                  echo "Date: $(date)"
                  echo "=========================================="

                  # Configuration
                  AWX_NAMESPACE="{{ .Values.backup.awx.namespace | default "awx" }}"
                  AWX_DB_NAME="{{ .Values.backup.awx.database | default "awx" }}"
                  AWX_DB_USER="{{ .Values.backup.awx.user | default "awx" }}"
                  BACKUP_DATE=$(date +%Y-%m-%d)
                  BACKUP_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                  BACKUP_FILENAME="awx-backup-${BACKUP_TIMESTAMP}.sql.gz"
                  S3_PATH="s3://${S3_BUCKET}/awx/${BACKUP_DATE}/${BACKUP_FILENAME}"

                  # Install AWS CLI if not present
                  if ! command -v aws &>/dev/null; then
                    echo "Installing AWS CLI..."
                    curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
                    unzip -q awscliv2.zip
                    ./aws/install --bin-dir /tmp/bin --install-dir /tmp/aws-cli
                    export PATH="/tmp/bin:$PATH"
                  fi

                  # Find PostgreSQL pod
                  echo "Finding AWX PostgreSQL pod..."
                  POSTGRES_POD=$(kubectl get pods -n "$AWX_NAMESPACE" \
                    -l "{{ .Values.backup.awx.podSelector | default "app.kubernetes.io/component=database" }}" \
                    -o jsonpath='{.items[0].metadata.name}')

                  if [[ -z "$POSTGRES_POD" ]]; then
                    echo "ERROR: Could not find AWX PostgreSQL pod"
                    exit 1
                  fi
                  echo "Found PostgreSQL pod: $POSTGRES_POD"

                  # Create temp directory
                  TEMP_DIR=$(mktemp -d)
                  trap "rm -rf $TEMP_DIR" EXIT

                  # Perform pg_dump
                  echo "Running pg_dump..."
                  kubectl exec -n "$AWX_NAMESPACE" "$POSTGRES_POD" -- \
                    pg_dump -U "$AWX_DB_USER" -d "$AWX_DB_NAME" --format=custom \
                    > "${TEMP_DIR}/awx-backup.dump"

                  # Compress
                  echo "Compressing backup..."
                  gzip -c "${TEMP_DIR}/awx-backup.dump" > "${TEMP_DIR}/${BACKUP_FILENAME}"
                  rm "${TEMP_DIR}/awx-backup.dump"

                  # Get backup size
                  BACKUP_SIZE=$(du -h "${TEMP_DIR}/${BACKUP_FILENAME}" | cut -f1)
                  echo "Backup size: $BACKUP_SIZE"

                  # Upload to S3
                  echo "Uploading to S3..."
                  aws s3 cp "${TEMP_DIR}/${BACKUP_FILENAME}" "$S3_PATH" \
                    --sse aws:kms \
                    {{- if .Values.backup.kmsKeyId }}
                    --sse-kms-key-id "{{ .Values.backup.kmsKeyId }}" \
                    {{- end }}
                    --only-show-errors

                  # Verify upload
                  echo "Verifying upload..."
                  aws s3 ls "$S3_PATH" || exit 1

                  # Send Slack notification on success
                  {{- if .Values.backup.slack.enabled }}
                  if [[ -n "${SLACK_WEBHOOK_URL:-}" ]]; then
                    curl -s -X POST -H 'Content-type: application/json' \
                      --data "{\"channel\": \"#ops-alerts\", \"username\": \"STOA Backup Bot\", \"icon_emoji\": \":floppy_disk:\", \"attachments\": [{\"color\": \"#36a64f\", \"text\": \":white_check_mark: *AWX Backup Success*\n*Size:* ${BACKUP_SIZE}\n*Path:* ${S3_PATH}\n*Environment:* ${ENVIRONMENT}\"}]}" \
                      "$SLACK_WEBHOOK_URL" || true
                  fi
                  {{- end }}

                  echo "=========================================="
                  echo "Backup completed successfully!"
                  echo "S3 Path: $S3_PATH"
                  echo "=========================================="
              env:
                - name: S3_BUCKET
                  value: "{{ .Values.backup.s3Bucket }}"
                - name: AWS_REGION
                  value: "{{ .Values.backup.awsRegion | default "eu-west-3" }}"
                - name: ENVIRONMENT
                  value: "{{ .Values.global.environment | default "dev" }}"
                {{- if .Values.backup.slack.enabled }}
                - name: SLACK_WEBHOOK_URL
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.backup.slack.secretName | default "slack-webhook" }}
                      key: {{ .Values.backup.slack.secretKey | default "webhook-url" }}
                      optional: true
                {{- end }}
              resources:
                requests:
                  cpu: {{ .Values.backup.awx.resources.requests.cpu | default "100m" }}
                  memory: {{ .Values.backup.awx.resources.requests.memory | default "256Mi" }}
                limits:
                  cpu: {{ .Values.backup.awx.resources.limits.cpu | default "500m" }}
                  memory: {{ .Values.backup.awx.resources.limits.memory | default "512Mi" }}
              volumeMounts:
                - name: tmp
                  mountPath: /tmp
          volumes:
            - name: tmp
              emptyDir:
                sizeLimit: 5Gi
{{- end }}
