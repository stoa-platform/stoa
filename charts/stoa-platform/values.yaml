# STOA Platform Helm Values
# =========================

# Gateway Configuration (CAB-958: Unified Gateway Architecture)
# See ADR-024: https://docs.gostoa.dev/architecture/adr/adr-024-gateway-unified-modes
# Currently runs Python mcp-gateway. Will migrate to Rust stoa-gateway Q4 2026.
gateway:
  # Current production image (Python mcp-gateway)
  image:
    repository: ghcr.io/hlfh/mcp-gateway
    tag: latest
    pullPolicy: IfNotPresent

  # Future: mode selection (not active yet, prepared for Rust gateway)
  # mode: edge-mcp  # edge-mcp | sidecar | proxy | shadow

  # Mode-specific configuration (prepared for future use)
  edgeMcp:
    enabled: true
    port: 3001
    mcpTimeout: 30s
    maxToolsPerRequest: 100

  sidecar:
    enabled: false
    primaryGateway: ""  # kong | envoy | apigee | webmethods
    metricsEnabled: true
    meteringEnabled: true

  proxy:
    enabled: false
    upstream: ""
    opaEndpoint: ""
    rateLimitEnabled: true

  shadow:
    enabled: false  # DEFERRED - requires security review (ADR-024)
    # targetBackend: ""
    # piiMaskingEnabled: true
    # retentionDays: 30

# Keycloak X509 Header Authentication (CAB-867)
# Configures NetworkPolicy for trusted proxy access.
# Keycloak itself is deployed externally; only the network policy is managed here.
keycloak:
  x509:
    enabled: true
    provider: nginx
    headerName: SSL_CLIENT_CERT
  trustedProxyCIDR: "10.0.0.0/8"  # F5 load balancer CIDR in production

# Gateway OpenAPI Sync Configuration
# Automatically syncs OpenAPI spec from Control-Plane-API to webMethods Gateway
gatewaySync:
  # Enable/disable automatic sync
  enabled: true

  # CronJob schedule (default: every 6 hours)
  schedule: "0 */6 * * *"

  # Image for the sync job
  image: curlimages/curl:8.5.0

  # Backend API URL (Control-Plane-API)
  backendUrl: "http://control-plane-api.stoa-system.svc.cluster.local:8000"

  # Gateway admin URL
  gatewayUrl: "http://apigateway.stoa-system.svc.cluster.local:5555"

  # API configuration
  apiName: "Control-Plane-API"
  apiVersion: "2.0"

  # Secret containing Gateway credentials (keys: username, password)
  credentialsSecret: "apigateway-credentials"

  # Service account for the job
  serviceAccount: "default"
