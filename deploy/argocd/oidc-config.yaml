# ArgoCD OIDC Configuration for Keycloak SSO
# This is applied via Ansible playbook or kubectl patch
# Reference: https://argo-cd.readthedocs.io/en/stable/operator-manual/user-management/keycloak/
#
# IMPORTANT: This configuration supports two authentication flows:
# 1. Direct SSO login via ArgoCD UI (standard OIDC flow)
# 2. API access via Control-Plane-API forwarding user's Keycloak token
#
# For flow #2 to work, we must NOT use enableUserInfoGroups because ArgoCD
# won't have the token in its session cache. Instead, we use JWT claims directly.
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-cm
    app.kubernetes.io/part-of: argocd
data:
  # ArgoCD URL - MUST match ingress hostname
  url: https://argocd.stoa.cab-i.com

  # OIDC Configuration for Keycloak
  # NOTE: Do NOT use enableUserInfoGroups - it breaks API token forwarding
  # from Control-Plane-API because ArgoCD tries to fetch userinfo with a
  # cached token that doesn't exist for forwarded tokens.
  oidc.config: |
    name: Keycloak
    issuer: https://auth.stoa.cab-i.com/realms/stoa
    clientID: argocd
    clientSecret: $oidc.keycloak.clientSecret
    requestedScopes:
      - openid
      - profile
      - email
      - roles
    # Accept tokens from multiple Keycloak clients (Console UI, Portal, etc.)
    allowedAudiences:
      - argocd
      - stoa-console
      - control-plane-api
      - control-plane-ui
      - stoa-portal
      - account
    # Skip audience check for tokens without explicit audience
    skipAudienceCheckWhenTokenHasNoAudience: true
    # Use PKCE for enhanced security
    codeChallenge: S256
    logoutURL: https://auth.stoa.cab-i.com/realms/stoa/protocol/openid-connect/logout?client_id=argocd&post_logout_redirect_uri=https://argocd.stoa.cab-i.com
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-rbac-cm
    app.kubernetes.io/part-of: argocd
data:
  # Default policy - all authenticated users get readonly access
  policy.default: role:authenticated

  # Use glob matching for flexible patterns
  policy.matchMode: glob

  # Scopes to use for RBAC
  # Uses tenant_id claim from Keycloak (contains group memberships like ["argocd-admins"])
  # This works with both direct SSO login and forwarded API tokens
  scopes: "[tenant_id, email]"

  # RBAC Policy
  policy.csv: |
    # ArgoCD RBAC Policy for Keycloak SSO
    # ===================================
    #
    # Group memberships come from the tenant_id claim in JWT tokens.
    # Users are assigned to Keycloak groups which map to ArgoCD roles.

    # Admin role - full access to all resources
    p, role:admin, applications, *, */*, allow
    p, role:admin, clusters, *, *, allow
    p, role:admin, repositories, *, *, allow
    p, role:admin, accounts, *, *, allow
    p, role:admin, certificates, *, *, allow
    p, role:admin, gpgkeys, *, *, allow
    p, role:admin, logs, *, *, allow
    p, role:admin, exec, create, */*, allow
    p, role:admin, projects, *, *, allow

    # Readonly role - view-only access
    p, role:readonly, applications, get, */*, allow
    p, role:readonly, clusters, get, *, allow
    p, role:readonly, repositories, get, *, allow
    p, role:readonly, projects, get, *, allow
    p, role:readonly, logs, get, */*, allow

    # DevOps role - deploy and sync applications
    p, role:devops, applications, get, */*, allow
    p, role:devops, applications, sync, */*, allow
    p, role:devops, applications, action/*, */*, allow
    p, role:devops, logs, get, */*, allow
    p, role:devops, repositories, get, *, allow
    p, role:devops, projects, get, *, allow

    # Group to role mappings (Keycloak groups via tenant_id claim)
    g, argocd-admins, role:admin
    g, argocd-devops, role:devops
    g, argocd-readonly, role:readonly

    # Authenticated users - baseline read access for all logged-in users
    # This enables Console UI to display platform status for any user
    p, role:authenticated, applications, get, */*, allow
    p, role:authenticated, clusters, get, *, allow
    p, role:authenticated, projects, get, *, allow
    g, *, role:authenticated
