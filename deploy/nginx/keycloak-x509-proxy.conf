# =============================================================================
# Nginx Reverse Proxy â€” X509 Header Injection for Keycloak (CAB-867)
# =============================================================================
# Terminates mTLS and forwards client certificate as HTTP headers,
# mimicking F5 behavior for local dev/demo environments.
#
# Usage: Mounted into the keycloak-proxy service in docker-compose.
# =============================================================================

upstream keycloak {
    server keycloak:8080;
}

server {
    listen 8443 ssl;
    server_name auth.local.gostoa.dev localhost;

    # --- Server TLS ---
    ssl_certificate     /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;

    # --- Client mTLS ---
    ssl_client_certificate /etc/nginx/certs/ca.crt;
    ssl_verify_client      optional;  # 'optional' for demo; use 'on' in prod

    # --- Proxy to Keycloak ---
    location / {
        proxy_pass http://keycloak;

        # Standard proxy headers
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # F5-compatible X509 headers (read by Keycloak x509cert-lookup SPI)
        proxy_set_header SSL_CLIENT_CERT        $ssl_client_escaped_cert;
        proxy_set_header SSL_CLIENT_VERIFY      $ssl_client_verify;
        proxy_set_header SSL_CLIENT_S_DN        $ssl_client_s_dn;
        proxy_set_header SSL_CLIENT_FINGERPRINT $ssl_client_fingerprint;
    }
}
