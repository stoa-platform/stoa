# JWT Validation Policy
# Validates OAuth2/OIDC tokens from Keycloak
#
# OAuth2 Best Practice:
# - `aud` (audience) = the Resource Server (API) that consumes the token
# - `azp` (authorized party) = the client application that requested the token
#
# All client applications (control-plane-ui, stoa-portal, etc.) should be
# configured with an Audience Mapper in Keycloak to include `aud: control-plane-api`
# in their access tokens. See: deploy/platform-bootstrap/scripts/configure-keycloak-audience.sh
#
apiVersion: stoa.io/v1
kind: Policy
metadata:
  name: jwt-validation
  description: "Validates JWT tokens from Keycloak OIDC"
  tags:
    - security
    - authentication

spec:
  type: jwt-validation
  order: 10

  config:
    # Keycloak OIDC configuration
    issuer: https://auth.${BASE_DOMAIN}/realms/stoa

    # Audience validation - only accept tokens intended for this API
    # Note: All clients should have Audience Mappers configured in Keycloak
    # to include 'control-plane-api' in the 'aud' claim of their access tokens.
    audience:
      - control-plane-api

    # JWKS endpoint for key validation
    jwksUri: https://auth.${BASE_DOMAIN}/realms/stoa/protocol/openid-connect/certs
    jwksCacheTime: 3600

    # Token validation rules
    validation:
      validateIssuer: true
      validateAudience: true
      validateExpiry: true
      clockSkew: 30  # seconds

    # Claims to extract and forward
    claims:
      - name: sub
        header: X-User-ID
      - name: email
        header: X-User-Email
      - name: tenant_id
        header: X-Tenant-ID
      - name: roles
        header: X-User-Roles
      - name: preferred_username
        header: X-Username

    # Error responses
    errors:
      missingToken:
        status: 401
        message: "Authorization header required"
      invalidToken:
        status: 401
        message: "Invalid or expired token"
      insufficientScope:
        status: 403
        message: "Insufficient permissions"
