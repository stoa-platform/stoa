---
# reconcile-webmethods.yml
# GitOps Reconciliation Playbook for webMethods Gateway
#
# Usage:
#   ansible-playbook reconcile-webmethods.yml -e "env=dev"
#   ansible-playbook reconcile-webmethods.yml -e "env=prod" --check  # Dry-run
#
# Triggered by:
#   - ArgoCD PostSync hook
#   - AWX Job Template
#   - GitLab CI webhook

- name: "Reconcile webMethods Gateway from Git"
  hosts: localhost
  gather_facts: false

  vars:
    # GitOps source directory (cloned by AWX/CI)
    gitops_dir: "{{ lookup('env', 'GITOPS_DIR') | default('/opt/stoa-gitops', true) }}"
    webmethods_dir: "{{ gitops_dir }}/webmethods"

    # Target environment
    env: "{{ lookup('env', 'STOA_ENV') | default('dev', true) }}"

    # webMethods Gateway API
    wm_gateway_url: "{{ lookup('env', 'WM_GATEWAY_URL') | default('http://apim-gateway:9072', true) }}"
    wm_admin_user: "{{ lookup('env', 'WM_ADMIN_USER') | default('Administrator', true) }}"
    wm_admin_password: "{{ lookup('env', 'WM_ADMIN_PASSWORD') }}"

    # Options
    dry_run: "{{ ansible_check_mode | default(false) }}"
    delete_orphans: "{{ lookup('env', 'DELETE_ORPHANS') | default('true', true) | bool }}"

  pre_tasks:
    - name: "Display parameters"
      ansible.builtin.debug:
        msg: |
          === webMethods Reconciliation ===
          Environment: {{ env }}
          GitOps Dir: {{ gitops_dir }}
          Gateway URL: {{ wm_gateway_url }}
          Dry Run: {{ dry_run }}
          Delete Orphans: {{ delete_orphans }}

    - name: "Verify GitOps directory exists"
      ansible.builtin.stat:
        path: "{{ webmethods_dir }}"
      register: gitops_check
      failed_when: not gitops_check.stat.exists

    - name: "Verify Gateway connectivity"
      ansible.builtin.uri:
        url: "{{ wm_gateway_url }}/rest/apigateway/health"
        method: GET
        user: "{{ wm_admin_user }}"
        password: "{{ wm_admin_password }}"
        force_basic_auth: true
        status_code: [200]
        timeout: 10
      register: health_check

  tasks:
    - name: "Load APIs from Git"
      ansible.builtin.include_tasks: tasks/load-git-apis.yml

    - name: "Fetch current APIs from Gateway"
      ansible.builtin.include_tasks: tasks/fetch-gateway-apis.yml

    - name: "Compute diff (Git vs Gateway)"
      ansible.builtin.include_tasks: tasks/compute-diff.yml

    - name: "Create new APIs"
      ansible.builtin.include_tasks: tasks/create-apis.yml
      when: apis_to_create | length > 0

    - name: "Update modified APIs"
      ansible.builtin.include_tasks: tasks/update-apis.yml
      when: apis_to_update | length > 0

    - name: "Delete orphaned APIs"
      ansible.builtin.include_tasks: tasks/delete-apis.yml
      when:
        - delete_orphans
        - apis_to_delete | length > 0

    - name: "Apply policies"
      ansible.builtin.include_tasks: tasks/apply-policies.yml

    - name: "Configure aliases"
      ansible.builtin.include_tasks: tasks/configure-aliases.yml

  post_tasks:
    - name: "Reconciliation summary"
      ansible.builtin.debug:
        msg: |
          === Summary ===
          APIs created: {{ apis_created | default([]) | length }}
          APIs updated: {{ apis_updated | default([]) | length }}
          APIs deleted: {{ apis_deleted | default([]) | length }}
          Policies applied: {{ policies_applied | default([]) | length }}
          Aliases configured: {{ aliases_configured | default([]) | length }}

          {% if dry_run %}
          DRY-RUN mode - No changes applied
          {% endif %}

    - name: "Send notification (if configured)"
      ansible.builtin.include_tasks: tasks/notify.yml
      when: lookup('env', 'NOTIFY_WEBHOOK_URL') | length > 0
