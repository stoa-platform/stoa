---
# tasks/load-git-apis.yml
# Load and parse all API YAML files from Git

- name: "Find all API YAML files"
  ansible.builtin.find:
    paths: "{{ webmethods_dir }}/apis"
    patterns: "*.yaml,*.yml"
    excludes: "_*"  # Ignore template files prefixed with _
  register: api_files

- name: "Load API file contents"
  ansible.builtin.slurp:
    src: "{{ item.path }}"
  loop: "{{ api_files.files }}"
  register: api_contents

- name: "Parse API YAML files"
  ansible.builtin.set_fact:
    git_apis: "{{ git_apis | default([]) + [item.content | b64decode | from_yaml] }}"
  loop: "{{ api_contents.results }}"
  when: item.content is defined

- name: "Load aliases for environment {{ env }}"
  ansible.builtin.slurp:
    src: "{{ webmethods_dir }}/aliases/{{ env }}.yaml"
  register: aliases_content
  ignore_errors: true

- name: "Parse aliases"
  ansible.builtin.set_fact:
    git_aliases: "{{ aliases_content.content | b64decode | from_yaml }}"
  when: aliases_content is succeeded

- name: "Find policy files"
  ansible.builtin.find:
    paths: "{{ webmethods_dir }}/policies"
    patterns: "*.yaml,*.yml"
  register: policy_files

- name: "Load policy file contents"
  ansible.builtin.slurp:
    src: "{{ item.path }}"
  loop: "{{ policy_files.files }}"
  register: policy_contents

- name: "Parse policy YAML files"
  ansible.builtin.set_fact:
    git_policies: "{{ git_policies | default({}) | combine({(item.content | b64decode | from_yaml).metadata.name: (item.content | b64decode | from_yaml)}) }}"
  loop: "{{ policy_contents.results }}"
  when: item.content is defined

- name: "Display APIs loaded from Git"
  ansible.builtin.debug:
    msg: |
      APIs found in Git: {{ git_apis | map(attribute='metadata.name') | list }}
      Policies: {{ git_policies.keys() | list }}
      Aliases ({{ env }}): {{ git_aliases.aliases.keys() | list if git_aliases is defined else 'Not found' }}
