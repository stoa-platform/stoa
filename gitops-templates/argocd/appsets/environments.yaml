# ApplicationSet for Environment-specific deployments
# ⚠️ DEPRECATED: Use chart/templates/appset-environments.yaml instead
#
# Deploy using Helm:
#   helm install argocd-appsets ./chart -n argocd
#
# Variables centralized in chart/values.yaml
#
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: environment-deployments
  namespace: ${ARGOCD_NAMESPACE:argocd}
spec:
  generators:
    - matrix:
        generators:
          - list:
              elements:
                - environment: dev
                  cluster: ${K8S_CLUSTER_URL:https://kubernetes.default.svc}
                  namespace_suffix: dev
                  auto_sync: true
                - environment: staging
                  cluster: ${K8S_CLUSTER_URL:https://kubernetes.default.svc}
                  namespace_suffix: staging
                  auto_sync: true
                - environment: prod
                  cluster: ${K8S_CLUSTER_URL:https://kubernetes.default.svc}
                  namespace_suffix: prod
                  auto_sync: false
          - git:
              repoURL: ${GITLAB_REPO_URL:https://gitlab.com/PotoMitan1/apim-gitops.git}
              revision: ${GITLAB_BRANCH:main}
              directories:
                - path: tenants/*

  template:
    metadata:
      name: '{{path.basename}}-{{environment}}'
      labels:
        tenant: '{{path.basename}}'
        environment: '{{environment}}'
        app.kubernetes.io/managed-by: argocd
    spec:
      project: '{{path.basename}}'
      source:
        repoURL: ${GITLAB_REPO_URL:https://gitlab.com/PotoMitan1/apim-gitops.git}
        targetRevision: ${GITLAB_BRANCH:main}
        path: 'tenants/{{path.basename}}'
        helm:
          valueFiles:
            - ../../environments/{{environment}}/config.yaml
            - environments/{{environment}}.yaml
      destination:
        server: '{{cluster}}'
        namespace: '${K8S_NAMESPACE_PREFIX:apim}-{{path.basename}}-{{namespace_suffix}}'
      syncPolicy:
        automated:
          prune: '{{auto_sync}}'
          selfHeal: '{{auto_sync}}'
        syncOptions:
          - CreateNamespace=true
