# ApplicationSet for Environment-specific deployments
# Manages deployments per environment (dev, staging, prod)
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: environment-deployments
  namespace: {{ .Values.argocd.namespace | default "argocd" }}
  labels:
    app.kubernetes.io/name: environment-deployments
    app.kubernetes.io/component: applicationset
    {{- include "argocd-appsets.labels" . | nindent 4 }}
spec:
  generators:
    - matrix:
        generators:
          - list:
              elements:
                {{- range .Values.environments }}
                - environment: {{ .name }}
                  cluster: {{ .cluster | default "https://kubernetes.default.svc" | quote }}
                  namespace_suffix: {{ .namespace_suffix }}
                  auto_sync: {{ .auto_sync | default false }}
                {{- end }}
          - git:
              repoURL: {{ include "argocd-appsets.gitlabRepoUrl" . }}
              revision: {{ .Values.gitlab.branch | default "main" }}
              directories:
                - path: tenants/*

  template:
    metadata:
      name: '{{`{{path.basename}}-{{environment}}`}}'
      labels:
        tenant: '{{`{{path.basename}}`}}'
        environment: '{{`{{environment}}`}}'
        app.kubernetes.io/managed-by: argocd
    spec:
      project: '{{`{{path.basename}}`}}'
      source:
        repoURL: {{ include "argocd-appsets.gitlabRepoUrl" . }}
        targetRevision: {{ .Values.gitlab.branch | default "main" }}
        path: 'tenants/{{`{{path.basename}}`}}'
        helm:
          valueFiles:
            - ../../environments/{{`{{environment}}`}}/config.yaml
            - environments/{{`{{environment}}`}}.yaml
      destination:
        server: '{{`{{cluster}}`}}'
        namespace: '{{ include "argocd-appsets.namespace" . }}-{{`{{path.basename}}-{{namespace_suffix}}`}}'
      syncPolicy:
        automated:
          prune: '{{`{{auto_sync}}`}}'
          selfHeal: '{{`{{auto_sync}}`}}'
        syncOptions:
          - CreateNamespace=true
