# Container & Kubernetes Security Checklist

> **Ticket**: CAB-236
> **Target**: STOA Platform EKS Infrastructure
> **Date**: YYYY-MM-DD
> **Tester**: [Name]

---

## CIS Kubernetes Benchmark Tests

### 1. Control Plane Components

| # | Test | Expected | Result | Notes |
|---|------|----------|--------|-------|
| 1.1.1 | API server anonymous-auth disabled | `--anonymous-auth=false` | ☐ Pass ☐ Fail | |
| 1.1.2 | API server audit logging enabled | Audit policy configured | ☐ Pass ☐ Fail | |
| 1.1.3 | API server TLS certificates | Valid certs | ☐ Pass ☐ Fail | |
| 1.1.4 | etcd encryption at rest | Encryption configured | ☐ Pass ☐ Fail | |
| 1.1.5 | RBAC authorization mode | `--authorization-mode=RBAC` | ☐ Pass ☐ Fail | |

### 2. Worker Node Security

| # | Test | Expected | Result | Notes |
|---|------|----------|--------|-------|
| 2.1.1 | Kubelet authentication | `--anonymous-auth=false` | ☐ Pass ☐ Fail | |
| 2.1.2 | Kubelet authorization | `--authorization-mode=Webhook` | ☐ Pass ☐ Fail | |
| 2.1.3 | Read-only port disabled | `--read-only-port=0` | ☐ Pass ☐ Fail | |
| 2.1.4 | Protect kernel defaults | `--protect-kernel-defaults=true` | ☐ Pass ☐ Fail | |

---

## Pod Security Standards (PSS)

### 3. Privileged Containers

| # | Test | Namespace | Result | Notes |
|---|------|-----------|--------|-------|
| 3.1.1 | No privileged containers | stoa-system | ☐ Pass ☐ Fail | |
| 3.1.2 | No privileged containers | stoa-tenants | ☐ Pass ☐ Fail | |
| 3.1.3 | PSS enforce label | All namespaces | ☐ Pass ☐ Fail | Level: |

### 4. Host Namespaces

| # | Test | Expected | Result | Notes |
|---|------|----------|--------|-------|
| 4.1.1 | hostNetwork disabled | false | ☐ Pass ☐ Fail | |
| 4.1.2 | hostPID disabled | false | ☐ Pass ☐ Fail | |
| 4.1.3 | hostIPC disabled | false | ☐ Pass ☐ Fail | |
| 4.1.4 | hostPath mounts restricted | No sensitive paths | ☐ Pass ☐ Fail | |

### 5. Capabilities

| # | Test | Expected | Result | Notes |
|---|------|----------|--------|-------|
| 5.1.1 | Drop all capabilities | CAP_DROP: ALL | ☐ Pass ☐ Fail | |
| 5.1.2 | No CAP_SYS_ADMIN | Not added | ☐ Pass ☐ Fail | |
| 5.1.3 | No CAP_NET_ADMIN | Not added | ☐ Pass ☐ Fail | |
| 5.1.4 | Minimal capabilities added | Only required | ☐ Pass ☐ Fail | |

### 6. Security Context

| # | Test | Expected | Result | Notes |
|---|------|----------|--------|-------|
| 6.1.1 | runAsNonRoot | true | ☐ Pass ☐ Fail | |
| 6.1.2 | runAsUser | Non-0 UID | ☐ Pass ☐ Fail | |
| 6.1.3 | readOnlyRootFilesystem | true | ☐ Pass ☐ Fail | |
| 6.1.4 | allowPrivilegeEscalation | false | ☐ Pass ☐ Fail | |
| 6.1.5 | seccompProfile | RuntimeDefault | ☐ Pass ☐ Fail | |

---

## RBAC Configuration

### 7. Service Accounts

| # | Test | ServiceAccount | Result | Notes |
|---|------|----------------|--------|-------|
| 7.1.1 | automountServiceAccountToken | control-plane-api | ☐ Pass ☐ Fail | |
| 7.1.2 | automountServiceAccountToken | mcp-gateway | ☐ Pass ☐ Fail | |
| 7.1.3 | No default SA usage | All pods | ☐ Pass ☐ Fail | |

### 8. Role Bindings

| # | Test | Expected | Result | Notes |
|---|------|----------|--------|-------|
| 8.1.1 | No unnecessary cluster-admin | Minimal bindings | ☐ Pass ☐ Fail | |
| 8.1.2 | Namespace-scoped roles | Role vs ClusterRole | ☐ Pass ☐ Fail | |
| 8.1.3 | Least privilege principle | Minimal permissions | ☐ Pass ☐ Fail | |
| 8.1.4 | No wildcard permissions | No `*` resources | ☐ Pass ☐ Fail | |

### 9. STOA Service Account Permissions

| Resource | control-plane-api | mcp-gateway | Expected |
|----------|-------------------|-------------|----------|
| secrets | ☐ get ☐ list ☐ create | ☐ get ☐ list ☐ create | get only |
| configmaps | ☐ get ☐ list ☐ create | ☐ get ☐ list ☐ create | get/list |
| pods | ☐ get ☐ list ☐ create | ☐ get ☐ list ☐ create | None |
| deployments | ☐ get ☐ list ☐ create | ☐ get ☐ list ☐ create | None |
| tools.stoa.cab-i.com | ☐ get ☐ list ☐ watch | ☐ get ☐ list ☐ watch | MCP: all |

---

## Network Security

### 10. Network Policies

| # | Test | Namespace | Result | Notes |
|---|------|-----------|--------|-------|
| 10.1.1 | Default deny ingress | stoa-system | ☐ Pass ☐ Fail | |
| 10.1.2 | Default deny egress | stoa-system | ☐ Pass ☐ Fail | |
| 10.1.3 | Explicit allow rules | Required traffic only | ☐ Pass ☐ Fail | |
| 10.1.4 | Cross-namespace blocked | Tenant isolation | ☐ Pass ☐ Fail | |

### 11. Service Mesh / Ingress

| # | Test | Expected | Result | Notes |
|---|------|----------|--------|-------|
| 11.1.1 | TLS termination | At ALB/Ingress | ☐ Pass ☐ Fail | |
| 11.1.2 | mTLS between services | Optional | ☐ Pass ☐ Fail ☐ N/A | |
| 11.1.3 | Ingress authentication | OIDC/Keycloak | ☐ Pass ☐ Fail | |

---

## Secrets Management

### 12. Kubernetes Secrets

| # | Test | Expected | Result | Notes |
|---|------|----------|--------|-------|
| 12.1.1 | etcd encryption enabled | Encrypted at rest | ☐ Pass ☐ Fail | |
| 12.1.2 | No secrets in env vars | Use volumes | ☐ Pass ☐ Fail | |
| 12.1.3 | External secrets operator | Vault integration | ☐ Pass ☐ Fail | |
| 12.1.4 | Secret rotation | Automated | ☐ Pass ☐ Fail | |

### 13. Vault Integration

| # | Test | Expected | Result | Notes |
|---|------|----------|--------|-------|
| 13.1.1 | Vault agent injector | Configured | ☐ Pass ☐ Fail | |
| 13.1.2 | Auto-unseal | KMS configured | ☐ Pass ☐ Fail | |
| 13.1.3 | AppRole authentication | For workloads | ☐ Pass ☐ Fail | |
| 13.1.4 | Dynamic secrets | Database credentials | ☐ Pass ☐ Fail | |

---

## Container Images

### 14. Image Security

| # | Test | Image | Result | Notes |
|---|------|-------|--------|-------|
| 14.1.1 | No latest tag | control-plane-api | ☐ Pass ☐ Fail | |
| 14.1.2 | No latest tag | mcp-gateway | ☐ Pass ☐ Fail | |
| 14.1.3 | Signed images | All images | ☐ Pass ☐ Fail | |
| 14.1.4 | Private registry | ECR | ☐ Pass ☐ Fail | |
| 14.1.5 | No root user in image | Dockerfile USER | ☐ Pass ☐ Fail | |

### 15. Vulnerability Scanning

| # | Test | Tool | Result | Notes |
|---|------|------|--------|-------|
| 15.1.1 | Trivy scan | control-plane-api | ☐ Pass ☐ Fail | Critical: |
| 15.1.2 | Trivy scan | mcp-gateway | ☐ Pass ☐ Fail | Critical: |
| 15.1.3 | Base image vulnerabilities | All images | ☐ Pass ☐ Fail | |
| 15.1.4 | Dependency vulnerabilities | pip/npm | ☐ Pass ☐ Fail | |

---

## Resource Management

### 16. Resource Limits

| # | Test | Pod | Result | Notes |
|---|------|-----|--------|-------|
| 16.1.1 | CPU limits set | control-plane-api | ☐ Pass ☐ Fail | |
| 16.1.2 | Memory limits set | control-plane-api | ☐ Pass ☐ Fail | |
| 16.1.3 | CPU limits set | mcp-gateway | ☐ Pass ☐ Fail | |
| 16.1.4 | Memory limits set | mcp-gateway | ☐ Pass ☐ Fail | |

### 17. Resource Quotas

| # | Test | Namespace | Result | Notes |
|---|------|-----------|--------|-------|
| 17.1.1 | ResourceQuota defined | stoa-system | ☐ Pass ☐ Fail | |
| 17.1.2 | LimitRange defined | stoa-system | ☐ Pass ☐ Fail | |
| 17.1.3 | Pod count limit | Tenant namespaces | ☐ Pass ☐ Fail | |

---

## AWS EKS Specific

### 18. EKS Configuration

| # | Test | Expected | Result | Notes |
|---|------|----------|--------|-------|
| 18.1.1 | Private endpoint enabled | true | ☐ Pass ☐ Fail | |
| 18.1.2 | Public endpoint restricted | Limited CIDRs | ☐ Pass ☐ Fail | |
| 18.1.3 | Secrets encryption | KMS key | ☐ Pass ☐ Fail | |
| 18.1.4 | Control plane logging | All types enabled | ☐ Pass ☐ Fail | |
| 18.1.5 | IRSA configured | Pod IAM roles | ☐ Pass ☐ Fail | |

### 19. Node Security

| # | Test | Expected | Result | Notes |
|---|------|----------|--------|-------|
| 19.1.1 | IMDS v2 enforced | HttpTokens=required | ☐ Pass ☐ Fail | |
| 19.1.2 | Node IAM role minimal | Least privilege | ☐ Pass ☐ Fail | |
| 19.1.3 | SSH access disabled | No key pair | ☐ Pass ☐ Fail | |
| 19.1.4 | Security group restricted | EKS managed | ☐ Pass ☐ Fail | |

---

## Testing Commands

### Check Privileged Containers
```bash
kubectl get pods -A -o json | jq '.items[] | select(.spec.containers[].securityContext.privileged==true) | .metadata.name'
```

### Check Host Namespaces
```bash
kubectl get pods -A -o json | jq '.items[] | select(.spec.hostNetwork==true or .spec.hostPID==true or .spec.hostIPC==true) | "\(.metadata.namespace)/\(.metadata.name)"'
```

### Check Service Account Permissions
```bash
kubectl auth can-i --list --as=system:serviceaccount:stoa-system:control-plane-api
```

### Check Network Policies
```bash
kubectl get networkpolicies -A -o wide
```

### Scan Images with Trivy
```bash
trivy image stoa/control-plane-api:latest --severity CRITICAL,HIGH
```

---

## Summary

### Statistics

| Category | Tested | Passed | Failed | N/A |
|----------|--------|--------|--------|-----|
| Control Plane | | | | |
| Pod Security | | | | |
| RBAC | | | | |
| Network | | | | |
| Secrets | | | | |
| Images | | | | |
| Resources | | | | |
| EKS | | | | |
| **Total** | | | | |

### Critical Findings

1.
2.
3.

### Recommendations

1.
2.
3.

---

## References

- [CIS Kubernetes Benchmark](https://www.cisecurity.org/benchmark/kubernetes)
- [NSA/CISA Kubernetes Hardening Guide](https://media.defense.gov/2022/Aug/29/2003066362/-1/-1/0/CTR_KUBERNETES_HARDENING_GUIDANCE_1.2_20220829.PDF)
- [EKS Best Practices Guide](https://aws.github.io/aws-eks-best-practices/security/docs/)
- [Pod Security Standards](https://kubernetes.io/docs/concepts/security/pod-security-standards/)
