# OWASP API Security Top 10 (2023) Checklist

> **Ticket**: CAB-236
> **Target**: STOA Platform APIs
> **Date**: YYYY-MM-DD
> **Tester**: [Name]

---

## API1:2023 - Broken Object Level Authorization (BOLA)

### Description
APIs expose endpoints that handle object identifiers, creating a wide attack surface Level Access Control issue.

### Tests

| # | Test | Endpoint | Result | Notes |
|---|------|----------|--------|-------|
| 1.1 | Access other tenant's API by ID | `GET /v1/apis/{other_tenant_api_id}` | ☐ Pass ☐ Fail | |
| 1.2 | Access other tenant's application | `GET /v1/applications/{id}` | ☐ Pass ☐ Fail | |
| 1.3 | Modify other tenant's resource | `PUT /v1/apis/{id}` | ☐ Pass ☐ Fail | |
| 1.4 | Delete other tenant's resource | `DELETE /v1/apis/{id}` | ☐ Pass ☐ Fail | |
| 1.5 | Access deployment from other tenant | `GET /v1/deployments/{id}` | ☐ Pass ☐ Fail | |
| 1.6 | Enumerate sequential IDs | Various endpoints | ☐ Pass ☐ Fail | |
| 1.7 | UUID predictability | Create multiple, analyze | ☐ Pass ☐ Fail | |

### Script
```bash
./scripts/test-bola-idor.sh
```

---

## API2:2023 - Broken Authentication

### Description
Authentication mechanisms are often implemented incorrectly, allowing attackers to compromise tokens or exploit implementation flaws.

### Tests

| # | Test | Method | Result | Notes |
|---|------|--------|--------|-------|
| 2.1 | JWT 'none' algorithm | Modify alg header | ☐ Pass ☐ Fail | |
| 2.2 | JWT algorithm confusion | RS256 -> HS256 | ☐ Pass ☐ Fail | |
| 2.3 | JWT kid injection | SQL/Path traversal | ☐ Pass ☐ Fail | |
| 2.4 | Weak JWT secret | Brute force | ☐ Pass ☐ Fail | |
| 2.5 | Token reuse after logout | Keep old token | ☐ Pass ☐ Fail | |
| 2.6 | Expired token handling | Use old token | ☐ Pass ☐ Fail | |
| 2.7 | Account lockout | 10+ failed logins | ☐ Pass ☐ Fail | |
| 2.8 | Password reset flow | Token predictability | ☐ Pass ☐ Fail | |
| 2.9 | Session fixation | Reuse session ID | ☐ Pass ☐ Fail | |

### Script
```bash
./scripts/test-auth-bypass.sh
```

---

## API3:2023 - Broken Object Property Level Authorization

### Description
Lack of or improper authorization validation at object property level, leading to information exposure or manipulation.

### Tests

| # | Test | Method | Result | Notes |
|---|------|--------|--------|-------|
| 3.1 | Mass assignment - is_admin | POST /users with is_admin:true | ☐ Pass ☐ Fail | |
| 3.2 | Mass assignment - tenant_id | Create with different tenant | ☐ Pass ☐ Fail | |
| 3.3 | Mass assignment - owner | Set arbitrary owner | ☐ Pass ☐ Fail | |
| 3.4 | Modify read-only fields | created_at, id | ☐ Pass ☐ Fail | |
| 3.5 | Access internal fields | Internal status codes | ☐ Pass ☐ Fail | |
| 3.6 | Expose sensitive data | Password hashes, tokens | ☐ Pass ☐ Fail | |

### Test Payloads
```json
// Try adding these fields to POST/PUT requests
{"is_admin": true}
{"role": "admin"}
{"tenant_id": "other-tenant"}
{"owner": "admin@company.com"}
{"created_at": "2020-01-01"}
{"internal_status": "approved"}
```

---

## API4:2023 - Unrestricted Resource Consumption

### Description
API does not restrict the size or number of resources that can be requested by clients.

### Tests

| # | Test | Method | Result | Notes |
|---|------|--------|--------|-------|
| 4.1 | Rate limiting - unauthenticated | 100+ requests | ☐ Pass ☐ Fail | Limit: |
| 4.2 | Rate limiting - authenticated | 100+ requests | ☐ Pass ☐ Fail | Limit: |
| 4.3 | X-Forwarded-For bypass | Different IPs | ☐ Pass ☐ Fail | |
| 4.4 | Large payload | 10MB+ body | ☐ Pass ☐ Fail | |
| 4.5 | Large response | Request all records | ☐ Pass ☐ Fail | |
| 4.6 | Pagination bypass | limit=999999 | ☐ Pass ☐ Fail | |
| 4.7 | Deep JSON nesting | 100+ levels | ☐ Pass ☐ Fail | |
| 4.8 | GraphQL batching | Multiple queries | ☐ Pass ☐ Fail | |

### Test Commands
```bash
# Rate limit test
for i in {1..100}; do curl -s -o /dev/null -w "%{http_code}\n" $API_URL/v1/health; done

# X-Forwarded-For bypass
for i in {1..100}; do curl -H "X-Forwarded-For: 10.0.0.$i" $API_URL/v1/health; done

# Large pagination
curl "$API_URL/v1/apis?limit=999999&offset=0"
```

---

## API5:2023 - Broken Function Level Authorization

### Description
Complex access control policies with different hierarchies, groups, and roles, and unclear separation between admin and regular functions.

### Tests

| # | Test | User Role | Endpoint | Result | Notes |
|---|------|-----------|----------|--------|-------|
| 5.1 | Viewer -> Create API | viewer | POST /v1/apis | ☐ Pass ☐ Fail | |
| 5.2 | Viewer -> Delete API | viewer | DELETE /v1/apis/{id} | ☐ Pass ☐ Fail | |
| 5.3 | DevOps -> Delete API | devops | DELETE /v1/apis/{id} | ☐ Pass ☐ Fail | |
| 5.4 | Tenant Admin -> Platform Admin | tenant-admin | GET /v1/tenants | ☐ Pass ☐ Fail | |
| 5.5 | Tenant Admin -> Create Tenant | tenant-admin | POST /v1/tenants | ☐ Pass ☐ Fail | |
| 5.6 | Access admin endpoints | any | /admin/* | ☐ Pass ☐ Fail | |
| 5.7 | HTTP method tampering | any | POST -> PUT/DELETE | ☐ Pass ☐ Fail | |

### Expected RBAC Matrix

| Endpoint | cpi-admin | tenant-admin | devops | viewer |
|----------|-----------|--------------|--------|--------|
| GET /v1/apis | ✓ | ✓ | ✓ | ✓ |
| POST /v1/apis | ✓ | ✓ | ✓ | ✗ |
| DELETE /v1/apis | ✓ | ✓ | ✗ | ✗ |
| GET /v1/tenants | ✓ | ✗ | ✗ | ✗ |
| POST /v1/tenants | ✓ | ✗ | ✗ | ✗ |

---

## API6:2023 - Unrestricted Access to Sensitive Business Flows

### Description
APIs exposing business flows without compensating controls, allowing attackers to abuse or automate access.

### Tests

| # | Test | Flow | Result | Notes |
|---|------|------|--------|-------|
| 6.1 | Automated API creation | Create 100 APIs | ☐ Pass ☐ Fail | |
| 6.2 | Automated user registration | Create 100 users | ☐ Pass ☐ Fail | |
| 6.3 | Password reset abuse | 100 reset requests | ☐ Pass ☐ Fail | |
| 6.4 | Deployment spam | 100 deployments | ☐ Pass ☐ Fail | |
| 6.5 | Resource exhaustion | Fill quotas | ☐ Pass ☐ Fail | |

---

## API7:2023 - Server Side Request Forgery (SSRF)

### Description
SSRF flaws occur when an API fetches a remote resource without validating the user-supplied URL.

### Tests

| # | Test | Endpoint | Result | Notes |
|---|------|----------|--------|-------|
| 7.1 | Internal IP access | webhook_url=http://169.254.169.254 | ☐ Pass ☐ Fail | |
| 7.2 | Localhost access | callback=http://localhost:8080 | ☐ Pass ☐ Fail | |
| 7.3 | Internal service access | url=http://vault:8200 | ☐ Pass ☐ Fail | |
| 7.4 | Protocol smuggling | url=file:///etc/passwd | ☐ Pass ☐ Fail | |
| 7.5 | DNS rebinding | url=http://attacker.rebind.com | ☐ Pass ☐ Fail | |

### Test Payloads
```bash
# AWS metadata
curl -d '{"url":"http://169.254.169.254/latest/meta-data/"}' $API_URL/v1/webhooks/test

# Internal services
curl -d '{"url":"http://vault.stoa-system:8200/v1/sys/health"}' $API_URL/v1/webhooks/test

# File protocol
curl -d '{"url":"file:///etc/passwd"}' $API_URL/v1/import
```

---

## API8:2023 - Security Misconfiguration

### Description
Poor configuration of the API and supporting infrastructure can lead to various attacks.

### Tests

| # | Test | Check | Result | Notes |
|---|------|-------|--------|-------|
| 8.1 | CORS misconfiguration | Origin: * | ☐ Pass ☐ Fail | |
| 8.2 | Missing security headers | CSP, HSTS, X-Frame | ☐ Pass ☐ Fail | |
| 8.3 | Verbose error messages | Stack traces exposed | ☐ Pass ☐ Fail | |
| 8.4 | Debug mode enabled | Debug endpoints | ☐ Pass ☐ Fail | |
| 8.5 | Default credentials | admin/admin | ☐ Pass ☐ Fail | |
| 8.6 | Exposed sensitive endpoints | /metrics, /debug | ☐ Pass ☐ Fail | |
| 8.7 | TLS configuration | Weak ciphers | ☐ Pass ☐ Fail | |
| 8.8 | HTTP methods allowed | OPTIONS, TRACE | ☐ Pass ☐ Fail | |

### Security Headers Checklist
```
☐ Strict-Transport-Security
☐ Content-Security-Policy
☐ X-Content-Type-Options
☐ X-Frame-Options
☐ X-XSS-Protection (deprecated but check)
☐ Referrer-Policy
☐ Permissions-Policy
```

---

## API9:2023 - Improper Inventory Management

### Description
APIs tend to expose more endpoints than traditional web applications, making proper documentation and inventory management important.

### Tests

| # | Test | Method | Result | Notes |
|---|------|--------|--------|-------|
| 9.1 | Old API versions | /v0/, /v1-beta/ | ☐ Pass ☐ Fail | |
| 9.2 | Undocumented endpoints | Fuzzing | ☐ Pass ☐ Fail | |
| 9.3 | Debug/test endpoints | /debug, /test | ☐ Pass ☐ Fail | |
| 9.4 | Exposed API documentation | /docs, /swagger | ☐ Pass ☐ Fail | |
| 9.5 | API version disclosure | Headers, responses | ☐ Pass ☐ Fail | |
| 9.6 | Shadow APIs | Different subdomains | ☐ Pass ☐ Fail | |

### Endpoint Discovery
```bash
# Fuzz for endpoints
ffuf -u https://api.staging.gostoa.dev/FUZZ -w /usr/share/seclists/Discovery/Web-Content/api/api-endpoints.txt

# Check old versions
for v in v0 v1-beta v2-alpha internal; do
  curl -s -o /dev/null -w "%{http_code} $v\n" "https://api.staging.gostoa.dev/$v/health"
done
```

---

## API10:2023 - Unsafe Consumption of APIs

### Description
Developers trust data received from third-party APIs more than user input, adopting weaker security standards.

### Tests

| # | Test | Integration | Result | Notes |
|---|------|-------------|--------|-------|
| 10.1 | Webhook payload injection | External callback | ☐ Pass ☐ Fail | |
| 10.2 | OAuth callback tampering | Keycloak redirects | ☐ Pass ☐ Fail | |
| 10.3 | Import data sanitization | External API data | ☐ Pass ☐ Fail | |
| 10.4 | Third-party TLS validation | Certificate pinning | ☐ Pass ☐ Fail | |

---

## Summary

### Statistics

| Category | Tested | Passed | Failed | N/A |
|----------|--------|--------|--------|-----|
| API1 - BOLA | | | | |
| API2 - Auth | | | | |
| API3 - Property Auth | | | | |
| API4 - Resource Consumption | | | | |
| API5 - Function Auth | | | | |
| API6 - Business Flows | | | | |
| API7 - SSRF | | | | |
| API8 - Misconfiguration | | | | |
| API9 - Inventory | | | | |
| API10 - Unsafe Consumption | | | | |
| **Total** | | | | |

### Critical Findings

1.
2.
3.

### Recommendations

1.
2.
3.

---

## References

- [OWASP API Security Top 10 2023](https://owasp.org/API-Security/editions/2023/en/0x00-header/)
- [OWASP API Security Project](https://owasp.org/www-project-api-security/)
- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/)
