#!/bin/bash
# STOA Platform - BOLA/IDOR Testing Script
# Ticket: CAB-236
#
# Tests Broken Object Level Authorization and Insecure Direct Object References
# IMPORTANT: Only run against authorized test environments

set -e

# Configuration
API_URL="${API_URL:-https://api.staging.gostoa.dev}"
KEYCLOAK_URL="${KEYCLOAK_URL:-https://auth.staging.gostoa.dev}"
REALM="${REALM:-stoa}"
CLIENT_ID="${CLIENT_ID:-stoa-ui}"
OUTPUT_DIR="${OUTPUT_DIR:-./results/bola-idor}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

mkdir -p "$OUTPUT_DIR"

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_finding() {
    echo -e "${RED}[FINDING]${NC} $1"
    echo "[$(date -Iseconds)] FINDING: $1" >> "$OUTPUT_DIR/findings.log"
}

# -----------------------------------------------------------------------------
# Helper: Get Token for User
# -----------------------------------------------------------------------------
get_token() {
    local username=$1
    local password=$2

    local response=$(curl -s -X POST "$KEYCLOAK_URL/realms/$REALM/protocol/openid-connect/token" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "grant_type=password" \
        -d "client_id=$CLIENT_ID" \
        -d "username=$username" \
        -d "password=$password")

    echo "$response" | jq -r '.access_token // empty'
}

# -----------------------------------------------------------------------------
# Test 1: Cross-Tenant API Access
# -----------------------------------------------------------------------------
test_cross_tenant_api_access() {
    log_info "Testing cross-tenant API access..."

    if [ -z "$TENANT_A_TOKEN" ] || [ -z "$TENANT_B_TOKEN" ]; then
        log_warn "Requires TENANT_A_TOKEN and TENANT_B_TOKEN"
        return
    fi

    # Get Tenant A's APIs
    log_info "Fetching Tenant A's APIs..."
    TENANT_A_APIS=$(curl -s -H "Authorization: Bearer $TENANT_A_TOKEN" \
        "$API_URL/v1/apis")

    echo "$TENANT_A_APIS" | jq . > "$OUTPUT_DIR/tenant-a-apis.json"

    # Extract first API ID from Tenant A
    TENANT_A_API_ID=$(echo "$TENANT_A_APIS" | jq -r '.[0].id // empty')

    if [ -z "$TENANT_A_API_ID" ]; then
        log_warn "No APIs found for Tenant A"
        return
    fi

    log_info "Tenant A API ID: $TENANT_A_API_ID"

    # Try to access Tenant A's API with Tenant B's token
    log_info "Attempting to access Tenant A's API with Tenant B's token..."

    CROSS_ACCESS=$(curl -s -w "\n%{http_code}" \
        -H "Authorization: Bearer $TENANT_B_TOKEN" \
        "$API_URL/v1/apis/$TENANT_A_API_ID")

    HTTP_CODE=$(echo "$CROSS_ACCESS" | tail -1)
    RESPONSE_BODY=$(echo "$CROSS_ACCESS" | sed '$d')

    if [ "$HTTP_CODE" = "200" ]; then
        log_finding "CRITICAL: Cross-tenant API access successful (BOLA vulnerability)"
        echo "Tenant B accessed Tenant A's API: $TENANT_A_API_ID" >> "$OUTPUT_DIR/bola-findings.txt"
        echo "Response: $RESPONSE_BODY" >> "$OUTPUT_DIR/bola-findings.txt"
    elif [ "$HTTP_CODE" = "403" ] || [ "$HTTP_CODE" = "404" ]; then
        log_info "Cross-tenant access properly blocked (HTTP $HTTP_CODE)"
    else
        log_warn "Unexpected response: HTTP $HTTP_CODE"
    fi
}

# -----------------------------------------------------------------------------
# Test 2: Cross-Tenant Application Access
# -----------------------------------------------------------------------------
test_cross_tenant_application_access() {
    log_info "Testing cross-tenant application access..."

    if [ -z "$TENANT_A_TOKEN" ] || [ -z "$TENANT_B_TOKEN" ]; then
        log_warn "Requires TENANT_A_TOKEN and TENANT_B_TOKEN"
        return
    fi

    # Get Tenant A's applications
    TENANT_A_APPS=$(curl -s -H "Authorization: Bearer $TENANT_A_TOKEN" \
        "$API_URL/v1/applications")

    echo "$TENANT_A_APPS" | jq . > "$OUTPUT_DIR/tenant-a-applications.json"

    TENANT_A_APP_ID=$(echo "$TENANT_A_APPS" | jq -r '.[0].id // empty')

    if [ -z "$TENANT_A_APP_ID" ]; then
        log_warn "No applications found for Tenant A"
        return
    fi

    log_info "Testing access to application: $TENANT_A_APP_ID"

    # Test various operations
    OPERATIONS=(
        "GET /v1/applications/$TENANT_A_APP_ID"
        "DELETE /v1/applications/$TENANT_A_APP_ID"
        "PUT /v1/applications/$TENANT_A_APP_ID"
    )

    for op in "${OPERATIONS[@]}"; do
        METHOD=$(echo "$op" | cut -d' ' -f1)
        ENDPOINT=$(echo "$op" | cut -d' ' -f2)

        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X "$METHOD" \
            -H "Authorization: Bearer $TENANT_B_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"name":"hacked"}' \
            "$API_URL$ENDPOINT" 2>/dev/null)

        if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "204" ]; then
            log_finding "CRITICAL: $METHOD $ENDPOINT succeeded with cross-tenant token"
        else
            log_info "$METHOD $ENDPOINT blocked (HTTP $RESPONSE)"
        fi
    done
}

# -----------------------------------------------------------------------------
# Test 3: Tenant Data Access via Direct ID
# -----------------------------------------------------------------------------
test_direct_tenant_access() {
    log_info "Testing direct tenant data access..."

    if [ -z "$TENANT_B_TOKEN" ]; then
        log_warn "Requires TENANT_B_TOKEN"
        return
    fi

    # Try to access tenant endpoint with guessed IDs
    TENANT_IDS=(
        "1"
        "2"
        "admin"
        "00000000-0000-0000-0000-000000000001"
        "tenant-a"
        "tenant-acme"
    )

    for tenant_id in "${TENANT_IDS[@]}"; do
        RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $TENANT_B_TOKEN" \
            "$API_URL/v1/tenants/$tenant_id")

        HTTP_CODE=$(echo "$RESPONSE" | tail -1)

        if [ "$HTTP_CODE" = "200" ]; then
            log_finding "Accessed tenant $tenant_id with different tenant's token"
            echo "Accessed tenant: $tenant_id" >> "$OUTPUT_DIR/tenant-access.txt"
        else
            log_info "Tenant $tenant_id access blocked (HTTP $HTTP_CODE)"
        fi
    done
}

# -----------------------------------------------------------------------------
# Test 4: Deployment ID Enumeration
# -----------------------------------------------------------------------------
test_deployment_enumeration() {
    log_info "Testing deployment ID enumeration..."

    if [ -z "$TENANT_B_TOKEN" ]; then
        log_warn "Requires TENANT_B_TOKEN"
        return
    fi

    # Try sequential IDs
    for i in $(seq 1 20); do
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $TENANT_B_TOKEN" \
            "$API_URL/v1/deployments/$i" 2>/dev/null)

        if [ "$RESPONSE" = "200" ]; then
            log_finding "Accessed deployment ID $i - Potential IDOR"
        fi
    done

    # Try UUID patterns
    UUID_PATTERNS=(
        "00000000-0000-0000-0000-000000000001"
        "11111111-1111-1111-1111-111111111111"
    )

    for uuid in "${UUID_PATTERNS[@]}"; do
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $TENANT_B_TOKEN" \
            "$API_URL/v1/deployments/$uuid" 2>/dev/null)

        if [ "$RESPONSE" = "200" ]; then
            log_finding "Accessed deployment UUID $uuid - Potential IDOR"
        fi
    done
}

# -----------------------------------------------------------------------------
# Test 5: Horizontal Privilege Escalation
# -----------------------------------------------------------------------------
test_horizontal_privilege_escalation() {
    log_info "Testing horizontal privilege escalation..."

    if [ -z "$VIEWER_TOKEN" ]; then
        log_warn "Requires VIEWER_TOKEN"
        return
    fi

    # Viewer trying to modify resources
    WRITE_ENDPOINTS=(
        "POST /v1/apis"
        "POST /v1/applications"
        "POST /v1/deployments"
        "PUT /v1/apis/1"
        "DELETE /v1/apis/1"
    )

    for endpoint in "${WRITE_ENDPOINTS[@]}"; do
        METHOD=$(echo "$endpoint" | cut -d' ' -f1)
        PATH=$(echo "$endpoint" | cut -d' ' -f2)

        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X "$METHOD" \
            -H "Authorization: Bearer $VIEWER_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"name":"test","description":"test"}' \
            "$API_URL$PATH" 2>/dev/null)

        if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "201" ]; then
            log_finding "Viewer role succeeded with $METHOD $PATH"
        else
            log_info "$METHOD $PATH properly blocked for viewer (HTTP $RESPONSE)"
        fi
    done
}

# -----------------------------------------------------------------------------
# Test 6: Vertical Privilege Escalation
# -----------------------------------------------------------------------------
test_vertical_privilege_escalation() {
    log_info "Testing vertical privilege escalation..."

    if [ -z "$TENANT_ADMIN_TOKEN" ]; then
        log_warn "Requires TENANT_ADMIN_TOKEN"
        return
    fi

    # Tenant admin trying platform admin endpoints
    ADMIN_ENDPOINTS=(
        "GET /v1/tenants"
        "POST /v1/tenants"
        "GET /v1/admin/users"
        "GET /v1/admin/settings"
        "POST /v1/admin/settings"
    )

    for endpoint in "${ADMIN_ENDPOINTS[@]}"; do
        METHOD=$(echo "$endpoint" | cut -d' ' -f1)
        PATH=$(echo "$endpoint" | cut -d' ' -f2)

        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X "$METHOD" \
            -H "Authorization: Bearer $TENANT_ADMIN_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{}' \
            "$API_URL$PATH" 2>/dev/null)

        if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "201" ]; then
            log_finding "Tenant admin accessed admin endpoint: $METHOD $PATH"
        else
            log_info "$METHOD $PATH blocked for tenant admin (HTTP $RESPONSE)"
        fi
    done
}

# -----------------------------------------------------------------------------
# Test 7: Parameter Tampering
# -----------------------------------------------------------------------------
test_parameter_tampering() {
    log_info "Testing parameter tampering..."

    if [ -z "$TENANT_B_TOKEN" ]; then
        log_warn "Requires TENANT_B_TOKEN"
        return
    fi

    # Try to create resource with different tenant_id
    PAYLOAD='{"name":"test-api","tenant_id":"tenant-a","owner":"admin"}'

    RESPONSE=$(curl -s -w "\n%{http_code}" \
        -X POST \
        -H "Authorization: Bearer $TENANT_B_TOKEN" \
        -H "Content-Type: application/json" \
        -d "$PAYLOAD" \
        "$API_URL/v1/apis")

    HTTP_CODE=$(echo "$RESPONSE" | tail -1)
    BODY=$(echo "$RESPONSE" | sed '$d')

    CREATED_TENANT=$(echo "$BODY" | jq -r '.tenant_id // empty')

    if [ "$CREATED_TENANT" = "tenant-a" ]; then
        log_finding "tenant_id parameter injection successful - Mass assignment vulnerability"
    else
        log_info "tenant_id parameter properly ignored or validated"
    fi

    # Try to modify owner
    CREATED_OWNER=$(echo "$BODY" | jq -r '.owner // empty')

    if [ "$CREATED_OWNER" = "admin" ]; then
        log_finding "owner parameter injection successful - Mass assignment vulnerability"
    fi
}

# -----------------------------------------------------------------------------
# Test 8: GUID/UUID Prediction
# -----------------------------------------------------------------------------
test_uuid_prediction() {
    log_info "Testing UUID predictability..."

    if [ -z "$TENANT_A_TOKEN" ]; then
        log_warn "Requires TENANT_A_TOKEN"
        return
    fi

    # Create multiple resources and analyze UUID patterns
    UUIDS=()

    for i in $(seq 1 5); do
        RESPONSE=$(curl -s \
            -X POST \
            -H "Authorization: Bearer $TENANT_A_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"name\":\"test-uuid-$i\"}" \
            "$API_URL/v1/apis" 2>/dev/null)

        UUID=$(echo "$RESPONSE" | jq -r '.id // empty')

        if [ -n "$UUID" ]; then
            UUIDS+=("$UUID")
            echo "$UUID" >> "$OUTPUT_DIR/collected-uuids.txt"
        fi

        sleep 0.5
    done

    log_info "Collected ${#UUIDS[@]} UUIDs for analysis"
    log_info "Manual analysis required: check for patterns, sequential components"

    # Basic analysis
    if [ ${#UUIDS[@]} -ge 2 ]; then
        log_info "UUIDs collected:"
        for uuid in "${UUIDS[@]}"; do
            echo "  $uuid"
        done
    fi
}

# -----------------------------------------------------------------------------
# Main Execution
# -----------------------------------------------------------------------------
main() {
    echo "========================================"
    echo "STOA Platform - BOLA/IDOR Testing"
    echo "========================================"
    echo "Target API: $API_URL"
    echo "Output: $OUTPUT_DIR"
    echo "========================================"

    # Get tokens if credentials provided
    if [ -n "$TENANT_A_USER" ] && [ -n "$TENANT_A_PASS" ]; then
        TENANT_A_TOKEN=$(get_token "$TENANT_A_USER" "$TENANT_A_PASS")
        export TENANT_A_TOKEN
        log_info "Tenant A token obtained"
    fi

    if [ -n "$TENANT_B_USER" ] && [ -n "$TENANT_B_PASS" ]; then
        TENANT_B_TOKEN=$(get_token "$TENANT_B_USER" "$TENANT_B_PASS")
        export TENANT_B_TOKEN
        log_info "Tenant B token obtained"
    fi

    if [ -n "$VIEWER_USER" ] && [ -n "$VIEWER_PASS" ]; then
        VIEWER_TOKEN=$(get_token "$VIEWER_USER" "$VIEWER_PASS")
        export VIEWER_TOKEN
        log_info "Viewer token obtained"
    fi

    if [ -n "$TENANT_ADMIN_USER" ] && [ -n "$TENANT_ADMIN_PASS" ]; then
        TENANT_ADMIN_TOKEN=$(get_token "$TENANT_ADMIN_USER" "$TENANT_ADMIN_PASS")
        export TENANT_ADMIN_TOKEN
        log_info "Tenant admin token obtained"
    fi

    # Run tests
    test_cross_tenant_api_access
    test_cross_tenant_application_access
    test_direct_tenant_access
    test_deployment_enumeration
    test_horizontal_privilege_escalation
    test_vertical_privilege_escalation
    test_parameter_tampering
    test_uuid_prediction

    echo ""
    echo "========================================"
    echo "Testing Complete"
    echo "========================================"
    echo "Results saved to: $OUTPUT_DIR"
    echo "Check $OUTPUT_DIR/findings.log for vulnerabilities"
}

if [ "${BASH_SOURCE[0]}" = "$0" ]; then
    main "$@"
fi
