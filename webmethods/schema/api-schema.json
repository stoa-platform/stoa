{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://stoa.io/schemas/webmethods-api.json",
  "title": "WebMethods API Definition",
  "description": "Schema for defining webMethods Gateway APIs in GitOps",
  "type": "object",
  "required": ["apiVersion", "kind", "metadata", "spec"],
  "properties": {
    "apiVersion": {
      "type": "string",
      "enum": ["stoa.io/v1"],
      "description": "API version for this schema"
    },
    "kind": {
      "type": "string",
      "enum": ["WebMethodsAPI", "WebMethodsPolicy", "WebMethodsAliases"],
      "description": "Type of resource"
    },
    "metadata": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "minLength": 1,
          "maxLength": 64,
          "description": "Unique identifier for the API (lowercase, alphanumeric, hyphens)"
        },
        "version": {
          "type": "string",
          "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
          "description": "Semantic version (e.g., 1.0.0)"
        },
        "description": {
          "type": "string",
          "maxLength": 500,
          "description": "Human-readable description"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z0-9-]+$"
          },
          "description": "Tags for categorization"
        },
        "environment": {
          "type": "string",
          "enum": ["dev", "int", "prod"],
          "description": "Target environment (for aliases)"
        }
      }
    },
    "spec": {
      "type": "object",
      "description": "Specification of the API"
    }
  },
  "allOf": [
    {
      "if": {
        "properties": { "kind": { "const": "WebMethodsAPI" } }
      },
      "then": {
        "properties": {
          "spec": {
            "$ref": "#/definitions/apiSpec"
          }
        }
      }
    },
    {
      "if": {
        "properties": { "kind": { "const": "WebMethodsPolicy" } }
      },
      "then": {
        "properties": {
          "spec": {
            "$ref": "#/definitions/policySpec"
          }
        }
      }
    },
    {
      "if": {
        "properties": { "kind": { "const": "WebMethodsAliases" } }
      },
      "then": {
        "properties": {
          "aliases": {
            "$ref": "#/definitions/aliasesSpec"
          }
        }
      }
    }
  ],
  "definitions": {
    "apiSpec": {
      "type": "object",
      "required": ["type", "basePath", "backend"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["REST", "SOAP", "GraphQL"],
          "description": "API type"
        },
        "basePath": {
          "type": "string",
          "pattern": "^/",
          "description": "Base path for the API (must start with /)"
        },
        "backend": {
          "type": "object",
          "required": ["alias"],
          "properties": {
            "alias": {
              "type": "string",
              "description": "Reference to backend alias"
            },
            "pathPrefix": {
              "type": "string",
              "description": "Optional path prefix for backend"
            }
          }
        },
        "policies": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of policy names to apply (in order)"
        },
        "auth": {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["none", "api-key", "oauth2", "jwt", "basic", "mtls"],
              "description": "Authentication type"
            },
            "scopes": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Required OAuth2 scopes"
            },
            "required": {
              "type": "boolean",
              "default": true,
              "description": "Whether auth is required"
            }
          }
        },
        "applications": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Allowed application names (empty = all)"
        },
        "resources": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["path", "methods"],
            "properties": {
              "path": {
                "type": "string",
                "description": "Resource path"
              },
              "methods": {
                "type": "array",
                "items": {
                  "type": "string",
                  "enum": ["GET", "POST", "PUT", "PATCH", "DELETE", "HEAD", "OPTIONS"]
                },
                "description": "Allowed HTTP methods"
              },
              "description": {
                "type": "string",
                "description": "Resource description"
              }
            }
          }
        },
        "cors": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false
            },
            "allowOrigins": {
              "type": "array",
              "items": { "type": "string" }
            },
            "allowMethods": {
              "type": "array",
              "items": { "type": "string" }
            },
            "allowHeaders": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        }
      }
    },
    "policySpec": {
      "type": "object",
      "required": ["type", "config"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "rate-limit",
            "jwt-validation",
            "api-key",
            "ip-filter",
            "request-transform",
            "response-transform",
            "caching",
            "logging",
            "circuit-breaker"
          ],
          "description": "Policy type"
        },
        "config": {
          "type": "object",
          "description": "Policy-specific configuration"
        }
      }
    },
    "aliasesSpec": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "required": ["url"],
        "properties": {
          "url": {
            "type": "string",
            "format": "uri",
            "description": "Backend URL"
          },
          "timeout": {
            "type": "string",
            "pattern": "^[0-9]+(ms|s|m)$",
            "default": "30s",
            "description": "Request timeout"
          },
          "retries": {
            "type": "integer",
            "minimum": 0,
            "maximum": 10,
            "default": 3,
            "description": "Number of retries"
          },
          "healthCheck": {
            "type": "object",
            "properties": {
              "path": { "type": "string" },
              "interval": { "type": "string" }
            }
          }
        }
      }
    }
  }
}
